@page "/survey-dashboard"
@attribute [Authorize(Policy = "NotGuest")]
@using WebAPI.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using System.Text.Json
@inject HttpClient httpClient
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<div class="dashboard-container">
    <div class="dashboard-top-bar">
        <div class="dashboard-footer">
            <span>
                Last updated: @(GetLastUpdatedDate()?.ToString("MM/dd/yyyy HH:mm", System.Globalization.CultureInfo.InvariantCulture) ?? "No data")
            </span>
        </div>
    </div>

    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="page-title">Survey Analytics</h1>
            <p class="page-subtitle">Client Satisfaction & Survey Insights</p>
        </div>
    </div>
    
    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading survey data...</p>
        </div>
    }
    else if (surveyResponses.Count == 0)
    {
        <div class="no-data">
            <p>No survey responses available yet.</p>
        </div>
    }
    else
    {
        <!-- Main Dashboard Overview -->
        <div class="summary-cards">
            <div class="card clickable" @onclick='() => ScrollToSection("responses")'>
                <div class="card-icon"><img src="/images/checklist.png" alt="Total Responses" /></div>
                <h3 class="counter" data-target="@surveyResponses.Count">@surveyResponses.Count</h3>
                <p>Total Responses</p>
                <div class="card-arrow">‚Üí</div>
            </div>
            <div class="card clickable" @onclick='() => ScrollToSection("satisfaction")'>
                <div class="card-icon"><img src="/images/satisfaction.png" alt="Average Satisfaction" /></div>
                <h3 class="counter satisfaction-score" data-target="@Math.Round(avgSatisfaction, 1)">@Math.Round(avgSatisfaction, 1)</h3>
                <p>Avg Overall Satisfaction Score</p>
                <div class="pro-sat-progress" style="margin-top: 12px;">
                    <div class="pro-sat-track">
                        <div class="pro-sat-goal-marker" title="Goal: 9.0"></div>
                        <div class="pro-sat-fill @(avgSatisfaction >= 8 ? "excellent" : avgSatisfaction >= 6 ? "good" : avgSatisfaction >= 4 ? "average" : "poor")" style="width: @((avgSatisfaction / 10.0 * 100.0).ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%;"></div>
                    </div>
                    <div class="pro-sat-scale">
                        @for (int i = 0; i <= 10; i += 2)
                        {
                            <span class="scale-tick">@i</span>
                        }
                    </div>
                </div>
            </div>
            <div class="card clickable" @onclick='() => ScrollToSection("clients")'>
                <div class="card-icon"><img src="/images/public-relation.png" alt="Unique Clients" /></div>
                <h3 class="counter" data-target="@GetTotalUniqueClients()">@GetTotalUniqueClients()</h3>
                <p>Unique Clients</p>
                <div class="card-arrow">‚Üí</div>
            </div>
        </div>

        <!-- Sector Overview Charts -->
        <div class="charts-section">
            
            <div class="chart-container" id="responses">
                <div class="chart-header">
                    <h4><img class="section-icon" src="/images/margin.png" alt="Survey Responses by Sector" /> Survey Responses by Sector</h4>
                    <div class="chart-controls">
                        <button class="view-btn @(chartView == "count" ? "active" : "")" @onclick='() => SetChartView("count")'>Count</button>
                        <button class="view-btn @(chartView == "percentage" ? "active" : "")" @onclick='() => SetChartView("percentage")'>%</button>
                        <button class="view-btn @(chartView == "completion" ? "active" : "")" @onclick='() => SetChartView("completion")'>Completion Rate</button>
                    </div>
                </div>
                <div class="interactive-bar-chart">
                    @{
                        var totalResponses = sectorCounts.Sum(x => x.Value);
                    }
                    @foreach (var sector in sectorCounts.OrderByDescending(x => x.Value))
                    {
                        var totalCount = sector.Value;
                        var completedCount = GetCompletedCountForSector(sector.Key);
                        var completionRate = totalCount > 0 ? (double)completedCount / totalCount * 100 : 0;
                        
                        var displayValue = chartView switch
                        {
                            "percentage" => $"{((double)sector.Value / surveyResponses.Count * 100):F1}%",
                            "completion" => $"{completionRate.ToString("F0")}% ({completedCount}/{totalCount})",
                            _ => sector.Value.ToString()
                        };
                        
                        var barWidth = chartView switch
                        {
                            "percentage" => (double)sector.Value / surveyResponses.Count * 100,
                            "completion" => completionRate,
                            _ => totalCount > 0 && totalResponses > 0 ? ((double)totalCount / totalResponses * 100) : 0
                        };
                        
                        Console.WriteLine($"Sector: {sector.Key}, Count: {totalCount}, TotalResponses: {totalResponses}, View: {chartView}, BarWidth: {barWidth:F2}%");
                        
                        <div class="interactive-bar-item @(hoveredSector == sector.Key ? "hovered" : "")" 
                             @onclick="() => ToggleSectorDetails(sector.Key)"
                             @onmouseover="() => hoveredSector = sector.Key"
                             @onmouseleave="() => hoveredSector = null">
                            <div class="bar-header">
                                <div class="bar-label">
                                    <span class="sector-icon">@GetSectorIcon(sector.Key)</span>
                                    @sector.Key
                                </div>
                                <div class="bar-value-display">@displayValue</div>
                            </div>
                            <div class="bar-wrapper">
                                @if (chartView == "completion")
                                {
                                    <div class="completion-progress-bg">
                                        <div class="completion-progress-fill" style="width: @(completionRate.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                                    </div>
                                }
                                else
                                {
                                    <div class="interactive-bar" 
                                         style="width: @(barWidth.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%; background: linear-gradient(135deg, @GetSectorColor(sector.Key), @GetSectorColorDark(sector.Key)); animation-delay: @(Array.IndexOf(sectorCounts.Keys.ToArray(), sector.Key) * 0.1)s">
                                        <div class="bar-shine"></div>
                                    </div>
                                }
                            </div>
                            @if (expandedSectors.Contains(sector.Key))
                            {
                                <div class="sector-dropdown">
                                    <div class="dropdown-stats">
                                        <div class="mini-stat">
                                            <span class="mini-stat-value">@Math.Round(GetSectorAverage(sector.Key, "satisfaction"), 1)</span>
                                            <span class="mini-stat-label">Avg Satisfaction</span>
                                        </div>
                                        <div class="mini-stat">
                                            <span class="mini-stat-value">@completedCount</span>
                                            <span class="mini-stat-label">Completed</span>
                                        </div>
                                        <div class="mini-stat">
                                            <span class="mini-stat-value">@(totalCount - completedCount)</span>
                                            <span class="mini-stat-label">Pending</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Average Satisfaction by Sector -->
            <div class="chart-container" id="satisfaction">
                <div class="chart-header">
                    <h4><img class="section-icon" src="/images/rating.png" alt="Satisfaction Score" /> Satisfaction Score</h4>
                    <div class="filter-controls">
                        <div class="filter-section">
                            <label class="filter-label">Filter by Sector</label>
                            <select @bind="selectedSectorFilter" class="filter-dropdown">
                                <option value="all">All Sectors</option>
                                @foreach (var sector in GetUniqueSectors())
                                {
                                    <option value="@sector">@sector</option>
                                }
                            </select>
                        </div>
                        
                        <div class="filter-section">
                            <label class="filter-label">Filter by Company Size</label>
                            <select @bind="selectedCompanySizeFilter" class="filter-dropdown">
                                <option value="all">All Company Sizes</option>
                                @foreach (var companySize in GetUniqueCompanySizes())
                                {
                                    <option value="@companySize">@companySize</option>
                                }
                            </select>
                        </div>
                        
                        @if (selectedSectorFilter != "all" || selectedCompanySizeFilter != "all")
                        {
                            <div class="filter-section">
                                <button class="clear-filters-btn" @onclick="ClearAllFilters">
                                    <img class="inline-icon" src="/images/trash.png" alt="Clear Filters" /> Clear Filters
                                </button>
                            </div>
                        }
                        
                        @if (selectedSectorFilter != "all" || selectedCompanySizeFilter != "all")
                        {
                            <div class="active-filters">
                                <span class="filter-indicator">Active Filters:</span>
                                @if (selectedSectorFilter != "all")
                                {
                                    <span class="filter-badge sector">@selectedSectorFilter</span>
                                }
                                @if (selectedCompanySizeFilter != "all")
                                {
                                    <span class="filter-badge company-size">@selectedCompanySizeFilter</span>
                                }
                            </div>
                        }
                    </div>
                </div>
                <div class="satisfaction-grid">
                    @{
                        var filteredSatisfactionData = GetCombinedFilteredSatisfactionData();
                    }
                    
                    @foreach (var item in filteredSatisfactionData.OrderByDescending(x => x.Value))
                    {
                        var percentage = item.Value / 10 * 100;
                        var satisfaction = item.Value;
                        var satisfactionClass = satisfaction >= 8 ? "excellent" : satisfaction >= 6 ? "good" : satisfaction >= 4 ? "average" : "poor";
                        Console.WriteLine($"Satisfaction item: {item.Key}, value={item.Value}, percentage={percentage:F2}");
                        
                        <div class="professional-satisfaction-card @satisfactionClass" @onclick="() => SelectItem(item.Key)">
                            <div class="pro-sat-header">
                                <div class="pro-sat-title">
                                    <span class="pro-sat-icon">@GetItemIcon(item.Key)</span>
                                    <h5>@item.Key</h5>
                                </div>
                                <div class="pro-sat-score-badge @satisfactionClass">
                                    @Math.Round(item.Value, 1)
                                </div>
                            </div>
                            <div class="pro-sat-progress">
                                <div class="pro-sat-track">
                                    <div class="pro-sat-goal-marker" title="Goal: 9.0"></div>
                                    <div class="pro-sat-fill @satisfactionClass" style="width: @(percentage.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;"></div>
                                </div>
                                <div class="pro-sat-scale">
                                    @for (int i = 0; i <= 10; i += 2)
                                    {
                                        <span class="scale-tick">@i</span>
                                    }
                                </div>
                            </div>
                            <div class="pro-sat-footer">
                                <span class="pro-sat-category @satisfactionClass">@GetSatisfactionEmoji(satisfaction) @GetQuestionCategory(satisfaction)</span>
                                <span class="pro-sat-responses">@GetFilteredResponseCount(item.Key) responses</span>
                            </div>
                        </div>
                    }
                    
                    @if (!filteredSatisfactionData.Any())
                    {
                        <div class="no-data-message">
                            <div class="no-data-icon"><img class="no-data-img" src="/images/graph.png" alt="No data" /></div>
                            <h4>No Data Available</h4>
                            <p>No survey responses found for the selected filters.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Satisfaction Score ‚Äì Monthly Line Chart (Clean, Professional) -->
            <div class="chart-container" id="trends">
                <div class="chart-header">
                    <h4>
                        <img class="section-icon" src="/images/trend.png" alt="Satisfaction Trends" />
                        @if (trendTimeView == "monthly")
                        {
                            <text>Monthly Overall Satisfaction Score ‚Äì @trendSelectedYear</text>
                        }
                        else if (trendTimeView == "quarterly")
                        {
                            <text>Quarterly Overall Satisfaction Score ‚Äì @trendSelectedYear</text>
                        }
                        else
                        {
                            <text>Yearly Overall Satisfaction Score</text>
                        }
                    </h4>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        @if (trendTimeView == "monthly" || trendTimeView == "quarterly")
                        {
                            <div class="filter-section">
                                <select class="filter-dropdown" @bind="trendSelectedYear">
                                    @foreach (var year in GetAvailableYears())
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                            </div>
                        }
                        <div class="filter-section">
                            <select class="filter-dropdown" @bind="trendTimeView">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                    </div>
                </div>

                @{
                    var chartYear = trendSelectedYear;
                    List<TrendDataPoint> periodData = new List<TrendDataPoint>();
                    int periodsCount = 12;
                    
                    if (trendTimeView == "monthly")
                    {
                        periodsCount = 12;
                        var monthlyResponses = surveyResponses
                            .Where(r => r.DateCompleted.HasValue && r.DateCompleted.Value.Year == chartYear)
                            .ToList();
                        
                        var monthlyGroups = monthlyResponses
                            .GroupBy(r => r.DateCompleted!.Value.Month)
                            .ToDictionary(g => g.Key, g => g.ToList());
                        
                        for (int m = 1; m <= 12; m++)
                        {
                            if (monthlyGroups.ContainsKey(m))
                            {
                                var monthResponses = monthlyGroups[m];
                                var avgScore = monthResponses.Average(r => (r.Question1 + r.Question2 + r.Question3 + r.Question4 + r.Question5 + r.Question6 + r.Question7 + r.Question8 + r.Question9) / 9.0);
                                periodData.Add(new TrendDataPoint
                                {
                                    Score = avgScore,
                                    Period = $"{GetMonthName(m)} {chartYear}",
                                    ShortPeriod = new DateTime(chartYear, m, 1).ToString("MMM", System.Globalization.CultureInfo.InvariantCulture),
                                    Date = new DateTime(chartYear, m, 1),
                                    ResponseCount = monthResponses.Count
                                });
                            }
                            else
                            {
                                periodData.Add(new TrendDataPoint
                                {
                                    Score = 0,
                                    Period = $"{GetMonthName(m)} {chartYear}",
                                    ShortPeriod = new DateTime(chartYear, m, 1).ToString("MMM", System.Globalization.CultureInfo.InvariantCulture),
                                    Date = new DateTime(chartYear, m, 1),
                                    ResponseCount = 0
                                });
                            }
                        }
                    }
                    else if (trendTimeView == "quarterly")
                    {
                        periodsCount = 4;
                        var quarterlyResponses = surveyResponses
                            .Where(r => r.DateCompleted.HasValue && r.DateCompleted.Value.Year == chartYear)
                            .ToList();
                        
                        for (int q = 1; q <= 4; q++)
                        {
                            var quarterMonths = new[] { (q-1)*3+1, (q-1)*3+2, (q-1)*3+3 };
                            var quarterData = quarterlyResponses
                                .Where(r => quarterMonths.Contains(r.DateCompleted!.Value.Month))
                                .ToList();
                            
                            var avgScore = quarterData.Any() 
                                ? quarterData.Average(r => (r.Question1 + r.Question2 + r.Question3 + r.Question4 + r.Question5 + r.Question6 + r.Question7 + r.Question8 + r.Question9) / 9.0) 
                                : 0;
                            
                            periodData.Add(new TrendDataPoint
                            {
                                Score = avgScore,
                                Period = $"Q{q} {chartYear}",
                                ShortPeriod = $"Q{q}",
                                Date = new DateTime(chartYear, quarterMonths[0], 1),
                                ResponseCount = quarterData.Count
                            });
                        }
                    }
                    else // yearly
                    {
                        periodsCount = 5;
                        var allResponses = surveyResponses.Where(r => r.DateCompleted.HasValue).ToList();
                        for (int y = 0; y < 5; y++)
                        {
                            var year = DateTime.Now.Year - (4 - y);
                            var yearResponses = allResponses.Where(r => r.DateCompleted.Value.Year == year).ToList();
                            var avgScore = yearResponses.Any() ? yearResponses.Average(r => (r.Question1 + r.Question2 + r.Question3 + r.Question4 + r.Question5 + r.Question6 + r.Question7 + r.Question8 + r.Question9) / 9.0) : 0;
                            
                            periodData.Add(new TrendDataPoint
                            {
                                Score = avgScore,
                                Period = year.ToString(),
                                ShortPeriod = year.ToString(),
                                Date = new DateTime(year, 1, 1),
                                ResponseCount = yearResponses.Count
                            });
                        }
                    }
                }

                @if (periodData.Any())
                {
                    var dataWithScores = periodData.Where(p => p.Score > 0).ToList();
                    var latestData = dataWithScores.LastOrDefault();
                    var previousData = dataWithScores.Count > 1 ? dataWithScores[dataWithScores.Count - 2] : null;
                    var trendPercent = 0.0;
                    var trendDirection = "";
                    
                    if (latestData != null && previousData != null && previousData.Score > 0)
                    {
                        trendPercent = ((latestData.Score - previousData.Score) / previousData.Score) * 100;
                        trendDirection = trendPercent >= 0 ? "up" : "down";
                    }
                    
                    var highestScore = dataWithScores.Any() ? dataWithScores.Max(p => p.Score) : 0;
                    var lowestScore = dataWithScores.Any() ? dataWithScores.Min(p => p.Score) : 0;

                    <!-- Info boxes -->
                    <div class="trend-info-boxes">
                        <div class="trend-info-box">
                            <div class="trend-info-icon trend-icon">
                                @if (trendDirection == "up")
                                {
                                    <span style="color: #28a745;">‚ñ≤</span>
                                }
                                else if (trendDirection == "down")
                                {
                                    <span style="color: #dc3545;">‚ñº</span>
                                }
                                else
                                {
                                    <span style="color: #6c757d;">‚îÅ</span>
                                }
                            </div>
                            <div class="trend-info-content">
                                <div class="trend-info-label">Trend</div>
                                <div class="trend-info-value @(trendDirection == "up" ? "positive" : trendDirection == "down" ? "negative" : "neutral")">
                                    @if (trendPercent != 0)
                                    {
                                        <text>@(trendPercent > 0 ? "+" : "")@trendPercent.ToString("F1")%</text>
                                    }
                                    else
                                    {
                                        <text>No change</text>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="trend-info-box">
                            <div class="trend-info-icon highest-icon">
                                <img src="/images/best-seller.png" alt="Highest Score" style="width: 28px; height: 28px;" />
                            </div>
                            <div class="trend-info-content">
                                <div class="trend-info-label">Highest Score</div>
                                <div class="trend-info-value">@highestScore.ToString("F1")</div>
                            </div>
                        </div>

                        <div class="trend-info-box">
                            <div class="trend-info-icon lowest-icon">
                                <img src="/images/negative-vote.png" alt="Lowest Score" style="width: 28px; height: 28px;" />
                            </div>
                            <div class="trend-info-content">
                                <div class="trend-info-label">Lowest Score</div>
                                <div class="trend-info-value">@lowestScore.ToString("F1")</div>
                            </div>
                        </div>
                    </div>

                    <div class="pro-chart">
                        <!-- Left Y-axis labels -->
                        <div class="pro-y-axis">
                            @for (int i = 10; i >= 0; i -= 2)
                            {
                                <div class="pro-y-tick" style="bottom: @(i * 10)%">@i</div>
                            }
                        </div>

                        <!-- Chart area grid and bars -->
                        <div class="pro-chart-area">
                            @for (int i = 0; i <= 10; i += 2)
                            {
                                <div class="pro-grid" style="bottom: @(i * 10)%"></div>
                            }
                            <div class="pro-x-baseline"></div>

                            <div class="pro-bars">
                                @for (int i = 0; i < periodData.Count; i++)
                                {
                                    var dp = periodData[i];
                                    var leftPct = (i * 100.0 / periodsCount) + (100.0 / (periodsCount * 2));
                                    var heightPct = dp.Score * 10.0;
                                    var hasData = dp.Score > 0;
                                    <div class="pro-bar-slot" style="left:@(leftPct.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                        @if (hasData)
                                        {
                                            <div class="pro-bar" style="height:@(heightPct.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                                <span class="pro-bar-value">@dp.Score.ToString("F1")</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="no-data-text">No data</div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Bottom X-axis labels -->
                        <div class="pro-x-axis">
                            @for (int i = 0; i < periodData.Count; i++)
                            {
                                var dp = periodData[i];
                                var leftPct = (i * 100.0 / periodsCount) + (100.0 / (periodsCount * 2));
                                <div class="pro-x-label" style="left:@(leftPct.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%">
                                    @dp.ShortPeriod
                                </div>
                            }
                        </div>
                    </div>
                }
                else
                {
                    <div class="no-trend-data">
                        <p><img class="inline-icon" src="/images/graph.png" alt="No data" /> No monthly trend data available for @DateTime.Now.Year.</p>
                    </div>
                }
            </div>

            

            <!-- AI Predictions Section -->
            <div class="chart-container">
                <div class="trend-chart-container">
                    <div class="visual-trend-chart">
                        <div class="trend-chart-header">
                            <span class="chart-title"><img class="section-icon" src="/images/predictive-analysis.png" alt="AI Satisfaction Predictions" /> AI Satisfaction Predictions</span>
                            <span class="chart-range">Next 6 Months Forecast</span>
                        </div>
                        
                        @if (isLoadingForecast)
                        {
                            <div class="loading-forecast">
                                <span class="loading-text">ü§ñ AI is generating forecasts...</span>
                            </div>
                        }
                        else if (forecastData != null && forecastData.Any())
                        {
                            <!-- Forecast Line Chart -->
                            <div class="line-chart-container">
                                <div class="chart-grid">
                                    <!-- Y-axis scale -->
                                    <div class="y-axis">
                                        @for (int i = 10; i >= 0; i -= 2)
                                        {
                                            <div class="y-label" style="bottom: @(i * 10)%;">@i</div>
                                        }
                                    </div>
                                    
                                    <!-- Chart area -->
                                    <div class="chart-area">
                                        <!-- Grid lines -->
                                        <div class="grid-lines">
                                            @for (int i = 0; i <= 10; i += 2)
                                            {
                                                <div class="grid-line-horizontal" style="bottom: @(i * 10)%;"></div>
                                            }
                                        </div>
                                        
                                        <!-- Forecast content with SVG -->
                                        <div class="line-chart-content">
                                            <svg class="forecast-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                                                <!-- Confidence interval area -->
                                                <polygon class="confidence-area" 
                                                         points="@GetConfidenceAreaPoints(forecastData)" 
                                                         fill="rgba(103, 58, 183, 0.1)" />
                                                
                                                <!-- Forecast line -->
                                                <path class="forecast-path" 
                                                      d="@GetForecastLinePath(forecastData)" 
                                                      fill="none" 
                                                      stroke="#673ab7" 
                                                      stroke-width="1" 
                                                      stroke-linejoin="round"
                                                      stroke-linecap="round" 
                                                      vector-effect="non-scaling-stroke" />
                                            </svg>
                                            
                                            <!-- Forecast points with hover tooltips -->
                                            @foreach (var (point, index) in forecastData.Select((p, i) => (p, i)))
                                            {
                                                var leftPosition = forecastData.Count > 1 ? (index * 100.0 / (forecastData.Count - 1)) : 50;
                                                var bottomPosition = point.PredictedScore * 10;
                                                
                                                <div class="forecast-point" 
                                                     style="left: @(leftPosition.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%; bottom: @(bottomPosition.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%;"
                                                     @onmouseover="() => hoveredForecastPoint = index"
                                                     @onmouseout="() => hoveredForecastPoint = -1">
                                                    <div class="point-dot forecast-dot"></div>
                                                    <div class="point-tooltip forecast-tooltip @(hoveredForecastPoint == index ? "visible" : "")">
                                                        <strong>@point.Period</strong>
                                                        <div class="tooltip-score">Score: @point.PredictedScore.ToString("F1")/10</div>
                                                        <div class="tooltip-confidence">¬±@point.ConfidenceInterval.ToString("F1")</div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        
                                        <!-- X-axis labels -->
                                        <div class="x-axis">
                                            @foreach (var (point, index) in forecastData.Select((p, i) => (p, i)))
                                            {
                                                var leftPosition = forecastData.Count > 1 ? (index * 100.0 / (forecastData.Count - 1)) : 50;
                                                <div class="x-label" style="left: @(leftPosition.ToString("F1", System.Globalization.CultureInfo.InvariantCulture))%;">
                                                    @point.Date.ToString("MMM", System.Globalization.CultureInfo.InvariantCulture)
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- AI Insights -->
                            <div class="forecast-insights">
                                <div class="insight-item">
                                    <strong>AI Analysis:</strong>
                                    @if (isLoadingDatabaseAnalysis)
                                    {
                                        <span class="loading-text">ü§ñ AI is analyzing entire database...</span>
                                    }
                                    else
                                    {
                                        <div class="database-analysis-content">
                                            @if (!string.IsNullOrEmpty(databaseAnalysis))
                                            {
                                                @foreach (var paragraph in databaseAnalysis.Split('\n', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <p>@paragraph</p>
                                                }
                                            }
                                            else
                                            {
                                                <span>Loading comprehensive AI analysis...</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="no-forecast-data">
                                <p><img class="inline-icon" src="/images/predictive-analysis.png" alt="AI forecast" /> AI forecast will be generated once sufficient historical data is available!</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Question Performance Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h4><img class="section-icon" src="/images/customer-survey.png" alt=" OverallQuestion Performance" />  Overall Question Performance</h4>
                </div>
                <div class="professional-question-performance">
                    @for (int q = 1; q <= 9; q++)
                    {
                        var avg = GetQuestionAverage(q);
                        var percentage = (avg / 10.0) * 100.0;
                        var questionClass = avg >= 8 ? "excellent" : avg >= 6 ? "good" : avg >= 4 ? "average" : "poor";
                        var barColor = avg >= 8 ? "#28a745" : avg >= 6 ? "#17a2b8" : avg >= 4 ? "#ffc107" : "#dc3545";
                        var isSelected = selectedQuestion == q;

                        <div class="pro-question-item @(isSelected ? "selected" : "")" @onclick="() => ToggleQuestion(q)">
                            <div class="pro-question-header">
                                <div class="pro-question-number">Q@(q)</div>
                                <div class="pro-question-score" style="color: @barColor;">@avg.ToString("F1")</div>
                            </div>
                            <div class="pro-question-title">@GetQuestionText(q)</div>
                            <div class="pro-progress-container">
                                <div class="pro-progress-bar" style="width: @percentage.ToString("F1", System.Globalization.CultureInfo.InvariantCulture)%; background: @barColor;"></div>
                            </div>
                            <div class="pro-question-meta">
                                <span class="pro-question-category @questionClass">@GetQuestionCategory(avg)</span>
                                <span class="pro-question-percentage">@percentage.ToString("F0")%</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Client Insights Section -->
            <div class="chart-container" id="clients">
                <div class="chart-header">
                    <h4><img class="section-icon" src="/images/analysis.png" alt="Client Insights" /> Client Insights</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <select @bind="selectedClientYear" class="filter-dropdown" style="padding: 6px 10px; border: 1px solid #dee2e6; border-radius: 6px; background: white; font-size: 0.9em;">
                            <option value="all">All Years</option>
                            @foreach (var year in GetAvailableYears().OrderByDescending(y => y))
                            {
                                <option value="@year">@year</option>
                            }
                        </select>
                    </div>
                </div>
                
                @if (GetClientAnalytics().Any())
                {
                    <div class="clients-overview">
                        <!-- Client Summary Cards -->
                        <div class="client-summary-cards">
                            @{
                                var totalClients = GetTotalUniqueClients();
                                var newClients = GetNewClientsForPeriod();
                                var repeatedClients = GetRepeatedClientsForPeriod();
                                
                                // Calculate retention rate based on the selected period
                                double retentionRate = 0;
                                if (selectedClientYear == "all")
                                {
                                    // For all years: (repeated clients / total clients) * 100
                                    retentionRate = totalClients > 0 ? (double)repeatedClients / totalClients * 100 : 0;
                                }
                                else
                                {
                                    // For specific year: (repeated clients / (new + repeated clients in that year)) * 100
                                    var clientsInYear = newClients + repeatedClients;
                                    retentionRate = clientsInYear > 0 ? (double)repeatedClients / clientsInYear * 100 : 0;
                                }
                                
                                var periodLabel = "All time";
                                if (selectedClientYear != "all" && int.TryParse(selectedClientYear, out int year))
                                {
                                    periodLabel = year.ToString();
                                }
                            }
                            
                            <div class="client-card total-clients">
                                <div class="card-icon"><img class="card-icon-img" src="/images/customers.png" alt="Client Details" /></div>
                                <div class="client-value">@totalClients</div>
                                <div class="client-label">Total Unique Clients</div>
                                <div class="client-sublabel">All time</div>
                            </div>
                            
                            <div class="client-card new-clients">
                                <div class="card-icon"><img class="card-icon-img" src="/images/new.png" alt="New Clients" /></div>
                                <div class="client-value">@newClients</div>
                                <div class="client-label">New Clients</div>
                                <div class="client-sublabel">@periodLabel</div>
                            </div>
                            
                            <div class="client-card repeated-clients">
                                <div class="card-icon"><img class="card-icon-img" src="/images/repeat.png" alt="Repeated Clients" /></div>
                                <div class="client-value">@repeatedClients</div>
                                <div class="client-label">Repeated Clients</div>
                                <div class="client-sublabel">@periodLabel</div>
                            </div>
                            
                            <div class="client-card retention-rate">
                                <div class="card-icon"><img class="card-icon-img" src="/images/graph.png" alt="Client Trends" /></div>
                                <div class="client-value">@(retentionRate.ToString("F1"))%</div>
                                <div class="client-label">Client Retention Rate</div>
                                <div class="client-sublabel">@periodLabel basis</div>
                            </div>
                        </div>

                        <!-- Client Details Table -->
                        <div class="client-details-section">
                            <h5><img class="inline-icon" src="/images/file.png" alt="Client Details" /> Client Details</h5>
                            <div class="client-filters">
                                <select @bind="selectedClientFilter" class="filter-dropdown">
                                    <option value="all">All Clients</option>
                                    <option value="new">New Clients Only</option>
                                    <option value="repeated">Repeated Clients Only</option>
                                </select>
                            </div>
                            
                            <div class="client-table-container">
                                <table class="client-table">
                                    <thead>
                                        <tr>
                                            <th>Client</th>
                                            <th>Type</th>
                                            <th>First Survey</th>
                                            <th>Latest Survey</th>
                                            <th>Total Surveys</th>
                                            <th>Avg Satisfaction</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var client in GetFilteredClientDetails())
                                        {
                                            <tr class="client-row">
                                                <td class="client-name">
                                                    <span class="client-icon"><img class="inline-icon" src="/images/customer-segment.png" alt="Client" /></span>
                                                    @client.ClientName
                                                </td>
                                                <td>
                                                    <span class="client-type-badge @(client.IsRepeatedClient ? "repeated" : "new")">
                                                        @if (client.IsRepeatedClient)
                                                        {
                                                            <img class="chip-icon-img" src="/images/repeat.png" alt="Repeated" />
                                                        }
                                                        else
                                                        {
                                                            <img class="chip-icon-img" src="/images/new.png" alt="New" />
                                                        }
                                                    </span>
                                                </td>
                                                <td>@client.FirstSurveyDate?.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture)</td>
                                                <td>@client.LatestSurveyDate?.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture)</td>
                                                <td class="survey-count">@client.TotalSurveys</td>
                                                <td>
                                                    <span class="satisfaction-badge @GetClientSatisfactionClass(client.AverageSatisfaction)">
                                                        @client.AverageSatisfaction.ToString("F1")
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="no-client-data">
                        <p><img class="inline-icon" src="/images/graph.png" alt="No client data" /> No client data available yet. Complete more surveys to see client analytics!</p>
                    </div>
                }
            </div>

            <!-- AI Chat -->
            <div class="chart-container ai-chat-section" id="ai-chat">
                
                <style>
                    .ai-chat-section {
                        background: #ffffff;
                        border: 2px solid #e5e7eb;
                        border-radius: 20px;
                        position: relative;
                        overflow: hidden;
                        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
                    }

                    .ai-chat-section::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        height: 3px;
                        background: linear-gradient(90deg, #8b5cf6 0%, #6366f1 50%, #3b82f6 100%);
                    }

                    .chat-header-modern {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 24px 28px;
                        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                        color: white;
                        margin: -24px -24px 24px -24px;
                        border-radius: 18px 18px 0 0;
                        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
                    }

                    .chat-title-area {
                        display: flex;
                        align-items: center;
                        gap: 16px;
                    }

                    .ai-avatar {
                        position: relative;
                    }

                    .avatar-circle {
                        width: 52px;
                        height: 52px;
                        background: rgba(255, 255, 255, 0.25);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        backdrop-filter: blur(12px);
                        border: 2.5px solid rgba(255, 255, 255, 0.4);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    }

                    .ai-icon {
                        font-size: 26px; /* legacy text fallback */
                    }
                    .ai-icon-img {
                        width: 26px;
                        height: 26px;
                        object-fit: contain;
                        display: inline-block;
                    }

                    .status-indicator {
                        position: absolute;
                        bottom: 2px;
                        right: 2px;
                        width: 14px;
                        height: 14px;
                        border-radius: 50%;
                        border: 2.5px solid white;
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    }

                    .status-indicator.online {
                        background: #22c55e;
                        animation: pulse 2s infinite;
                    }

                    @@keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.5; }
                    }

                    .chat-title-text h4 {
                        margin: 0;
                        font-size: 1.3rem;
                        font-weight: 700;
                        letter-spacing: -0.02em;
                    }

                    .status-text {
                        margin: 0;
                        font-size: 0.875rem;
                        opacity: 0.95;
                        font-weight: 500;
                    }

                    .chat-actions {
                        display: flex;
                        gap: 10px;
                    }

                    .clear-chat-btn {
                        background: rgba(255, 255, 255, 0.25);
                        color: white;
                        border: 1.5px solid rgba(255, 255, 255, 0.3);
                        border-radius: 10px;
                        padding: 10px 16px;
                        cursor: pointer;
                        transition: all 0.25s ease;
                        backdrop-filter: blur(12px);
                        font-weight: 600;
                        font-size: 0.9rem;
                    }

                    .clear-chat-btn:hover {
                        background: rgba(255, 255, 255, 0.35);
                        border-color: rgba(255, 255, 255, 0.5);
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    }

                    .enhanced-chat-container {
                        min-height: 500px;
                        display: flex;
                        flex-direction: column;
                    }

                    .welcome-section {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        padding: 48px 24px;
                        text-align: center;
                        flex: 1;
                        justify-content: center;
                        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
                    }

                    .welcome-avatar {
                        margin-bottom: 24px;
                    }

                    .welcome-circle {
                        width: 90px;
                        height: 90px;
                        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto;
                        box-shadow: 0 12px 40px rgba(139, 92, 246, 0.35);
                        border: 3px solid rgba(255, 255, 255, 0.9);
                    }

                    .welcome-ai-icon {
                        font-size: 44px; /* legacy text fallback */
                        color: white;
                    }
                    .welcome-ai-icon-img {
                        width: 44px;
                        height: 44px;
                        object-fit: contain;
                        display: inline-block;
                    }

                    .welcome-content h5 {
                        margin: 0 0 12px 0;
                        color: #1e293b;
                        font-size: 1.75rem;
                        font-weight: 700;
                        letter-spacing: -0.02em;
                    }

                    .welcome-content p {
                        margin: 0 0 36px 0;
                        color: #64748b;
                        font-size: 1.05rem;
                        line-height: 1.6;
                        max-width: 520px;
                        font-weight: 500;
                    }

                    .suggestion-chips {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 12px;
                        width: 100%;
                        max-width: 800px;
                    }

                    .suggestion-chip {
                        background: white;
                        border: 2px solid #e5e7eb;
                        border-radius: 14px;
                        padding: 18px 22px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 14px;
                        text-align: left;
                        font-size: 0.95rem;
                        font-weight: 600;
                        color: #475569;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
                    }

                    .suggestion-chip:hover {
                        border-color: #8b5cf6;
                        background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
                        transform: translateY(-3px);
                        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.2);
                    }

                    .chip-icon {
                        font-size: 20px;
                        flex-shrink: 0;
                    }

                    .chat-messages-enhanced {
                        flex: 1;
                        padding: 20px 0;
                        overflow-y: auto;
                        scroll-behavior: smooth;
                        max-height: 400px;
                    }

                    .message-wrapper {
                        display: flex;
                        margin-bottom: 20px;
                        animation: slideInMessage 0.3s ease-out;
                    }

                    @@keyframes slideInMessage {
                        from {
                            opacity: 0;
                            transform: translateY(10px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    .message-wrapper.user-message {
                        justify-content: flex-end;
                    }

                    .message-wrapper.ai-message {
                        justify-content: flex-start;
                    }

                    .message-avatar {
                        margin: 0 12px;
                        flex-shrink: 0;
                    }

                    .avatar-small {
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                        color: white;
                        box-shadow: 0 3px 12px rgba(139, 92, 246, 0.35);
                        border: 2px solid rgba(255, 255, 255, 0.8);
                    }

                    .avatar-small.user {
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        box-shadow: 0 3px 12px rgba(59, 130, 246, 0.35);
                    }

                    .avatar-small.thinking {
                        animation: thinking 2s ease-in-out infinite;
                    }

                    @@keyframes thinking {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.1); }
                    }

                    .message-bubble {
                        max-width: 70%;
                        border-radius: 18px;
                        padding: 0;
                        position: relative;
                        word-wrap: break-word;
                    }

                    .user-bubble {
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border-bottom-right-radius: 4px;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
                    }

                    .ai-bubble {
                        background: white;
                        color: #1e293b;
                        border: 2px solid #e5e7eb;
                        border-bottom-left-radius: 4px;
                        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
                    }

                    .typing-bubble {
                        background: linear-gradient(135deg, #fafbfc 0%, #f3f4f6 100%);
                        border: 2px solid #e5e7eb;
                    }

                    .message-content-enhanced {
                        padding: 18px 22px;
                    }

                    .message-text-enhanced {
                        line-height: 1.6;
                        margin-bottom: 8px;
                        font-size: 0.98rem;
                        font-weight: 500;
                    }

                    .message-metadata {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 8px;
                    }

                    .message-time-enhanced {
                        font-size: 0.75rem;
                        opacity: 0.7;
                    }

                    .message-actions {
                        display: flex;
                        gap: 8px;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                    }

                    .message-wrapper:hover .message-actions {
                        opacity: 1;
                    }

                    .action-btn {
                        background: none;
                        border: none;
                        padding: 4px 8px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.2s ease;
                        color: #64748b;
                    }

                    .action-btn:hover {
                        background: rgba(100, 116, 139, 0.1);
                        transform: scale(1.1);
                    }

                    .typing-indicator-enhanced {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 16px 20px;
                    }

                    .typing-dots {
                        display: flex;
                        gap: 4px;
                    }

                    .typing-dots span {
                        width: 9px;
                        height: 9px;
                        border-radius: 50%;
                        background: #8b5cf6;
                        animation: typingDot 1.4s infinite ease-in-out;
                    }

                    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
                    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

                    @@keyframes typingDot {
                        0%, 80%, 100% {
                            transform: scale(0.8);
                            opacity: 0.5;
                        }
                        40% {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }

                    .typing-text {
                        color: #64748b;
                        font-size: 0.85rem;
                        font-style: italic;
                    }

                    .chat-input-area {
                        border-top: 2px solid #e5e7eb;
                        background: linear-gradient(135deg, #fafbfc 0%, #f8f9fa 100%);
                        padding: 24px;
                        margin: 0 -24px -24px -24px;
                        border-radius: 0 0 18px 18px;
                    }

                    .input-container-enhanced {
                        max-width: 100%;
                    }

                    .input-wrapper {
                        display: flex;
                        align-items: flex-end;
                        gap: 12px;
                        background: white;
                        border: 2px solid #e5e7eb;
                        border-radius: 28px;
                        padding: 10px 10px 10px 24px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
                    }

                    .input-wrapper:focus-within {
                        border-color: #8b5cf6;
                        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.2);
                        transform: translateY(-1px);
                    }

                    .chat-input-enhanced {
                        flex: 1;
                        border: none;
                        outline: none;
                        padding: 14px 0;
                        font-size: 0.98rem;
                        line-height: 1.5;
                        background: transparent;
                        resize: none;
                        min-height: 22px;
                        max-height: 120px;
                        overflow-y: auto;
                        font-family: inherit;
                        font-weight: 500;
                        color: #1e293b;
                    }

                    .chat-input-enhanced::placeholder {
                        color: #94a3b8;
                    }

                    .input-actions {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .action-button {
                        background: none;
                        border: none;
                        padding: 8px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 16px;
                        transition: all 0.2s ease;
                        color: #64748b;
                    }

                    .action-button:hover:not(:disabled) {
                        background: #f1f5f9;
                        transform: scale(1.1);
                    }

                    .action-button:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }

                    .send-button {
                        background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 48px;
                        height: 48px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.35);
                        font-size: 18px;
                    }

                    .send-button:hover:not(:disabled) {
                        transform: scale(1.08);
                        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.45);
                        background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%);
                    }

                    .send-button:disabled,
                    .send-button.disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
                    }

                    .send-icon {
                        font-size: 18px;
                    }

                    .spinner-small {
                        width: 16px;
                        height: 16px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-top: 2px solid white;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }

                    @@keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }

                    .input-footer {
                        display: flex;
                        justify-content: flex-end;
                        margin-top: 8px;
                    }

                    .char-count {
                        font-size: 0.75rem;
                        color: #94a3b8;
                    }

                    @@media (max-width: 768px) {
                        .chat-header-modern {
                            padding: 16px 20px;
                        }
                        
                        .chat-title-text h4 {
                            font-size: 1.1rem;
                        }
                        
                        .avatar-circle {
                            width: 40px;
                            height: 40px;
                        }
                        
                        .ai-icon {
                            font-size: 20px;
                        }
                        
                        .suggestion-chips {
                            grid-template-columns: 1fr;
                        }
                        
                        .message-bubble {
                            max-width: 85%;
                        }
                        
                        .chat-input-area {
                            padding: 16px;
                        }
                        
                        .welcome-content p {
                            font-size: 0.9rem;
                        }
                    }
                </style>
                <div class="chat-header-modern">
                    <div class="chat-title-area">
                        <div class="ai-avatar">
                            <div class="avatar-circle">
                                <img class="ai-icon-img" src="/images/chat-bot.png" alt="AI" />
                                <div class="status-indicator online"></div>
                            </div>
                        </div>
                        <div class="chat-title-text">
                            <h4>AI Assistant</h4>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <button class="clear-chat-btn" @onclick="ClearChatHistory" title="Clear chat">
                            <span class="icon"><img class="inline-icon" src="/images/trash.png" alt="Delete" /></span>
                        </button>
                    </div>
                </div>
                
                <div class="enhanced-chat-container">
                    <!-- Welcome Message when no chat history -->
                    @if (!chatHistory.Any() && !isProcessingChat)
                    {
                        <div class="welcome-section">
                            <div class="welcome-avatar">
                                <div class="welcome-circle">
                                    <img class="welcome-ai-icon-img" src="/images/chat-bot.png" alt="AI" />
                                </div>
                            </div>
                            <div class="welcome-content">
                                <h5>Hello! I'm TCH's AI Assistant</h5>
                                <p>I can help you analyze your survey data and provide insights. Here are some things you can ask me:</p>
                                <div class="suggestion-chips">
                                    <button class="suggestion-chip" @onclick='() => SendSuggestionMessage("Which sector has the lowest satisfaction?")'>
                                        <span class="chip-icon"><img class="chip-icon-img" src="/images/graph.png" alt="Trend" /></span>
                                        Sector performance
                                    </button>
                                    <button class="suggestion-chip" @onclick='() => SendSuggestionMessage("What are the main issues in my survey data?")'>
                                        <span class="chip-icon"><img class="chip-icon-img" src="/images/vote.png" alt="Low score" /></span>
                                        Main issues
                                    </button>
                                    <button class="suggestion-chip" @onclick='() => SendSuggestionMessage("Give me recommendations to improve satisfaction")'>
                                        <span class="chip-icon"><img class="chip-icon-img" src="/images/lightbulb.png" alt="Recommendations" /></span>
                                        Recommendations
                                    </button>
                                    <button class="suggestion-chip" @onclick='() => SendSuggestionMessage("What trends do you see in my data?")'>
                                        <span class="chip-icon"><img class="chip-icon-img" src="/images/trend.png" alt="Trend analysis" /></span>
                                        Trends analysis
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                    
                    <!-- Chat Messages -->
                    <div class="chat-messages-enhanced" id="chatMessages">
                        @foreach (var message in chatHistory)
                        {
                            <div class="message-wrapper @(message.IsUser ? "user-message" : "ai-message")">
                                @if (!message.IsUser)
                                {
                                    <div class="message-avatar">
                                        <div class="avatar-small">
                                            <img class="ai-icon-img" src="/images/chat-bot.png" alt="AI" />
                                        </div>
                                    </div>
                                }
                                <div class="message-bubble @(message.IsUser ? "user-bubble" : "ai-bubble")">
                                    <div class="message-content-enhanced">
                                        <div class="message-text-enhanced">@message.Text</div>
                                        <div class="message-metadata">
                                            <span class="message-time-enhanced">@message.Timestamp.ToString("HH:mm", System.Globalization.CultureInfo.InvariantCulture)</span>
                                            @if (!message.IsUser)
                                            {
                                                <div class="message-actions">
                                                    <button class="action-btn copy-btn" @onclick="() => CopyMessageToClipboard(message.Text)" title="Copy response">
                                                        <img class="inline-icon" src="/images/copy.png" alt="Copy" style="width: 14px; height: 14px;" />
                                                    </button>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                @if (message.IsUser)
                                {
                                    <div class="message-avatar user-avatar">
                                        <div class="avatar-small user">
                                            <span>üë§</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        
                        @if (isProcessingChat)
                        {
                            <div class="message-wrapper ai-message">
                                <div class="message-avatar">
                                    <div class="avatar-small thinking">
                                        <img class="ai-icon-img" src="/images/chat-bot.png" alt="AI" />
                                    </div>
                                </div>
                                <div class="message-bubble ai-bubble typing-bubble">
                                    <div class="typing-indicator-enhanced">
                                        <div class="typing-dots">
                                            <span></span>
                                            <span></span>
                                            <span></span>
                                        </div>
                                        <span class="typing-text">AI is thinking...</span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Enhanced Input Area -->
                    <div class="chat-input-area">
                        <div class="input-container-enhanced">
                            <div class="input-wrapper">
                                <textarea @bind="chatInput" 
                                         @onkeydown="HandleChatKeyDown"
                                         @oninput="HandleInputChange"
                                         placeholder="Ask me anything about your survey data..." 
                                         class="chat-input-enhanced" 
                                         disabled="@isProcessingChat"
                                         rows="1"></textarea>
                                <div class="input-actions">
                                    <button class="send-button @(string.IsNullOrWhiteSpace(chatInput) ? "disabled" : "")" 
                                            @onclick="SendChatMessage" 
                                            disabled="@(isProcessingChat || string.IsNullOrWhiteSpace(chatInput))"
                                            title="Ask">
                                        @if (isProcessingChat)
                                        {
                                            <div class="spinner-small"></div>
                                        }
                                        else
                                        {
                                            <span class="send-icon"><img class="inline-icon" src="/images/send.png" alt="Send" /></span>
                                        }
                                    </button>
                                </div>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(chatInput))
                            {
                                <div class="input-footer">
                                    <span class="char-count">@chatInput.Length characters</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hierarchical Navigation Section -->
            <div class="sector-details" id="sectors">
                <div class="section-header">
                    <h3>
                        @if (currentNavigationLevel == "sectors")
                        {
                            @if (userRole == "Admin")
                            {
                                <span><img class="section-icon" src="/images/customer-segment.png" alt="Select Sector" /> Select sector to view responses</span>
                            }
                            else
                            {
                                <span><img class="section-icon" src="/images/customer-segment.png" alt="Your Sector" /> Your sector responses</span>
                            }
                        }
                        else if (currentNavigationLevel == "customers")
                        {
                            <span><img class="inline-icon" src="/images/workplace.png" alt="Clients" /> Clients in @selectedSector sector</span>
                        }
                        else if (currentNavigationLevel == "projects")
                        {
                            <span><img class="inline-icon" src="/images/project.png" alt="Projects" /> Projects for @selectedCustomer</span>
                        }
                        else if (currentNavigationLevel == "analysis")
                        {
                            <span><img class="inline-icon" src="/images/analysis.png" alt="Responses" /> Responses: @selectedProject</span>
                        }
                    </h3>
                    
                    @if (ShouldShowBackButton())
                    {
                        <button class="toggle-btn" @onclick="NavigateBack">‚Üê Back</button>
                    }
                </div>

                @if (currentNavigationLevel == "sectors")
                {
                    @if (userRole == "Admin")
                    {
                        <!-- Sector Selection - Show all sectors for Admin -->
                        <div class="navigation-grid">
                            @foreach (var sectorKvp in sectorCounts)
                            {
                                var sector = sectorKvp.Key;
                                var count = sectorKvp.Value;
                                var sectorResponses = surveyResponses.Where(r => r.Sector == sector).ToList();
                                var avgSat = sectorResponses.Count > 0 ? Math.Round(sectorResponses.Average(r => r.Question1), 1) : 0;
                                var completedCount = sectorResponses.Count(r => r.DateCompleted.HasValue);
                                var completionRate = count > 0 ? (double)completedCount / count * 100 : 0;
                                
                                <div class="navigation-card sector-card" @onclick="() => NavigateToCustomers(sector)">
                                    <div class="card-icon">@GetSectorIcon(sector)</div>
                                    <h4>@sector</h4>
                                    <div class="card-stats">
                                        <div class="stat-item">
                                            <span class="stat-number">@count</span>
                                            <span class="stat-label">Total Surveys</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-number">@avgSat</span>
                                            <span class="stat-label">Avg. Score</span>
                                        </div>
                                    </div>
                                    <div class="completion-stats">
                                        <div class="completion-bar">
                                            <div class="completion-fill" style="width: @(completionRate)%"></div>
                                        </div>
                                        <span class="completion-text">@completedCount/@count completed (@(completionRate.ToString("F0"))%)</span>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>
                            }
                        </div>
                    }
                }
                else if (currentNavigationLevel == "customers")
                {
                    <!-- Customer Selection - Now role-filtered for detailed analysis -->
                    <div class="navigation-grid">
                        @foreach (var customer in GetCustomersForSector(selectedSector!))
                        {
                            var customerResponses = GetRoleBasedResponses().Where(r => r.Sector == selectedSector && r.CustomerName == customer).ToList();
                            
                            @if (customerResponses.Any()) // Only show if user has access to this data
                            {
                                var avgSat = customerResponses.Count > 0 ? Math.Round(customerResponses.Average(r => r.Question1), 1) : 0;
                                var projectCount = customerResponses.Select(r => r.ProjectName).Distinct().Count();
                                
                                <div class="navigation-card customer-card" @onclick="() => NavigateToProjects(customer)">
                                    <div class="card-icon"><img class="card-icon-img" src="/images/workplace.png" alt="Customer" /></div>
                                    <h4>@customer</h4>
                                    <div class="card-stats">
                                        <div class="stat-item">
                                            <span class="stat-number">@projectCount</span>
                                            <span class="stat-label">Projects</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-number">@avgSat</span>
                                            <span class="stat-label">Avg. Score</span>
                                        </div>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>
                            }
                        }
                    </div>
                }
                else if (currentNavigationLevel == "projects")
                {
                    <!-- Project Selection -->
                    <div class="navigation-grid">
                        @foreach (var project in GetProjectsForCustomer(selectedSector!, selectedCustomer!))
                        {
                            var projectResponses = GetProjectResponses(selectedSector!, selectedCustomer!, project);
                            var avgSat = projectResponses.Count > 0 ? Math.Round(projectResponses.Average(r => r.Question1), 1) : 0;
                            var duration = projectResponses.FirstOrDefault()?.ProjectDuration ?? "N/A";
                            
                            <div class="navigation-card project-card" @onclick="() => NavigateToAnalysis(project)">
                                <div class="card-icon"><img class="card-icon-img" src="/images/project.png" alt="Project" /></div>
                                <h4>@project</h4>
                                <div class="card-stats">
                                    <div class="stat-item">
                                        <span class="stat-number">@projectResponses.Count</span>
                                        <span class="stat-label">Responses</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number">@avgSat</span>
                                        <span class="stat-label">Score</span>
                                    </div>
                                </div>
                                <div class="card-arrow">‚Üí</div>
                            </div>
                        }
                    </div>
                }
                else if (currentNavigationLevel == "analysis")
                {
                    var analysisResponses = GetProjectResponses(selectedSector!, selectedCustomer!, selectedProject!);
                    
                    <!-- Detailed Analysis -->
                    
                    <div class="detailed-analysis-container">
                        <div class="analysis-header">
                            <div class="project-info">
                                <h4>@selectedProject</h4>
                                <p><strong>Client:</strong> @selectedCustomer</p>
                                <p><strong>Sector:</strong> @selectedSector</p>
                                <p><strong>Total Responses:</strong> @analysisResponses.Count</p>
                                @if (analysisResponses.Any())
                                {
                                    <p><strong>Response Period:</strong> 
                                       @analysisResponses.Min(r => r.DateCompleted?.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture) ?? "N/A") - 
                                       @analysisResponses.Max(r => r.DateCompleted?.ToString("MM/dd/yyyy", System.Globalization.CultureInfo.InvariantCulture) ?? "N/A")
                                    </p>
                                }
                            </div>
                        </div>

                        <!-- Question Breakdown for this specific project -->
                        <div class="analysis-charts">
                            <div class="chart-container">
                                <h5><img class="inline-icon" src="/images/customer-survey.png" alt="Question Breakdown" /> Question Breakdown</h5>
                                <div class="professional-question-breakdown">
                                    @for (int q = 1; q <= 9; q++)
                                    {
                                        var scores = analysisResponses.Select(r => GetQuestionScore(r, q)).Where(s => s > 0);
                                        var avg = scores.Any() ? Math.Round(scores.Average(), 1) : 0;
                                        var count = scores.Count();
                                        var questionClass = avg >= 8 ? "excellent" : avg >= 6 ? "good" : avg >= 4 ? "average" : "poor";
                                        var barColor = avg >= 8 ? "#28a745" : avg >= 6 ? "#17a2b8" : avg >= 4 ? "#ffc107" : "#dc3545";
                                        var percentage = avg / 10 * 100;
                                        
                                        <div class="pro-breakdown-item">
                                            <div class="breakdown-header">
                                                <div class="breakdown-left">
                                                    <span class="breakdown-number">Q@(q)</span>
                                                    <span class="breakdown-text">@GetQuestionText(q)</span>
                                                </div>
                                                <div class="breakdown-score" style="color: @barColor;">@avg.ToString("F1")</div>
                                            </div>
                                            <div class="breakdown-progress">
                                                <div class="breakdown-track">
                                                    <div class="breakdown-fill" style="width: @(percentage)%; background: @barColor;"></div>
                                                </div>
                                            </div>
                                            <div class="breakdown-meta">
                                                <span class="breakdown-badge @questionClass">@GetQuestionCategory(avg)</span>
                                                <span class="breakdown-count">@count responses</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <!-- Individual Response Details -->
                            <div class="chart-container">
                                <h5><img class="inline-icon" src="/images/checklist.png" alt="Survey Responses" /> Individual Survey Responses</h5>
                                <div class="responses-table">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Survey ID</th>
                                                <th>Date Sent</th>
                                                <th>Date Completed</th>
                                                <th>Project Duration</th>
                                                <th>Overall Score</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var response in analysisResponses.OrderByDescending(r => r.DateCompleted))
                                            {
                                                <tr>
                                                    <td><code>@response.SurveyId.Substring(0, 8)...</code></td>
                                                    <td>@(response.DateSent?.ToString("MM/dd/yyyy HH:mm", System.Globalization.CultureInfo.InvariantCulture) ?? "N/A")</td>
                                                    <td>@(response.DateCompleted?.ToString("MM/dd/yyyy HH:mm", System.Globalization.CultureInfo.InvariantCulture) ?? "N/A")</td>
                                                    <td>@(response.ProjectDuration ?? "N/A")</td>
                                                    <td>
                                                        <span class="badge @(response.Question1 >= 8 ? "bg-success" : response.Question1 >= 6 ? "bg-info" : response.Question1 >= 4 ? "bg-warning" : "bg-danger")">
                                                            @response.Question1/10
                                                        </span>
                                                    </td>
                                                    <td>
                                                        @if (response.DateCompleted.HasValue)
                                                        {
                                                            <span class="badge bg-success">‚úì Completed</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-warning">‚è≥ Pending</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
        background: transparent;
    }

    .dashboard-top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .dashboard-top-bar {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 24px;
        padding: 0 8px;
    }

    .dashboard-footer {
        font-size: 0.95rem;
        color: #888;
        opacity: 0.7;
    }

    .dashboard-container::before { display: none; }

    .dashboard-container h2 {
        text-align: center;
        color: #0f172a;
        font-weight: 700;
        margin-bottom: 24px;
        letter-spacing: 0.2px;
        font-size: 2rem;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #D9D9D9 0%, #D9D9D9 100%) !important;
        border-radius: 16px !important;
        padding: 48px 40px !important;
        margin-bottom: 32px !important;
        position: relative !important;
        overflow: hidden !important;
    }
    .dashboard-header::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") !important;
        opacity: 0.4 !important;
    }
    .header-content {
        position: relative !important;
        z-index: 1 !important;
        text-align: center !important;
        width: 100% !important;
    }
    .page-title {
        font-size: 2.8rem !important;
        font-weight: 600 !important;
        color: #5c5c5c !important;
        margin: 0 0 12px 0 !important;
        letter-spacing: 0.5px !important;
        text-shadow: 0 4px 24px rgba(0, 0, 0, 0.25) !important;
        font-family: 'Poppins', sans-serif !important;
        line-height: 1.3 !important;
        text-align: center !important;
    }
    .page-subtitle {
        font-size: 1.15rem !important;
        color: #5c5c5c !important;
        margin: 0 !important;
        font-weight: 400 !important;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.15) !important;
        text-align: center !important;
    }

    .summary-cards {
        display: flex;
        gap: 32px;
        margin-bottom: 40px;
        justify-content: center;
    }
    .card {
        background: #fff;
        padding: 24px 20px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        text-align: center;
        border: 1px solid #e5e7eb;
        min-width: 220px;
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
    }

    .card, .chart-container, .navigation-card, .satisfaction-card {
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card.clickable:hover, .chart-container:hover, .navigation-card:hover, .satisfaction-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transform: translateY(-2px);
        border-color: #d1d5db;
    }

    .card::before { display: none; }

    .card.clickable {
        cursor: pointer;
    }

    .card.clickable:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transform: translateY(-2px);
    }

    .card.clickable:hover::before { display: none; }

    .card-icon {
        font-size: 2.2rem;
        margin-bottom: 10px;
        color: #334155;
    }

    .card h3 {
        font-size: 2.2rem;
        color: #111827;
        margin: 0 0 6px 0;
        font-weight: 700;
        transition: color 0.2s ease;
    }

    .card.clickable:hover h3 {
        color: #0f172a;
    }

    .card p {
        color: #4b5563;
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .card-arrow {
        font-size: 1.7rem;
        color: #28a745;
        opacity: 0.7;
    }

    .card.clickable:hover .card-arrow {
        opacity: 1;
        transform: translateX(8px);
        color: #28a745;
    }

    .satisfaction-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        margin-top: 12px;
        overflow: hidden;
        position: relative;
    }

    .satisfaction-fill {
        height: 100%;
        background: #64748b;
        border-radius: 4px;
        transition: width 1s ease;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 18px;
        margin-bottom: 24px;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 8px;
    }
    .section-header h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #212529;
        margin: 0;
    }

    .filter-buttons, .chart-controls, .view-toggles, .performance-controls {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
    }

    .control-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .year-filter-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        margin-right: 8px;
    }

    .year-filter-dropdown {
        padding: 6px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #374151;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        min-width: 100px;
    }

    .year-filter-dropdown:hover { border-color: #d1d5db; }

    .year-filter-dropdown:focus {
        outline: none;
        border-color: #c82333;
        box-shadow: 0 0 0 3px rgba(200,35,51,0.12);
    }

    .filter-btn, .view-btn, .toggle-btn, .perf-btn {
        padding: 8px 14px;
        border: 1px solid #e5e7eb;
        background: #fff;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: border-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
        color: #374151;
    }

    .filter-btn:hover, .view-btn:hover, .toggle-btn:hover, .perf-btn:hover {
        border-color: #d1d5db;
        transform: translateY(-1px);
    }

    .filter-btn.active, .view-btn.active, .toggle-btn.active, .perf-btn.active {
        background: #c82333;
        color: #fff;
        border-color: #c82333;
        box-shadow: none;
    }

    /* Trend Info Boxes */
    .trend-info-boxes {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 24px;
    }

    .trend-info-box {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }

    .trend-info-box:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }

    .trend-info-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-size: 24px;
        flex-shrink: 0;
    }

    .trend-icon {
        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    }

    .highest-icon {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    .lowest-icon {
        background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }

    .trend-info-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .trend-info-label {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .trend-info-value {
        font-size: 20px;
        font-weight: 700;
        color: #1f2937;
    }

    .trend-info-value.positive {
        color: #28a745;
    }

    .trend-info-value.negative {
        color: #dc3545;
    }

    .trend-info-value.neutral {
        color: #6c757d;
    }

    /* Professional monthly chart styles */
    .pro-chart {
        display: grid;
        grid-template-columns: 48px 1fr;
        grid-template-rows: 280px 36px;
        gap: 0;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        padding: 12px 16px 8px 12px;
    }
    .pro-y-axis {
        position: relative;
        border-right: 1px solid #e9ecef;
        margin-right: 12px;
    }
    .pro-y-tick {
        position: absolute;
        right: 8px;
        transform: translateY(50%);
        font-size: 12px;
        color: #6b7280;
    }
    .pro-chart-area {
        position: relative;
        border-left: 1px solid transparent;
    }
    .pro-grid {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
        background: #eef2f7;
    }
    .pro-x-baseline {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 2px;
        background: #cbd5e1;
    }
    .pro-points {
        position: absolute;
        inset: 0;
    }
    .pro-point { position: absolute; }
    .pro-dot {
        width: 10px;
        height: 10px;
        background: #0B6BD3;
        border-radius: 50%;
        box-shadow: 0 0 0 2px #ffffff, 0 1px 4px rgba(0,0,0,0.12);
    }
    .pro-tip {
        position: absolute;
        top: -28px;
        left: 50%;
        transform: translateX(-50%);
        background: #111827;
        color: #fff;
        font-size: 11px;
        padding: 4px 6px;
        border-radius: 6px;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        opacity: 0;
        transition: opacity 0.15s ease;
    }
    .pro-point:hover .pro-tip { opacity: 1; }
    .pro-line {
        position: absolute;
        inset: 0;
    }
    .pro-bars {
        position: absolute;
        inset: 0;
    }
    .pro-bar-slot {
        position: absolute;
        bottom: 0;
        top: 0;
        transform: translateX(-50%);
        width: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
    }
    .pro-bar {
        width: 32px;
        background: linear-gradient(180deg, #3b82f6 0%, #1e40af 100%);
        border-radius: 4px 4px 0 0;
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
        position: relative;
        min-height: 4px;
        transition: all 0.2s ease;
    }
    .pro-bar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.18);
        background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%);
    }
    .pro-bar-value {
        position: absolute;
        top: -26px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        font-weight: 600;
        color: #1e40af;
        background: #ffffff;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        white-space: nowrap;
    }
    .no-data-text {
        position: absolute;
        bottom: 20%;
        left: 50%;
        transform: translateX(-50%);
        color: #9ca3af;
        font-style: italic;
        font-size: 10px;
        white-space: nowrap;
    }
    .pro-x-axis {
        grid-column: 1 / span 2;
        position: relative;
        padding-top: 8px;
        color: #6b7280;
        font-size: 12px;
        height: 24px;
    }
    .pro-x-label { 
        position: absolute;
        transform: translateX(-50%);
        text-align: center;
        font-weight: 500;
        color: #374151;
    }

    .filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }

    .filter-section {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
    }

    .filter-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.85rem;
        margin: 0;
    }

    .filter-dropdown {
        padding: 8px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        color: #374151;
        font-size: 0.9rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }

    .filter-dropdown:hover {
        border-color: #d1d5db;
    }

    .filter-dropdown:focus {
        outline: none;
        border-color: #c82333;
        box-shadow: 0 0 0 3px rgba(200, 35, 51, 0.12);
    }

    .clear-filters-btn {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .clear-filters-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .active-filters {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .filter-indicator {
        font-weight: 600;
        color: #495057;
        font-size: 0.85rem;
    }

    .filter-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #374151;
        background: #eef2f7;
        border: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .filter-badge.sector {
        background: #e5e7eb;
        color: #374151;
    }

    .filter-badge.company-size {
        background: #e5e7eb;
        color: #374151;
    }

    .satisfaction-details {
        margin-top: 8px;
        text-align: center;
    }

    .satisfaction-details small {
        color: #6c757d;
        font-size: 0.75rem;
    }

    .chart-container {
        background: #fff;
        padding: 24px 20px;
        margin-bottom: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        border: 1px solid #e5e7eb;
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .chart-container:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transform: translateY(-2px);
        border-color: #d1d5db;
    }

    /* New Simple Chart CSS */
    .new-chart-header {
        text-align: center;
        margin-bottom: 20px;
    }

    .new-chart-header h3 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 1.2rem;
    }

    .new-chart-header p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .new-chart-container {
        display: flex;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background: white;
        position: relative;
    }

    .new-y-axis {
        width: 40px;
        position: relative;
        border-right: 2px solid #333;
    }

    .y-tick {
        position: absolute;
        right: 5px;
        transform: translateY(50%);
        font-size: 0.8rem;
        color: #666;
    }

    .new-chart-area {
        flex: 1;
        position: relative;
        margin-left: 15px;
        display: flex;
        align-items: end;
        justify-content: space-between;
        padding: 20px 10px 40px 10px; /* bottom padding reserves space for x-axis labels */
        height: 250px;
    }

    .grid-line {
        position: absolute;
        left: 0;
        right: 0;
        border-bottom: 1px solid #e9ecef;
        width: 100%;
        z-index: 1;
    }

    .month-column {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
        width: 40px;
        height: 100%;
        position: relative;
    }

    .data-bar { display: none; } /* switch to line chart presentation */

    .data-bar:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .no-data-indicator {
        width: 28px;
        height: 15px;
        background-color: #f8f9fa;
        border: 1px dashed #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        bottom: 0; /* align no-data indicator to zero baseline */
        font-size: 12px;
        color: #6c757d;
    }
    .no-data-indicator.small {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 1px dashed #dee2e6;
        background: #fff;
    }

    .bar-value {
        display: none;
    }

    /* Line chart styles */
    .trend-line-svg {
        position: absolute;
        /* match inner chart-area padding so the path aligns with points and grid */
        left: 10px;
        right: 10px;
        top: 20px;
        bottom: 40px;
        z-index: 1;
        pointer-events: none;
    }
    .points-overlay { position: absolute; left: 10px; right: 10px; top: 20px; bottom: 40px; z-index: 2; pointer-events: none; }
    .line-point {
        position: absolute;
        transform: translateX(-50%);
        pointer-events: auto;
    }
    .point-dot {
        width: 10px;
        height: 10px;
        background: #1e88e5;
        border-radius: 50%;
        box-shadow: 0 0 0 2px #ffffff;
    }
    .line-point:hover .point-dot { box-shadow: 0 0 0 2px #ffffff, 0 0 8px rgba(30,136,229,0.5); }
    .point-tooltip {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        background: #1e88e5;
        color: #fff;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        display: none;
    }
    .line-point:hover .point-tooltip { display: block; }

    .month-label {
        position: absolute;
        bottom: -30px;
        font-size: 0.8rem;
        font-weight: 500;
        color: #6c757d;
        text-align: center;
        width: 100%;
    }

    .new-x-axis {
        position: absolute;
        left: 85px; /* container padding (20) + y-axis (40) + gap (15) + chart-area padding-left (10) */
        right: 30px; /* container padding-right (20) + chart-area padding-right (10) */
        bottom: 8px; /* inside container, below the x baseline */
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        pointer-events: none; /* labels non-interactive */
    }

    .x-tick {
        position: relative;
        width: 40px; /* match month-column width for alignment */
        text-align: center;
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
        line-height: 1;
    }

    .x-baseline {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        border-top: 2px solid #333;
        z-index: 2;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .chart-header h4 {
        color: #0f172a;
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .interactive-bar-chart {
        margin-top: 20px;
    }

    .interactive-bar-item {
        margin-bottom: 20px;
        padding: 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .interactive-bar-item:hover, .interactive-bar-item.hovered {
        background: #f9fafb;
        border-color: #e5e7eb;
        transform: translateX(4px);
    }

    .bar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .bar-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #333;
        font-size: 1rem;
    }

    .sector-icon {
        font-size: 1.2rem;
    }

    /* Ensure SVG icons render at similar size as emojis */
    .sector-icon img,
    .sector-icon-large img,
    .card-icon img {
        width: 1.4em;
        height: 1.4em;
        display: inline-block;
        vertical-align: middle;
    }

        /* Icon sizing utilities for PNGs */
        .section-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 10px;
        }
        .inline-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
            vertical-align: text-bottom;
            margin-right: 6px;
        }
        .chip-icon-img {
            width: 18px;
            height: 18px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 6px;
        }
        .trend-icon-img {
            width: 24px;
            height: 24px;
            object-fit: contain;
            vertical-align: middle;
        }
        .card-icon-img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            vertical-align: middle;
        }
        .no-data-img {
            width: 30px;
            height: 30px;
            object-fit: contain;
            opacity: 0.7;
        }

    .bar-value-display {
        font-weight: 700;
        color: #111827;
        font-size: 1.1rem;
    }

    .bar-wrapper {
        position: relative;
        height: 12px;
        background: #e9ecef;
        border-radius: 6px;
        overflow: hidden;
    }

    .completion-progress-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: rgba(0,0,0,0.1);
        border-radius: 6px;
    }

    .completion-progress-fill {
        height: 100%;
        background: #64748b;
        border-radius: 6px;
        transition: width 0.8s ease;
    }

    .completion-bar {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin: 8px 0 4px 0;
        overflow: hidden;
    }

    .completion-fill {
        height: 100%;
        background: #64748b;
        border-radius: 3px;
        transition: width 0.8s ease;
    }

    .completion-stats {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
    }

    .completion-text {
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
        text-align: center;
        display: block;
        margin-top: 4px;
    }

    .interactive-bar {
        height: 100%;
        border-radius: 6px;
        position: relative;
        animation: slideIn 0.8s ease;
        transition: all 0.3s ease;
    }

    .interactive-bar-item:hover .interactive-bar {
        transform: scaleY(1.2);
    }

    .bar-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 2s ease-in-out infinite;
    }

    .slideIn {
        animation: slideIn 0.8s ease;
    }

    .shine {
        animation: shine 2s ease-in-out infinite;
    }

    .sector-dropdown {
        margin-top: 16px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 8px;
        animation: slideDown 0.3s ease;
    }

    .dropdown-stats {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }

    .mini-stat {
        text-align: center;
    }

    .mini-stat-value {
        display: block;
        font-size: 1.4rem;
        font-weight: 700;
        color: #111827;
    }

    .mini-stat-label {
        font-size: 0.8rem;
        color: #666;
    }

    .satisfaction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .satisfaction-card {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border-left: 4px solid #007bff;
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .satisfaction-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 50% 50%, rgba(0,123,255,0.05) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .satisfaction-card:hover::before, .satisfaction-card.selected::before {
        opacity: 1;
    }

    .satisfaction-card:hover, .satisfaction-card.selected {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .satisfaction-card.excellent { border-left-color: #28a745; }
    .satisfaction-card.good { border-left-color: #17a2b8; }
    .satisfaction-card.average { border-left-color: #ffc107; }
    .satisfaction-card.poor { border-left-color: #dc3545; }

    .satisfaction-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .satisfaction-header h5 {
        margin: 0;
        color: #333;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .satisfaction-score-big {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
    }

    .satisfaction-meter {
        position: relative;
        margin-bottom: 16px;
    }

    .meter-track {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
    }

    .meter-fill {
        height: 8px;
        background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
        border-radius: 4px;
        transition: width 1s ease;
        position: absolute;
        top: 0;
    }

    .meter-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
    }

    .meter-label {
        font-size: 0.7rem;
        color: #999;
    }

    .satisfaction-emotion {
        text-align: center;
        font-size: 2rem;
        margin-top: 12px;
    }

    /* Professional Satisfaction Card */
    .professional-satisfaction-card {
        background: #fff;
        border: 2px solid #e5e7eb;
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .professional-satisfaction-card:hover {
        border-color: #cbd5e1;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        transform: translateY(-4px);
    }

    .professional-satisfaction-card.excellent {
        border-left: 4px solid #28a745;
    }

    .professional-satisfaction-card.good {
        border-left: 4px solid #17a2b8;
    }

    .professional-satisfaction-card.average {
        border-left: 4px solid #ffc107;
    }

    .professional-satisfaction-card.poor {
        border-left: 4px solid #dc3545;
    }

    .pro-sat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }

    .pro-sat-title {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .pro-sat-title h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
    }

    .pro-sat-icon {
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: #f8fafc;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .pro-sat-icon img {
        width: 18px;
        height: 18px;
        object-fit: contain;
    }

    .pro-sat-score-badge {
        font-size: 28px;
        font-weight: 800;
        padding: 8px 16px;
        border-radius: 12px;
        line-height: 1;
    }

    .pro-sat-score-badge.excellent {
        color: #28a745;
        background: #d1fae5;
    }

    .pro-sat-score-badge.good {
        color: #17a2b8;
        background: #dbeafe;
    }

    .pro-sat-score-badge.average {
        color: #f59e0b;
        background: #fef3c7;
    }

    .pro-sat-score-badge.poor {
        color: #dc3545;
        background: #fee2e2;
    }

    .pro-sat-progress {
        margin-bottom: 16px;
    }

    .pro-sat-track {
        position: relative;
        height: 12px;
        background: #f3f4f6;
        border-radius: 10px;
        overflow: visible;
        margin-bottom: 8px;
    }

    .pro-sat-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.8s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .pro-sat-fill.excellent {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
    }

    .pro-sat-fill.good {
        background: linear-gradient(90deg, #17a2b8 0%, #3b82f6 100%);
    }

    .pro-sat-fill.average {
        background: linear-gradient(90deg, #ffc107 0%, #f59e0b 100%);
    }

    .pro-sat-fill.poor {
        background: linear-gradient(90deg, #dc3545 0%, #ef4444 100%);
    }

    .pro-sat-goal-marker {
        position: absolute;
        left: 90%;
        top: -4px;
        bottom: -4px;
        width: 3px;
        background: #28a745;
        border-radius: 2px;
        box-shadow: 0 0 8px rgba(40, 167, 69, 0.6);
        z-index: 10;
    }

    .pro-sat-scale {
        display: flex;
        justify-content: space-between;
        padding: 0 2px;
    }

    .scale-tick {
        font-size: 11px;
        color: #9ca3af;
        font-weight: 500;
    }

    .pro-sat-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        border-top: 1px solid #f3f4f6;
    }

    .pro-sat-category {
        font-size: 13px;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .pro-sat-category.excellent {
        background: #d1fae5;
        color: #065f46;
    }

    .pro-sat-category.good {
        background: #dbeafe;
        color: #1e40af;
    }

    .pro-sat-category.average {
        background: #fef3c7;
        color: #92400e;
    }

    .pro-sat-category.poor {
        background: #fee2e2;
        color: #991b1b;
    }

    .pro-sat-responses {
        font-size: 13px;
        color: #6b7280;
        font-weight: 500;
    }

    /* Professional Question Breakdown */
    .professional-question-breakdown {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .pro-breakdown-item {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        transition: all 0.2s ease;
    }

    .pro-breakdown-item:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateX(4px);
    }

    .breakdown-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .breakdown-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .breakdown-number {
        font-size: 12px;
        font-weight: 700;
        color: #6b7280;
        background: #f3f4f6;
        padding: 4px 10px;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .breakdown-text {
        font-size: 14px;
        color: #374151;
        font-weight: 500;
        line-height: 1.4;
    }

    .breakdown-score {
        font-size: 22px;
        font-weight: 800;
        flex-shrink: 0;
    }

    .breakdown-progress {
        margin-bottom: 12px;
    }

    .breakdown-track {
        height: 8px;
        background: #f3f4f6;
        border-radius: 10px;
        overflow: hidden;
    }

    .breakdown-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.6s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .breakdown-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .breakdown-badge {
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .breakdown-badge.excellent {
        background: #d1fae5;
        color: #065f46;
    }

    .breakdown-badge.good {
        background: #dbeafe;
        color: #1e40af;
    }

    .breakdown-badge.average {
        background: #fef3c7;
        color: #92400e;
    }

    .breakdown-badge.poor {
        background: #fee2e2;
        color: #991b1b;
    }

    .breakdown-count {
        font-size: 12px;
        color: #6b7280;
        font-weight: 500;
    }

    /* Question Performance */
    .question-bars {
        display: flex;
        gap: 16px;
        margin-top: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    /* Professional Question Performance */
    .professional-question-performance {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    .pro-question-item {
        background: #fff;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .pro-question-item:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }

    .pro-question-item.selected {
        border-color: #3b82f6;
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.2);
        background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }

    .pro-question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .pro-question-number {
        font-size: 14px;
        font-weight: 700;
        color: #6b7280;
        background: #f3f4f6;
        padding: 4px 12px;
        border-radius: 6px;
        letter-spacing: 0.5px;
    }

    .pro-question-score {
        font-size: 24px;
        font-weight: 800;
        letter-spacing: -0.5px;
    }

    .pro-question-title {
        font-size: 14px;
        color: #374151;
        margin-bottom: 16px;
        line-height: 1.5;
        font-weight: 500;
        min-height: 42px;
    }

    .pro-progress-container {
        width: 100%;
        height: 8px;
        background: #f3f4f6;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 12px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    .pro-progress-bar {
        height: 100%;
        border-radius: 10px;
        transition: width 0.6s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .pro-question-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
    }

    .pro-question-category {
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 10px;
    }

    .pro-question-category.excellent {
        background: #d1fae5;
        color: #065f46;
    }

    .pro-question-category.good {
        background: #dbeafe;
        color: #1e40af;
    }

    .pro-question-category.average {
        background: #fef3c7;
        color: #92400e;
    }

    .pro-question-category.poor {
        background: #fee2e2;
        color: #991b1b;
    }

    .pro-question-percentage {
        font-weight: 600;
        color: #6b7280;
    }

    .question-bar-item {
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .question-bar {
        width: 60px;
        max-height: 200px;
        min-height: 20px;
        border-radius: 30px 30px 4px 4px;
        position: relative;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        transition: all 0.4s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .question-bar.excellent { background: linear-gradient(180deg, #28a745, #20c997); }
    .question-bar.good { background: linear-gradient(180deg, #17a2b8, #20c997); }
    .question-bar.average { background: linear-gradient(180deg, #ffc107, #ffcd39); }
    .question-bar.poor { background: linear-gradient(180deg, #dc3545, #e55a5a); }

    .question-bar-item:hover .question-bar, .question-bar-item.selected .question-bar {
        transform: scale(1.1);
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .bar-value {
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        padding: 4px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .question-label {
        text-align: center;
        margin-top: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .point-tooltip, .question-tooltip {
        background: #212529;
        color: #fff;
        border-radius: 10px;
        font-size: 1rem;
        box-shadow: 0 4px 24px rgba(0,0,0,0.18);
        border: none;
        padding: 12px 18px;
    }

    .question-tooltip {
        position: absolute;
        top: -48px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.92);
        color: #fff;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        z-index: 10;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .question-bar-item:hover .question-tooltip {
        opacity: 1;
    }


    .tooltip-stats {
        margin-top: 4px;
        font-size: 0.7rem;
        opacity: 0.8;
    }

    .interactive-line-chart {
        position: relative;
        height: 350px;
        margin: 20px 0;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        overflow: hidden;
    }

    .chart-point {
        position: absolute;
        transform: translateX(-50%);
        cursor: pointer;
        z-index: 5;
    }

    .point {
        width: 14px;
        height: 14px;
        background: #374151;
        border: 3px solid white;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .point:hover, .point.selected {
        transform: scale(1.2);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        background: #374151;
    }

    .chart-point.hovered .point {
        transform: scale(1.2);
        transition: transform 0.3s ease;
    }

    .point-tooltip {
        position: absolute;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%) scale(0.95);
        background: #111827;
        color: #fff;
        padding: 16px 22px;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        z-index: 20;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.08);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s, transform 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .data-point:hover .point-tooltip,
    .data-point.selected .point-tooltip {
        opacity: 1;
        transform: translateX(-50%) scale(1.05);
    }

    .point-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 10px solid transparent;
        border-top-color: #111827;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
    }

    .point-tooltip .tooltip-header {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .point-tooltip .score-badge {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-left: 6px;
    }

    .point-tooltip .tooltip-period {
        color: #e0e0e0;
        font-size: 0.95rem;
        margin-bottom: 4px;
    }

    .point-tooltip .tooltip-details {
        font-size: 0.9rem;
        color: #f8f9fa;
        margin-top: 2px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: center;
    }

    .point-tooltip .recent-indicator {
        color: #ffc107 !important;
        font-weight: 700;
        font-size: 0.95rem;
        margin-top: 2px;
    }

    .sector-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .enhanced-sector-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        border: 1px solid #e5e7eb;
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .enhanced-sector-card:hover, .enhanced-sector-card.selected {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-color: #d1d5db;
    }

    .sector-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .sector-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sector-icon-large {
        font-size: 1.8rem;
    }

    .sector-title h4 {
        margin: 0;
        color: #333;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .expand-icon {
        font-size: 1.5rem;
        color: #999;
        transition: transform 0.3s ease;
    }

    .expand-icon.expanded {
        transform: rotate(180deg);
    }

    .sector-quick-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
    }

    .quick-stat {
        text-align: center;
    }

    .stat-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        background: conic-gradient(var(--color) var(--fill), #e9ecef var(--fill));
        position: relative;
    }

    .stat-circle::before {
        content: '';
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        background: white;
    }

    .stat-circle span {
        font-weight: 700;
        color: #333;
        font-size: 1rem;
        position: relative;
        z-index: 1;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 8px;
        display: block;
    }

    .quick-stat label {
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
    }

    .sector-expanded-content {
        opacity: 1;
        max-height: 500px;
        transition: opacity 0.4s ease, max-height 0.4s ease;
        border-top: 1px solid #e9ecef;
        padding-top: 20px;
        margin-top: 20px;
    }

    .trend-indicators {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }

    .trend-item {
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .trend-label {
        font-size: 0.8rem;
        color: #666;
        display: block;
        margin-bottom: 4px;
    }

    .trend-value {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .mini-bars-interactive {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 12px;
    }

    .mini-bar-interactive {
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .mini-bar-interactive:hover {
        transform: translateY(-2px);
    }

    .mini-bar-container {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .mini-bar-bg {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        flex: 1;
    }

    .mini-bar-fill {
        position: absolute;
        height: 8px;
        border-radius: 4px;
        transition: width 0.8s ease;
        left: 20px;
        right: 0;
    }

    .mini-bar-fill.excellent { background: #28a745; }
    .mini-bar-fill.good { background: #17a2b8; }
    .mini-bar-fill.average { background: #ffc107; }
    .mini-bar-fill.poor { background: #dc3545; }

    .mini-bar-label {
        font-size: 0.8rem;
        color: #666;
        min-width: 20px;
        font-weight: 500;
    }

    .mini-bar-tooltip {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
        z-index: 10;
    }

    .sector-table {
        margin-top: 20px;
        overflow-x: auto;
    }

    .interactive-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .interactive-table th {
        background: #f3f4f6;
        color: #374151;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
        user-select: none;
        position: relative;
    }

    .interactive-table th:hover {
        background: #e5e7eb;
    }

    .table-row {
        transition: all 0.2s ease;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
    }

    .table-row:hover, .table-row.selected {
        background: rgba(0,123,255,0.05);
        transform: scale(1.01);
    }

    .table-row td {
        padding: 16px 12px;
        color: #333;
    }

    .table-sector {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .table-sector-icon {
        font-size: 1.1rem;
    }

    .response-count {
        background: #e5e7eb;
        color: #374151;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
        border: 1px solid #d1d5db;
    }

    .responses-table th, .responses-table td {
        font-size: 1rem;
        padding: 16px 14px;
    }

    .score-cell {
        font-weight: 600;
        color: #333;
        padding: 6px 12px;
        border-radius: 8px;
        background: #f3f4f6;
    }

    .loading-spinner {
        text-align: center;
        padding: 80px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    .no-data {
        text-align: center;
        padding: 80px;
        color: #666;
        font-size: 1.2rem;
    }

    .dashboard-responsive {
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .sector-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    html {
        scroll-behavior: smooth;
    }

    .navigation-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .navigation-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        cursor: pointer;
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e5e7eb;
        position: relative;
        overflow: hidden;
    }

    .navigation-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-color: #d1d5db;
    }

    .navigation-card .card-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        text-align: center;
    }

    .navigation-card h4 {
        text-align: center;
        margin: 0 0 16px 0;
        color: #333;
        font-size: 1.4rem;
        font-weight: 600;
    }

    .navigation-card .card-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 16px;
    }

    .navigation-card .stat-item {
        text-align: center;
    }

    .navigation-card .stat-number {
        display: block;
        font-size: 1.8rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 4px;
    }

    .navigation-card .stat-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
    }

    .navigation-card .card-meta {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

    .navigation-card .card-arrow {
        text-align: center;
        font-size: 2rem;
        color: #6b7280;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .navigation-card:hover .card-arrow {
        opacity: 1;
        transform: translateX(8px);
        color: #28a745;
    }

    /* Detailed Analysis */
    .detailed-analysis-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        margin-top: 20px;
    }

    .analysis-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e9ecef;
    }

    .project-info h4 {
        color: #007bff;
        margin: 0 0 12px 0;
        font-size: 1.6rem;
    }

    .project-info p {
        margin: 4px 0;
        color: #666;
    }

    .question-analysis-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .question-analysis-item {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 12px;
        border-left: 4px solid #007bff;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .question-number {
        font-weight: 600;
        color: #007bff;
        font-size: 1.1rem;
    }

    .question-score {
        font-weight: 700;
        font-size: 1.2rem;
        padding: 4px 8px;
        border-radius: 6px;
        color: white;
    }

    .question-score.excellent { background: #28a745; }
    .question-score.good { background: #17a2b8; }
    .question-score.average { background: #ffc107; color: #333; }
    .question-score.poor { background: #dc3545; }

    .question-text {
        margin-bottom: 12px;
        font-size: 0.9rem;
        color: #555;
        font-weight: 500;
    }

    .question-bar-container {
        position: relative;
        height: 8px;
        background: #dee2e6;
        border-radius: 4px;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .question-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.8s ease;
    }

    .question-bar-fill.excellent { background: #28a745; }
    .question-bar-fill.good { background: #17a2b8; }
    .question-bar-fill.average { background: #ffc107; }
    .question-bar-fill.poor { background: #dc3545; }

    .question-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #666;
    }

    .responses-table {
        margin-top: 16px;
    }

    .responses-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .responses-table th,
    .responses-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .responses-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .responses-table tr:hover {
        background-color: #f8f9fa;
    }

    .responses-table code {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Poppins', sans-serif !important;
        font-size: 0.9rem;
    }

    .responses-table .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .bg-success { background-color: #28a745 !important; color: white; }
    .bg-info { background-color: #17a2b8 !important; color: white; }
    .bg-warning { background-color: #ffc107 !important; color: #333; }
    .bg-danger { background-color: #dc3545 !important; color: white; }

    .trends-container {
        margin-top: 20px;
    }

    .trend-summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
    }

    .trend-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        text-align: center;
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e5e7eb;
    }

    .trend-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-color: #d1d5db;
    }

    .trend-icon {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .trend-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: #111827;
    }

    .trend-value.positive {
        color: #28a745;
    }

    .trend-value.negative {
        color: #dc3545;
    }

    .trend-value.neutral {
        color: #6c757d;
    }

    .trend-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .trend-period {
        font-size: 0.8rem;
        color: #666;
    }

    .simple-trend-chart {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }

    .visual-trend-chart {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }

    .line-chart-container {
        margin-top: 20px;
        position: relative;
        background: #fff;
        border-radius: 12px;
        padding: 20px 20px 60px 20px; /* Extra bottom padding for rotated labels */
        border: 1px solid #e5e7eb;
    }

    .chart-grid {
        display: flex;
        height: 300px;
        position: relative;
    }

    .y-axis {
        width: 40px;
        position: relative;
        border-right: 2px solid #333;
        margin-right: 10px;
    }

    .y-label {
        position: absolute;
        right: 50px;
        transform: translateY(50%);
        font-size: 0.9rem;
        font-weight: 600;
        color: #666;
        background: white;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }

    .chart-area {
        flex: 1;
        position: relative;
        border-bottom: 2px solid #333;
        margin-left: 10px;
    }

    .grid-lines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .grid-line-horizontal {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
        background: #e9ecef;
        opacity: 0.7;
    }

    .line-chart-content {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .trend-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        text-align: center;
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e5e7eb;
    }
    }

    .trend-line {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, #007bff, #28a745, #007bff);
        height: 3px;
        border-radius: 2px;
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        z-index: 1;
    }

    .data-point {
        position: absolute;
        transform: translate(-50%, 50%);
        z-index: 2;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .data-point:hover {
        transform: translate(-50%, 50%) scale(1.2);
        z-index: 10;
    }

    .data-point.selected {
        transform: translate(-50%, 50%) scale(1.3);
        z-index: 10;
    }

    .point-circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid white;
        position: relative;
        box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .data-point.excellent .point-circle {
        background: #28a745;
        border-color: #1e7e34;
    }

    .data-point.good .point-circle {
        background: #17a2b8;
        border-color: #117a8b;
    }

    .data-point.average .point-circle {
        background: #ffc107;
        border-color: #d39e00;
    }

    .data-point.poor .point-circle {
        background: #dc3545;
        border-color: #bd2130;
    }

    .data-point.recent .point-circle {
        border-width: 4px;
        border-color: #007bff;
        box-shadow: 0 3px 12px rgba(0,0,0,0.2), 0 0 0 4px rgba(0,123,255,0.3);
    }

    .data-point.no-data .point-circle,
    .data-point.empty .point-circle {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        color: #6c757d;
        box-shadow: none;
    }

    .data-point.no-data .point-circle.empty,
    .data-point.empty .point-circle.empty {
        background: transparent;
        border: 1px dashed #ced4da;
    }

    .data-point.no-data:hover .point-circle,
    .data-point.empty:hover .point-circle {
        border-color: #adb5bd;
        background: #e9ecef;
    }

    .point-value {
        font-size: 0.7rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        position: absolute;
        white-space: nowrap;
    }

    .point-tooltip {
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.85rem;
        white-space: nowrap;
        z-index: 20;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .point-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0,0,0,0.9);
    }

    .tooltip-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .tooltip-header strong {
        font-size: 1.1rem;
        color: #fff;
    }

    .score-badge {
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .score-badge.excellent {
        background: #28a745;
        color: white;
    }

    .score-badge.good {
        background: #17a2b8;
        color: white;
    }

    .score-badge.average {
        background: #ffc107;
        color: #333;
    }

    .score-badge.poor {
        background: #dc3545;
        color: white;
    }

    .score-badge.no-data {
        background: #6c757d;
        color: white;
    }

    .tooltip-period {
        color: #ccc;
        margin-bottom: 6px;
        font-size: 0.8rem;
    }

    .tooltip-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.75rem;
        color: #ddd;
    }

    .recent-indicator {
        color: #ffc107 !important;
        font-weight: 600;
    }

    .forecast-line {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, #6f42c1, #e83e8c, #6f42c1);
        height: 3px;
        border-radius: 2px;
        box-shadow: 0 2px 8px rgba(111,66,193,0.4);
        z-index: 1;
        border: 1px dashed rgba(111,66,193,0.3);
    }

    .forecast-confidence-area {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.15;
        background: linear-gradient(to bottom, #6f42c1, transparent);
        border-radius: 4px 4px 0 0;
        z-index: 0;
    }
    
    /* New SVG-based forecast styling */
    .forecast-svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
    }
    
    .forecast-path {
        filter: drop-shadow(0 2px 4px rgba(103, 58, 183, 0.3));
    }
    
    .confidence-area {
        opacity: 0.15;
    }

    .forecast-point {
        position: absolute;
        transform: translate(-50%, 50%);
        z-index: 2;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .forecast-point:hover {
        transform: translate(-50%, 50%) scale(1.2);
        z-index: 10;
    }

    .forecast-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #6f42c1;
        border: 3px solid white;
        box-shadow: 0 3px 12px rgba(111,66,193,0.3);
        transition: all 0.3s ease;
        position: relative;
    }

    .forecast-tooltip {
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(111,66,193,0.95);
        color: white;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 0.85rem;
        white-space: nowrap;
        z-index: 20;
        box-shadow: 0 6px 24px rgba(111,66,193,0.4);
        border: 1px solid rgba(255,255,255,0.2);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        pointer-events: none;
    }
    
    .forecast-tooltip.visible {
        opacity: 1;
        visibility: visible;
    }
    
    .tooltip-score {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 4px 0;
    }
    
    .tooltip-confidence {
        font-size: 0.75rem;
        opacity: 0.85;
    }

    .forecast-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 4px solid transparent;
        border-top-color: rgba(111,66,193,0.95);
    }

    .loading-forecast {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .no-forecast-data {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        font-style: italic;
    }

    .forecast-insights {
        margin-top: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        border-left: 4px solid #6f42c1;
    }

    .database-analysis-content {
        line-height: 1.6;
        color: #495057;
    }

    .database-analysis-content p {
        margin: 0 0 12px 0;
        text-align: justify;
    }

    .x-axis {
        position: absolute;
        bottom: -35px;
        left: 0;
        right: 0;
        height: 30px;
    }

    /* Add more space when labels are rotated */
    .x-axis.medium-labels {
        bottom: -45px;
        height: 40px;
    }

    .x-axis.many-labels {
        bottom: -50px;
        height: 45px;
    }

    .x-label {
        position: absolute;
        transform: translateX(-50%);
        font-size: 0.75rem;
        color: #666;
        font-weight: 500;
        background: white;
        padding: 2px 4px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
        white-space: nowrap;
        z-index: 10;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .x-label:hover {
        background: #f8f9fa;
        color: #333;
        z-index: 20;
        transform: translateX(-50%) scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Styles for medium number of labels (6-12) */
    .x-axis.medium-labels .x-label {
        font-size: 0.7rem;
        transform: translateX(-50%) rotate(-30deg);
        transform-origin: center bottom;
        margin-top: 6px;
        padding: 1px 3px;
    }

    .x-axis.medium-labels .x-label:hover {
        transform: translateX(-50%) rotate(-30deg) scale(1.1);
    }

    /* Styles for many labels (12+) */
    .x-axis.many-labels .x-label {
        font-size: 0.55rem !important;
        transform: translateX(-50%) rotate(-90deg) !important;
        transform-origin: center bottom !important;
        margin-top: 15px !important;
        padding: 1px 2px !important;
        background: red !important; /* Temporary debug color */
        color: white !important;
        z-index: 1000 !important;
        display: block !important;
        visibility: visible !important;
    }

    .x-axis.many-labels .x-label:hover {
        transform: translateX(-50%) rotate(-90deg) scale(1.1) !important;
        background: darkred !important;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: #666;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .legend-dot.excellent {
        background: #28a745;
    }

    .legend-dot.good {
        background: #17a2b8;
    }

    .legend-dot.average {
        background: #ffc107;
    }

    .legend-dot.poor {
        background: #dc3545;
    }

    .legend-dot.recent {
        background: #007bff;
        border-color: #0056b3;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.3);
    }

    .recent-legend {
        font-weight: 600;
        color: #007bff;
    }

    .trend-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e9ecef;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .chart-range {
        font-size: 0.9rem;
        color: #666;
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 8px;
    }

    .trend-bars-container {
        display: flex;
        gap: 8px;
        align-items: end;
        min-height: 200px;
        padding: 20px 0;
        overflow-x: auto;
    }

    .trend-bar-item {
        flex: 1;
        min-width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .trend-bar-item:hover, .trend-bar-item.selected {
        transform: scale(1.05);
    }

    .trend-bar {
        width: 100%;
        max-width: 40px;
        min-height: 20px;
        border-radius: 8px 8px 4px 4px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 4px;
        position: relative;
        transition: all 0.4s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .trend-bar.excellent {
        background: linear-gradient(180deg, #28a745, #20c997);
        border-left: 3px solid #1e7e34;
    }

    .trend-bar.good {
        background: linear-gradient(180deg, #17a2b8, #20c997);
        border-left: 3px solid #117a8b;
    }

    .trend-bar.average {
        background: linear-gradient(180deg, #ffc107, #ffcd39);
        border-left: 3px solid #d39e00;
    }

    .trend-bar.poor {
        background: linear-gradient(180deg, #dc3545, #e55a5a);
        border-left: 3px solid #bd2130;
    }

    .trend-bar.recent {
        border: 2px solid #007bff;
        box-shadow: 0 4px 16px rgba(0,123,255,0.3);
    }

    .trend-bar-value {
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        margin-bottom: 2px;
    }

    .trend-bar-label {
        font-size: 0.75rem;
        color: #666;
        font-weight: 500;
        margin-top: 8px;
        text-align: center;
        transform: rotate(-45deg);
        transform-origin: center;
        white-space: nowrap;
    }

    .trend-tooltip-simple {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 8px;
        text-align: center;
    }

    .trend-tooltip-simple::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0,0,0,0.9);
    }

    .trend-insights {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #17a2b8;
        margin-bottom: 20px;
    }

    .insight-item {
        margin-bottom: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .insight-item:last-child {
        margin-bottom: 0;
    }

    .insight-item strong {
        color: #333;
        margin-right: 8px;
    }

    .insight-item span {
        color: #666;
    }

    .no-trend-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.1rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
    }

    .clients-overview {
        margin-top: 20px;
    }

    .client-summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .client-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        transition: border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid #e5e7eb;
    }

    .client-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        border-color: #d1d5db;
    }

    .client-card.total-clients {
        border-left-color: #007bff;
    }

    .client-card.new-clients {
        border-left-color: #28a745;
    }

    .client-card.repeated-clients {
        border-left-color: #17a2b8;
    }

    .client-card.retention-rate {
        border-left-color: #ffc107;
    }

    .client-card .card-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
        opacity: 0.8;
    }

    .client-value {
        font-size: 2.2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
    }

    .client-label {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .client-sublabel {
        font-size: 0.85rem;
        color: #666;
        opacity: 0.8;
    }

    .client-trend-container {
        background: #f8f9fa;
        padding: 24px;
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .client-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .client-chart-header h5 {
        margin: 0;
        color: #333;
        font-size: 1.2rem;
    }

    .client-bars-container {
        display: flex;
        gap: 16px;
        align-items: end;
        min-height: 200px;
        padding: 20px 0;
        overflow-x: auto;
        justify-content: center;
    }

    .client-bar-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        min-width: 80px;
    }

    .client-bar-group:hover {
        transform: scale(1.05);
    }

    .client-stacked-bar {
        width: 50px;
        min-height: 20px;
        border-radius: 6px 6px 0 0;
        position: relative;
        transition: all 0.4s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        margin-bottom: 8px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
    }

    .client-stacked-bar:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }

    .bar-segment {
        width: 100%;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        border-radius: inherit;
    }

    .new-segment {
        background: linear-gradient(180deg, #28a745, #20c997);
        border-top-left-radius: 6px;
        border-top-right-radius: 6px;
    }

    .repeated-segment {
        background: linear-gradient(180deg, #17a2b8, #138496);
    }

    .segment-value {
        color: white;
        font-weight: 700;
        font-size: 0.75rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        position: absolute;
        white-space: nowrap;
    }

    .bar-total-count {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .client-bar-group:hover .bar-total-count {
        opacity: 1;
    }

    .client-bar-label {
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
        text-align: center;
        margin-top: 8px;
    }

    .client-period-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 8px;
    }

    .client-period-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0,0,0,0.9);
    }

    .tooltip-header {
        font-weight: 600;
        margin-bottom: 8px;
        text-align: center;
    }

    .tooltip-stats {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .stat-row {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
    }

    .stat-icon {
        width: 16px;
    }

    .legend-dot.new-client {
        background: #28a745;
    }

    .legend-dot.repeated-client {
        background: #17a2b8;
    }

    .client-details-section {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        border: 1px solid #e5e7eb;
    }

    .client-details-section h5 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 1.2rem;
    }

    .client-filters {
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .client-table-container {
        overflow-x: auto;
    }

    .client-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .client-table th,
    .client-table td {
        padding: 12px;
        text-align: left;
        vertical-align: middle;
    }

    .client-table thead tr {
        height: 48px;
        border-bottom: 1px solid #dee2e6;
    }

    .client-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
        position: sticky;
        top: 0;
    }

    .client-row {
        transition: background-color 0.2s ease;
        height: 48px;
        border-bottom: 1px solid #dee2e6;
    }

    .client-row:hover {
        background-color: #f8f9fa;
    }

    .client-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .client-icon {
        opacity: 0.7;
    }

    .client-type-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .client-type-badge.new {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .client-type-badge.repeated {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .survey-count {
        font-weight: 600;
        color: #007bff;
    }

    .satisfaction-badge {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: white;
    }

    .satisfaction-badge.excellent {
        background-color: #28a745;
    }

    .satisfaction-badge.good {
        background-color: #17a2b8;
    }

    .satisfaction-badge.average {
        background-color: #ffc107;
        color: #333;
    }

    .satisfaction-badge.poor {
        background-color: #dc3545;
    }

    .no-client-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.1rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
    }
</style>

<!--
.goal-line {
    z-index: 3;
    border-radius: 3px;
    width: 4px !important;
    background: #00e676 !important;
    box-shadow: 0 0 10px 2px #00e676, 0 0 2px 1px #fff;
    opacity: 1 !important;
} -->

@code {
    List<SurveyResponse> surveyResponses = new List<SurveyResponse>();
    bool isLoading = true;
    Dictionary<string, int> sectorCounts = new Dictionary<string, int>();
    Dictionary<string, int> companySizeCounts = new Dictionary<string, int>();
    Dictionary<string, double> sectorAverages = new Dictionary<string, double>();
    Dictionary<string, double> companySizeAverages = new Dictionary<string, double>();
    double avgSatisfaction = 0;
    
    private string aiView = "insights";
    private bool isLoadingAI = false;
    private AIInsights? currentAIInsights;
    private AIRecommendations? currentAIRecommendations;
    private AIPredictions? currentAIPredictions;
    
    // Chat
    private List<ChatMessage> chatHistory = new();
    private string chatInput = "";
    private bool isProcessingChat = false;
    
    // Trend insights
    private string? aiTrendAnalysis;
    private string? aiServiceQualityInsight;
    private bool isLoadingTrendInsights = false;
    
    // AI Predictions
    private List<ForecastDataPoint>? forecastData;
    private string? databaseAnalysis;
    private bool isLoadingForecast = false;
    private bool isLoadingDatabaseAnalysis = false;
    private int hoveredForecastPoint = -1;
    
    public class ChatMessage
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
    }

    public class ForecastDataPoint
    {
        public DateTime Date { get; set; }
        public double PredictedScore { get; set; }
        public double ConfidenceInterval { get; set; }
        public string Period { get; set; } = string.Empty;
    }

    string selectedSectorFilter = "all";
    string selectedCompanySizeFilter = "all";
    string chartView = "count";
    string detailView = "cards";
    string? selectedSector = null;
    string? selectedTableRow = null;
    string? hoveredSector = null;
    string? hoveredMiniBar = null;
    int? selectedQuestion = null;
    int? hoveredPoint = null;
    
    // Trends
    string trendsView = "monthly";
    string trendTimeView = "monthly"; // monthly, quarterly, yearly
    int trendSelectedYear = DateTime.Now.Year;
    string selectedTrendsYear = DateTime.Now.Year.ToString(); // Default to current year
    int? selectedTrendPoint = null;
    
    // Client analytics
    string clientView = "yearly";
    string? selectedClientPeriod = null;
    string selectedClientFilter = "all";
    string selectedClientYear = "all";
    string selectedClientMonth = "all";
    
    string? selectedCustomer = null;
    string? selectedProject = null;
    string currentNavigationLevel = "sectors";
    
    HashSet<string> expandedSectors = new HashSet<string>();
    HashSet<string> expandedSectorCards = new HashSet<string>();
    
    string sortColumn = "sector";
    bool sortAscending = true;
    
    string userRole = "";

    DateTime? GetLastUpdatedDate()
    {
        var dates = surveyResponses
            .SelectMany(r => new[] { r.DateCompleted, r.DateSent })
            .Where(d => d.HasValue)
            .Select(d => d.Value)
            .ToList();

        return dates.Any() ? dates.Max() : (DateTime?)null;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity.IsAuthenticated)
        {
            var roleClaim = authState.User.FindFirst("Role");
            userRole = roleClaim?.Value ?? "";
            
            // Auto-navigate non-admin users to their sector
            if (userRole != "Admin" && (userRole == "Health" || userRole == "Tech" || userRole == "Energy"))
            {
                selectedSector = userRole;
                currentNavigationLevel = "customers";
            }
        }
        
        await LoadSurveyData();
        InitializeAIState();
    }

    async Task LoadSurveyData()
    {
        isLoading = true;
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<SurveyResponse>>("api/survey/responses");
            surveyResponses = response ?? new List<SurveyResponse>();
            
            CalculateStatistics();
            
            await LoadTrendInsights();
            await LoadForecastData();
            await LoadDatabaseAnalysis();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading survey data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    // AI Methods
    private void SetAIView(string view)
    {
        aiView = view;
        StateHasChanged();
    }
    
    private async Task LoadAIAnalysis()
    {
        isLoadingAI = true;
        StateHasChanged();
        
        try
        {
            using var client = new HttpClient();
            client.BaseAddress = new Uri("http://localhost:5123/");
            
            var insightsResponse = await client.GetFromJsonAsync<AIInsights>("api/ai/insights");
            currentAIInsights = insightsResponse;
            
            var recommendationsResponse = await client.GetFromJsonAsync<AIRecommendations>("api/ai/recommendations");
            currentAIRecommendations = recommendationsResponse;
            
            var predictionsResponse = await client.GetFromJsonAsync<AIPredictions>("api/ai/predictions");
            currentAIPredictions = predictionsResponse;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"AI Analysis error: {ex.Message}");
        }
        finally
        {
            isLoadingAI = false;
            StateHasChanged();
        }
    }
    
    private async Task RefreshAIAnalysis()
    {
        await LoadAIAnalysis();
    }
    
    private void InitializeAIState()
    {
        currentAIInsights = null;
        currentAIRecommendations = null;
        currentAIPredictions = null;
        chatHistory = new List<ChatMessage>
        {
            new ChatMessage
            {
                Text = "üëã Hi! I'm your AI assistant. I can help analyze your survey data, provide insights, and answer questions. Try asking me something like 'What sectors have the lowest satisfaction?' or click 'Refresh AI Analysis' to get started!",
                IsUser = false,
                Timestamp = DateTime.Now
            }
        };
    }
    
    private async Task LoadTrendInsights()
    {
        if (isLoadingTrendInsights) return;
        
        isLoadingTrendInsights = true;
        StateHasChanged();
        
        try
        {
            using var client = new HttpClient();
            client.BaseAddress = new Uri("http://localhost:5123/");
            
            // Load trend analysis from AI
            var trendTask = client.GetStringAsync("api/ai/trend-analysis");
            
            // Load service quality insight from AI
            var qualityTask = client.GetStringAsync("api/ai/service-quality");
            
            await Task.WhenAll(trendTask, qualityTask);
            
            aiTrendAnalysis = await trendTask;
            aiServiceQualityInsight = await qualityTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading trend insights: {ex.Message}");
            aiTrendAnalysis = "Unable to load AI trend analysis at this time.";
            aiServiceQualityInsight = "Unable to load AI service quality insight at this time.";
        }
        finally
        {
            isLoadingTrendInsights = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadForecastData()
    {
        if (isLoadingForecast) return;
        
        isLoadingForecast = true;
        StateHasChanged();
        
        try
        {
            using var client = new HttpClient();
            client.BaseAddress = new Uri("http://localhost:5123/");
            
            var response = await client.GetFromJsonAsync<List<ForecastDataPoint>>("api/ai/forecast?monthsAhead=6");
            forecastData = response ?? new List<ForecastDataPoint>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading forecast data: {ex.Message}");
            forecastData = new List<ForecastDataPoint>();
        }
        finally
        {
            isLoadingForecast = false;
            StateHasChanged();
        }
    }
    
    private async Task LoadDatabaseAnalysis()
    {
        if (isLoadingDatabaseAnalysis) return;
        
        isLoadingDatabaseAnalysis = true;
        StateHasChanged();
        
        try
        {
            using var client = new HttpClient();
            client.BaseAddress = new Uri("http://localhost:5123/");
            
            databaseAnalysis = await client.GetStringAsync("api/ai/database-analysis");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading database analysis: {ex.Message}");
            databaseAnalysis = "Unable to load comprehensive database analysis at this time.";
        }
        finally
        {
            isLoadingDatabaseAnalysis = false;
            StateHasChanged();
        }
    }
    
    private async Task SendChatMessage()
    {
        if (string.IsNullOrWhiteSpace(chatInput)) return;
        
        var userMessage = new ChatMessage
        {
            Text = chatInput,
            IsUser = true,
            Timestamp = DateTime.Now
        };
        
        chatHistory.Add(userMessage);
        var queryText = chatInput;
        chatInput = "";
        isProcessingChat = true;
        StateHasChanged();
        
        try
        {
            using var client = new HttpClient();
            client.BaseAddress = new Uri("http://localhost:5123/");
            
            var query = new ChatQuery { Query = queryText };
            var response = await client.PostAsJsonAsync("api/ai/chat", query);
            var chatResponse = await response.Content.ReadFromJsonAsync<ChatResponse>();
            
            var aiMessage = new ChatMessage
            {
                Text = chatResponse?.Response ?? "Sorry, I couldn't process your request.",
                IsUser = false,
                Timestamp = DateTime.Now
            };
            
            chatHistory.Add(aiMessage);
        }
        catch (Exception ex)
        {
            var errorMessage = new ChatMessage
            {
                Text = "Sorry, I'm having trouble processing your request right now.",
                IsUser = false,
                Timestamp = DateTime.Now
            };
            chatHistory.Add(errorMessage);
        }
        finally
        {
            isProcessingChat = false;
            StateHasChanged();
        }
    }
    
    private async Task HandleChatKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendChatMessage();
        }
    }
    
    // AI Helper Methods
    private string GetSentimentIcon(string sentiment)
    {
        return sentiment.ToLower() switch
        {
            "positive" => "üòä",
            "negative" => "üòü",
            "neutral" => "üòê",
            _ => "ü§î"
        };
    }
    
    private string GetTrendClass(string trend)
    {
        return trend.ToLower() switch
        {
            "upward" => "trend-up",
            "downward" => "trend-down",
            "stable" => "trend-stable",
            _ => "trend-neutral"
        };
    }
    
    private string GetTrendIcon(string trend)
    {
        return trend.ToLower() switch
        {
            "upward" => "üìà",
            "downward" => "üìâ", 
            "stable" => "‚û°Ô∏è",
            _ => "‚ùì"
        };
    }

    void CalculateStatistics()
    {
        if (!surveyResponses.Any()) return;

        // Calculate sector counts
        sectorCounts = surveyResponses
            .GroupBy(r => r.Sector)
            .ToDictionary(g => g.Key, g => g.Count());

        // Calculate company size counts
        companySizeCounts = surveyResponses
            .Where(r => !string.IsNullOrEmpty(r.CompanySize))
            .GroupBy(r => r.CompanySize)
            .ToDictionary(g => g.Key, g => g.Count());

        // Calculate sector averages for overall satisfaction
        sectorAverages = surveyResponses
            .GroupBy(r => r.Sector)
            .ToDictionary(g => g.Key, g => g.Average(r => r.Question1));

        // Calculate company size averages for overall satisfaction
        companySizeAverages = surveyResponses
            .Where(r => !string.IsNullOrEmpty(r.CompanySize))
            .GroupBy(r => r.CompanySize)
            .ToDictionary(g => g.Key, g => g.Average(r => r.Question1));

        // Calculate overall average satisfaction
        avgSatisfaction = surveyResponses.Average(r => r.Question1);
    }

    List<string> GetUniqueSectors()
    {
        return surveyResponses
            .Select(r => r.Sector)
            .Where(s => !string.IsNullOrEmpty(s))
            .Distinct()
            .OrderBy(s => s)
            .ToList();
    }

    List<string> GetUniqueCompanySizes()
    {
        return surveyResponses
            .Select(r => r.CompanySize)
            .Where(s => !string.IsNullOrEmpty(s))
            .Distinct()
            .OrderBy(s => s)
            .ToList();
    }

    void SetFilter(string filter)
    {
        StateHasChanged();
    }
    void SetChartView(string view)
    {
        chartView = view;
        StateHasChanged();
    }

    void SetDetailView(string view)
    {
        detailView = view;
        StateHasChanged();
    }

    void SetTrendsView(string view)
    {
        trendsView = view;
        selectedTrendPoint = null;
        StateHasChanged();
    }

    void OnTrendsYearChanged()
    {
        selectedTrendPoint = null;
        StateHasChanged();
    }

    List<int> GetAvailableYears()
    {
        var years = surveyResponses
            .Where(r => r.DateCompleted.HasValue)
            .Select(r => r.DateCompleted!.Value.Year)
            .Distinct()
            .OrderByDescending(y => y)
            .ToList();
        
        if (!years.Any()) years.Add(DateTime.Now.Year);
        
        return years;
    }

    void SelectSector(string sector)
    {
        selectedSector = selectedSector == sector ? null : sector;
        StateHasChanged();
    }

    void SelectTableRow(string sector)
    {
        selectedTableRow = selectedTableRow == sector ? null : sector;
        StateHasChanged();
    }

    void ToggleSectorDetails(string sector)
    {
        if (expandedSectors.Contains(sector))
            expandedSectors.Remove(sector);
        else
            expandedSectors.Add(sector);
        StateHasChanged();
    }

    void ToggleSectorCard(string sector)
    {
        if (expandedSectorCards.Contains(sector))
            expandedSectorCards.Remove(sector);
        else
            expandedSectorCards.Add(sector);
        StateHasChanged();
    }

    void NavigateToCustomers(string sector)
    {
        // Check roles for detailed analysis access
        if (userRole != "Admin")
        {
            var allowedSectors = GetRoleBasedSectors().Keys;
            if (!allowedSectors.Contains(sector))
            {
                // User doesn't have access to this sector in detailed analysis
                return; 
            }
        }
        
        selectedSector = sector;
        currentNavigationLevel = "customers";
        selectedCustomer = null;
        selectedProject = null;
        StateHasChanged();
    }

    void NavigateToProjects(string customer)
    {
        selectedCustomer = customer;
        currentNavigationLevel = "projects";
        selectedProject = null;
        StateHasChanged();
    }

    void NavigateToAnalysis(string project)
    {
        selectedProject = project;
        currentNavigationLevel = "analysis";
        StateHasChanged();
    }

    void NavigateBack()
    {
        if (currentNavigationLevel == "analysis")
        {
            currentNavigationLevel = "projects";
            selectedProject = null;
        }
        else if (currentNavigationLevel == "projects")
        {
            currentNavigationLevel = "customers";
            selectedCustomer = null;
        }
        else if (currentNavigationLevel == "customers")
        {
            // Only allow admin to go back to sectors
            if (userRole == "Admin")
            {
                currentNavigationLevel = "sectors";
                selectedSector = null;
            }
        }
        StateHasChanged();
    }

    bool ShouldShowBackButton()
    {
        // Never show back button on sectors level
        if (currentNavigationLevel == "sectors")
            return false;
        
        // Don't show back button on customers level for non-admin users
        if (currentNavigationLevel == "customers" && userRole != "Admin")
            return false;
        
        // Show back button for all other cases
        return true;
    }

    void ToggleQuestion(int question)
    {
        selectedQuestion = selectedQuestion == question ? null : question;
        StateHasChanged();
    }

    void SelectQuestionPoint(int question)
    {
        selectedQuestion = selectedQuestion == question ? null : question;
        StateHasChanged();
    }

    void SelectTrendPoint(int index)
    {
        selectedTrendPoint = selectedTrendPoint == index ? null : index;
        StateHasChanged();
    }

    void HandleLineChartClick()
    {
    }

    void ScrollToSection(string sectionId)
    {
        // Maybe I should add some javascript later???
        StateHasChanged();
    }

    void SortTable(string column)
    {
        if (sortColumn == column)
            sortAscending = !sortAscending;
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        StateHasChanged();
    }

    Dictionary<string, int> GetFilteredSectors()
    {
        return sectorCounts;
    }

    Dictionary<string, int> GetRoleBasedSectors()
    {
        if (userRole == "Admin")
            return sectorCounts;

        if (userRole == "Health")
            return sectorCounts.Where(kvp => kvp.Key == "Health").ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        else if (userRole == "Tech")
            return sectorCounts.Where(kvp => kvp.Key == "Tech").ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        else if (userRole == "Energy")
            return sectorCounts.Where(kvp => kvp.Key == "Energy").ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        
        return sectorCounts;
    }

    int GetCompletedCountForSector(string sector)
    {
        return surveyResponses.Count(r => r.Sector == sector && r.DateCompleted.HasValue);
    }

    int GetCompletedCountForCompanySize(string companySize)
    {
        return surveyResponses.Count(r => r.CompanySize == companySize && r.DateCompleted.HasValue);
    }

    Dictionary<string, int> GetFilteredCompanySizes()
    {
        return companySizeCounts;
    }

    double GetCompanySizeAverage(string companySize)
    {
        var responses = surveyResponses.Where(r => r.CompanySize == companySize).ToList();
        if (!responses.Any()) return 0;
        return responses.Average(r => r.Question1);
    }

    Dictionary<string, double> GetCombinedFilteredSatisfactionData()
    {
        var filteredResponses = GetCombinedFilteredResponses();
        
        var groupedData = new Dictionary<string, List<SurveyResponse>>();
        
        if (selectedSectorFilter != "all" && selectedCompanySizeFilter != "all")
        {
            var key = $"{selectedSectorFilter} - {selectedCompanySizeFilter}";
            groupedData[key] = filteredResponses.ToList();
        }
        else if (selectedSectorFilter != "all")
        {
            groupedData = filteredResponses
                .Where(r => !string.IsNullOrEmpty(r.CompanySize))
                .GroupBy(r => $"{selectedSectorFilter} - {r.CompanySize}")
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        else if (selectedCompanySizeFilter != "all")
        {
            groupedData = filteredResponses
                .Where(r => !string.IsNullOrEmpty(r.Sector))
                .GroupBy(r => $"{r.Sector} - {selectedCompanySizeFilter}")
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        else
        {
            groupedData = filteredResponses
                .Where(r => !string.IsNullOrEmpty(r.Sector))
                .GroupBy(r => r.Sector)
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        
        return groupedData
            .Where(kvp => kvp.Value.Any())
            .ToDictionary(kvp => kvp.Key, kvp => kvp.Value.Average(r => r.Question1));
    }

    List<SurveyResponse> GetCombinedFilteredResponses()
    {
        var responses = GetRoleBasedResponses();

        if (selectedSectorFilter != "all")
        {
            responses = responses.Where(r => r.Sector == selectedSectorFilter).ToList();
        }

        if (selectedCompanySizeFilter != "all")
        {
            responses = responses.Where(r => r.CompanySize == selectedCompanySizeFilter).ToList();
        }

        return responses;
    }

    List<SurveyResponse> GetRoleBasedResponses()
    {
        // Admin can see all responses
        if (userRole == "Admin")
            return surveyResponses;
        
        // Filter responses by user role
        if (userRole == "Health" || userRole == "Tech" || userRole == "Energy")
            return surveyResponses.Where(r => r.Sector == userRole).ToList();
        
        return surveyResponses;
    }

    List<string> GetCustomersForSector(string sector)
    {
        return GetRoleBasedResponses()
            .Where(r => r.Sector == sector)
            .Select(r => r.CustomerName)
            .Distinct()
            .OrderBy(c => c)
            .ToList();
    }

    List<string> GetProjectsForCustomer(string sector, string customer)
    {
        return GetRoleBasedResponses()
            .Where(r => r.Sector == sector && r.CustomerName == customer)
            .Select(r => r.ProjectName)
            .Distinct()
            .OrderBy(p => p)
            .ToList();
    }

    List<SurveyResponse> GetProjectResponses(string sector, string customer, string project)
    {
        return GetRoleBasedResponses()
            .Where(r => r.Sector == sector && r.CustomerName == customer && r.ProjectName == project)
            .ToList();
    }

    int GetQuestionScore(SurveyResponse response, int questionNumber)
    {
        return questionNumber switch
        {
            1 => response.Question1,
            2 => response.Question2,
            3 => response.Question3,
            4 => response.Question4,
            5 => response.Question5,
            6 => response.Question6,
            7 => response.Question7,
            8 => response.Question8,
            9 => response.Question9,
            _ => 0
        };
    }

    IEnumerable<string> GetSortedSectors()
    {
        var sectors = sectorCounts.Keys.AsEnumerable();
        
        sectors = sortColumn switch
        {
            "sector" => sortAscending ? sectors.OrderBy(s => s) : sectors.OrderByDescending(s => s),
            "responses" => sortAscending ? sectors.OrderBy(s => sectorCounts[s]) : sectors.OrderByDescending(s => sectorCounts[s]),
            "satisfaction" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "satisfaction")) : sectors.OrderByDescending(s => GetSectorAverage(s, "satisfaction")),
            "professionalism" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "professionalism")) : sectors.OrderByDescending(s => GetSectorAverage(s, "professionalism")),
            "growth" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "growth")) : sectors.OrderByDescending(s => GetSectorAverage(s, "growth")),
            "value" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "value")) : sectors.OrderByDescending(s => GetSectorAverage(s, "value")),
            "likelihood" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "likelihood")) : sectors.OrderByDescending(s => GetSectorAverage(s, "likelihood")),
            _ => sectors
        };
        
        return sectors;
    }

    string GetSortIcon(string column)
    {
        if (sortColumn != column) return "‚ÜïÔ∏è";
        return sortAscending ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
    }

    double GetSectorAverage(string sector, string type)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector);
        if (!sectorResponses.Any()) return 0;
        
        return type switch
        {
            "satisfaction" => sectorResponses.Average(r => r.Question1),
            "professionalism" => sectorResponses.Average(r => r.Question2),
            "growth" => sectorResponses.Average(r => r.Question3),
            "value" => sectorResponses.Average(r => r.Question4),
            "likelihood" => sectorResponses.Average(r => r.Question9),
            _ => 0
        };
    }

    int GetBestQuestion(string sector)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector).ToList();
        if (!sectorResponses.Any()) return 1;
        
        var averages = new Dictionary<int, double>();
        for (int q = 1; q <= 9; q++)
        {
            averages[q] = GetSectorQuestionAverage(sector, q);
        }
        
        return averages.OrderByDescending(kvp => kvp.Value).First().Key;
    }

    double GetBestQuestionScore(string sector)
    {
        return GetSectorQuestionAverage(sector, GetBestQuestion(sector));
    }

    int GetWorstQuestion(string sector)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector).ToList();
        if (!sectorResponses.Any()) return 1;
        
        var averages = new Dictionary<int, double>();
        for (int q = 1; q <= 9; q++)
        {
            averages[q] = GetSectorQuestionAverage(sector, q);
        }
        
        return averages.OrderBy(kvp => kvp.Value).First().Key;
    }

    double GetWorstQuestionScore(string sector)
    {
        return GetSectorQuestionAverage(sector, GetWorstQuestion(sector));
    }

    string GetSectorShortName(string sector)
    {
        return sector switch
        {
            "Tech & Digitalization" => "Tech",
            "Health" => "Health",
            "Energy" => "Energy",
            _ => sector
        };
    }

    Microsoft.AspNetCore.Components.MarkupString GetSectorIcon(string sector)
    {
        return sector switch
        {
            "Health" => new Microsoft.AspNetCore.Components.MarkupString("<img src=\"/images/healthcare.png\" alt=\"Health\" class=\"icon-svg\" />"),
            "Tech & Digitalization" => new Microsoft.AspNetCore.Components.MarkupString("<img src=\"/images/technology.png\" alt=\"Tech\" class=\"icon-svg\" />"),
            "Energy" => new Microsoft.AspNetCore.Components.MarkupString("<img src=\"/images/power.png\" alt=\"Energy\" class=\"icon-svg\" />"),
            _ => new Microsoft.AspNetCore.Components.MarkupString("<img src=\"/images/customer-segment.png\" alt=\"Sector\" class=\"icon-svg\" />")
        };
    }

    string GetSatisfactionEmoji(double satisfaction)
    {
        return satisfaction switch
        {
            >= 9 => "",
            >= 8 => "",
            >= 7 => "",
            >= 6 => "",
            >= 5 => "",
            >= 4 => "",
            >= 3 => "",
            _ => ""
        };
    }

    string GetQuestionText(int question)
    {
        return question switch
        {
            1 => "Overall Satisfaction",
            2 => "Professionalism",
            3 => "Growth Impact",
            4 => "Value for Money",
            5 => "Solution Fit",
            6 => "Communication",
            7 => "Timeliness",
            8 => "Advisor Expertise",
            9 => "Future Use Likelihood",
            _ => $"Question {question}"
        };
    }

    string GetQuestionCategory(double avg)
    {
        return avg switch
        {
            >= 8 => "Excellent",
            >= 6 => "Good",
            >= 4 => "Average",
            _ => "Needs Improvement"
        };
    }

    string GetSectorColor(string sector)
    {
        return sector switch
        {
            "Health" => "#ff6b6b",
            "Tech & Digitalization" => "#4ecdc4",
            "Energy" => "#45b7d1",
            _ => "#95a5a6"
        };
    }

    string GetSectorColorDark(string sector)
    {
        return sector switch
        {
            "Health" => "#e74c3c",
            "Tech & Digitalization" => "#16a085",
            "Energy" => "#2980b9",
            _ => "#7f8c8d"
        };
    }

    string GetCompanySizeIcon(string companySize)
    {
        return companySize switch
        {
            "Micro" => "üè™",
            "SME" => "<img src=\"/images/customer-segment.png\" alt=\"SME\" class=\"icon-svg\" />",
            "Large" => "üè≠",
            _ => "üë•"
        };
    }

    string GetCompanySizeColor(string companySize)
    {
        return companySize switch
        {
            "Micro" => "#f39c12",
            "SME" => "#3498db", 
            "Large" => "#9b59b6",
            _ => "#95a5a6"
        };
    }

    string GetCompanySizeColorDark(string companySize)
    {
        return companySize switch
        {
            "Micro" => "#e67e22",
            "SME" => "#2980b9",
            "Large" => "#8e44ad",
            _ => "#7f8c8d"
        };
    }

    double GetQuestionAverage(int questionNumber)
    {
        if (!surveyResponses.Any()) return 0;
        
        return questionNumber switch
        {
            1 => surveyResponses.Average(r => r.Question1),
            2 => surveyResponses.Average(r => r.Question2),
            3 => surveyResponses.Average(r => r.Question3),
            4 => surveyResponses.Average(r => r.Question4),
            5 => surveyResponses.Average(r => r.Question5),
            6 => surveyResponses.Average(r => r.Question6),
            7 => surveyResponses.Average(r => r.Question7),
            8 => surveyResponses.Average(r => r.Question8),
            9 => surveyResponses.Average(r => r.Question9),
            _ => 0
        };
    }

    double GetSectorQuestionAverage(string sector, int questionNumber)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector);
        if (!sectorResponses.Any()) return 0;
        
        return questionNumber switch
        {
            1 => sectorResponses.Average(r => r.Question1),
            2 => sectorResponses.Average(r => r.Question2),
            3 => sectorResponses.Average(r => r.Question3),
            4 => sectorResponses.Average(r => r.Question4),
            5 => sectorResponses.Average(r => r.Question5),
            6 => sectorResponses.Average(r => r.Question6),
            7 => sectorResponses.Average(r => r.Question7),
            8 => sectorResponses.Average(r => r.Question8),
            9 => sectorResponses.Average(r => r.Question9),
            _ => 0
        };
    }

    string GetLinePoints()
    {
        var points = new List<string>();
        for (int q = 1; q <= 9; q++)
        {
            var x = (q - 1) * 12.5;
            var y = 100 - (GetQuestionAverage(q) / 10 * 100);
            points.Add($"{x},{y}");
        }
        return string.Join(" ", points);
    }

    // Trend Analysis Methods
    public class TrendDataPoint
    {
        public double Score { get; set; }
        public string Period { get; set; } = "";
        public string ShortPeriod { get; set; } = "";
        public DateTime Date { get; set; }
        public int ResponseCount { get; set; }
    }

    IEnumerable<TrendDataPoint> GetTrendData()
    {
        Console.WriteLine("*** GETTRENDDATA CALLED ***");
        var completedResponses = surveyResponses.Where(r => r.DateCompleted.HasValue).ToList();
        
        // Filter by selected year if not "all"
        if (selectedTrendsYear != "all")
        {
            if (int.TryParse(selectedTrendsYear, out int year))
            {
                completedResponses = completedResponses
                    .Where(r => r.DateCompleted!.Value.Year == year)
                    .ToList();
                Console.WriteLine($"Filtered by year {year}: {completedResponses.Count} responses");
            }
        }
        
        Console.WriteLine($"GetTrendData: Found {completedResponses.Count} completed responses");
        foreach (var response in completedResponses.Take(5)) // Log first 5 responses
        {
            Console.WriteLine($"  Response: {response.DateCompleted}, Score: {response.Question1}");
        }
        
        if (!completedResponses.Any()) return new List<TrendDataPoint>();

        Console.WriteLine($"*** TRENDS VIEW: '{trendsView}' ***");
        var groupedData = trendsView switch
        {
            "quarterly" => GroupByQuarters(completedResponses),
            "yearly" => GroupByYears(completedResponses),
            _ => GroupByMonths(completedResponses) // default = monthly
        };

        var sortedData = groupedData.OrderBy(t => t.Date).ToList();
        Console.WriteLine($"Final trend data: {sortedData.Count} data points from {sortedData.FirstOrDefault()?.Period} to {sortedData.LastOrDefault()?.Period}");
        
        return sortedData;
    }

    IEnumerable<TrendDataPoint> GroupByMonths(List<SurveyResponse> responses)
    {
        Console.WriteLine("*** DIRECT GROUPBYMONTHS CALLED ***");
        var result = new List<TrendDataPoint>();
        
        // Always generate 12 months for the current/selected year
        int targetYear = DateTime.Now.Year; // Default to current year (2025)
        if (selectedTrendsYear != "all" && int.TryParse(selectedTrendsYear, out int parsedYear))
        {
            targetYear = parsedYear;
        }
        
        Console.WriteLine($"*** GENERATING 12 MONTHS FOR YEAR {targetYear} ***");
        
        // Group responses by month for the target year
        var monthlyGroups = responses
            .Where(r => r.DateCompleted.HasValue && r.DateCompleted.Value.Year == targetYear)
            .GroupBy(r => r.DateCompleted!.Value.Month)
            .ToDictionary(g => g.Key, g => g.ToList());

        // Generate all 12 months
        for (int month = 1; month <= 12; month++)
        {
            var monthDate = new DateTime(targetYear, month, 1);
            var monthName = GetMonthName(month);
            
            if (monthlyGroups.ContainsKey(month))
            {
                var monthResponses = monthlyGroups[month];
                result.Add(new TrendDataPoint
                {
                    Score = Math.Round(monthResponses.Average(r => r.Question1), 1),
                    Period = $"{monthName} {targetYear}",
                    ShortPeriod = $"{monthName.Substring(0, 3)} '{targetYear.ToString().Substring(2)}",
                    Date = monthDate,
                    ResponseCount = monthResponses.Count
                });
                Console.WriteLine($"*** MONTH {month} ({monthName}): {monthResponses.Count} responses, avg score {monthResponses.Average(r => r.Question1):F1}");
            }
            else
            {
                // Add empty month
                result.Add(new TrendDataPoint
                {
                    Score = 0,
                    Period = $"{monthName} {targetYear}",
                    ShortPeriod = $"{monthName.Substring(0, 3)} '{targetYear.ToString().Substring(2)}",
                    Date = monthDate,
                    ResponseCount = 0
                });
                Console.WriteLine($"*** MONTH {month} ({monthName}): 0 responses");
            }
        }

        Console.WriteLine($"*** GENERATED {result.Count} MONTHS FOR {targetYear} ***");
        return result;
    }

    IEnumerable<TrendDataPoint> GroupByQuarters(List<SurveyResponse> responses)
    {
        return responses
            .GroupBy(r => new { r.DateCompleted!.Value.Year, Quarter = (r.DateCompleted!.Value.Month - 1) / 3 + 1 })
            .Select(g => new TrendDataPoint
            {
                Score = Math.Round(g.Average(r => r.Question1), 1),
                Period = $"Q{g.Key.Quarter} {g.Key.Year}",
                ShortPeriod = $"Q{g.Key.Quarter} '{g.Key.Year.ToString().Substring(2)}",
                Date = new DateTime(g.Key.Year, (g.Key.Quarter - 1) * 3 + 1, 1),
                ResponseCount = g.Count()
            })
            .OrderBy(t => t.Date);
    }

    IEnumerable<TrendDataPoint> GroupByYears(List<SurveyResponse> responses)
    {
        return responses
            .GroupBy(r => r.DateCompleted!.Value.Year)
            .Select(g => new TrendDataPoint
            {
                Score = Math.Round(g.Average(r => r.Question1), 1),
                Period = g.Key.ToString(),
                ShortPeriod = g.Key.ToString(),
                Date = new DateTime(g.Key, 1, 1),
                ResponseCount = g.Count()
            })
            .OrderBy(t => t.Date);
    }

    IEnumerable<TrendDataPoint> GetSectorTrendData(string sector)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector && r.DateCompleted.HasValue).ToList();
        
        if (!sectorResponses.Any()) return new List<TrendDataPoint>();

        var groupedData = trendsView switch
        {
            "quarterly" => GroupByQuarters(sectorResponses),
            "yearly" => GroupByYears(sectorResponses),
            _ => GroupByMonths(sectorResponses)
        };

        return groupedData.OrderBy(t => t.Date);
    }

    string GetTrendDirection()
    {
        var data = GetTrendData().ToList();
        if (data.Count < 2) return "stable";

        // Compare latest with previous data point
        var latestScore = data.Last().Score;
        var previousScore = data[data.Count - 2].Score;

        var diff = latestScore - previousScore;
        return diff > 0.2 ? "up" : diff < -0.2 ? "down" : "stable";
    }

    double GetTrendPercentage()
    {
        var data = GetTrendData().Where(t => t.ResponseCount > 0).ToList(); // Only months with actual data
        if (data.Count < 2) return 0;

        // Get the latest and previous data points
        var latestScore = data.Last().Score;
        var previousScore = data[data.Count - 2].Score;

        if (previousScore == 0) return 0;
        return Math.Round(((latestScore - previousScore) / previousScore) * 100, 1);
    }

    TrendDataPoint GetHighestPeriod()
    {
        var data = GetTrendData().Where(t => t.ResponseCount > 0).ToList(); // Only months with actual data
        return data.Any() ? data.OrderByDescending(t => t.Score).First() : new TrendDataPoint();
    }

    TrendDataPoint GetLowestPeriod()
    {
        var data = GetTrendData().Where(t => t.ResponseCount > 0).ToList(); // Only months with actual data
        return data.Any() ? data.OrderBy(t => t.Score).First() : new TrendDataPoint();
    }

    string GetTrendAnalysis()
    {
        var data = GetTrendData().ToList();
        if (data.Count < 2) return "Insufficient data for trend analysis.";

        var direction = GetTrendDirection();
        var percentage = Math.Abs(GetTrendPercentage());

        return direction switch
        {
            "up" => $"Your satisfaction scores are trending upward by {percentage}%, indicating improving service quality and customer relationships.",
            "down" => $"Your satisfaction scores are declining by {percentage}%. Consider reviewing recent service delivery and customer feedback.",
            _ => "Your satisfaction scores remain stable. Maintain current service standards to ensure continued customer satisfaction."
        };
    }

    List<string> GetRecurringChallenges()
    {
        var challenges = new List<string>();
        var data = GetTrendData().ToList();
        
        if (data.Count < 3) return challenges;

        var lowPeriods = data.Where(t => t.Score < 6).Count();
        if (lowPeriods > data.Count * 0.3)
        {
            challenges.Add("Recurring low satisfaction periods");
        }

        var recentData = data.TakeLast(5).ToList();
        if (recentData.Count >= 3)
        {
            var isDeclinig = true;
            for (int i = 1; i < recentData.Count; i++)
            {
                if (recentData[i].Score >= recentData[i - 1].Score)
                {
                    isDeclinig = false;
                    break;
                }
            }
            if (isDeclinig) challenges.Add("Recent declining trend");
        }

        return challenges;
    }

    string GetServiceQualityInsight()
    {
        var avgScore = GetTrendData().Any() ? GetTrendData().Average(t => t.Score) : 0;
        
        return avgScore switch
        {
            >= 8.5 => "Outstanding service quality - customers are highly satisfied!",
            >= 7.5 => "Good service quality - customers are generally satisfied.",
            >= 6.5 => "Acceptable service quality - room for improvement exists.",
            >= 5.5 => "Below average service quality - attention needed.",
            _ => "Service quality needs significant improvement - priority action required."
        };
    }

    int GetPeriodResponseCount(string period)
    {
        var data = GetTrendData().FirstOrDefault(t => t.Period == period);
        return data?.ResponseCount ?? 0;
    }

    string GetMonthName(int month)
    {
        return new DateTime(2000, month, 1).ToString("MMMM", System.Globalization.CultureInfo.InvariantCulture);
    }

    string GetBarColor(double score)
    {
        return score switch
        {
            >= 8.0 => "#28a745", // Green - Excellent
            >= 6.0 => "#17a2b8", // Blue - Good  
            >= 4.0 => "#ffc107", // Yellow - Average
            > 0.0 => "#dc3545",  // Red - Poor
            _ => "#6c757d"       // Gray - No data
        };
    }

    // Generate complete month sequence to ensure all months are shown
    IEnumerable<TrendDataPoint> GetCompleteMonthlyTrends(List<SurveyResponse> responses)
    {
        var result = new List<TrendDataPoint>();
        
        // Always generate 12 months for the current/selected year
        int targetYear = DateTime.Now.Year; // Default to current year
        if (selectedTrendsYear != "all" && int.TryParse(selectedTrendsYear, out int parsedYear))
        {
            targetYear = parsedYear;
        }
        
        // Group responses by month for the target year
        var monthlyGroups = responses
            .Where(r => r.DateCompleted.HasValue && r.DateCompleted.Value.Year == targetYear)
            .GroupBy(r => r.DateCompleted!.Value.Month)
            .ToDictionary(g => g.Key, g => g.ToList());

        // Generate all 12 months
        for (int month = 1; month <= 12; month++)
        {
            var monthDate = new DateTime(targetYear, month, 1);
            var monthName = GetMonthName(month);
            
            if (monthlyGroups.ContainsKey(month))
            {
                var monthResponses = monthlyGroups[month];
                result.Add(new TrendDataPoint
                {
                    Score = Math.Round(monthResponses.Average(r => r.Question1), 1),
                    Period = $"{monthName} {targetYear}",
                    ShortPeriod = $"{monthName.Substring(0, 3)} '{targetYear.ToString().Substring(2)}",
                    Date = monthDate,
                    ResponseCount = monthResponses.Count
                });
            }
            else
            {
                // Add empty month
                result.Add(new TrendDataPoint
                {
                    Score = 0,
                    Period = $"{monthName} {targetYear}",
                    ShortPeriod = $"{monthName.Substring(0, 3)} '{targetYear.ToString().Substring(2)}",
                    Date = monthDate,
                    ResponseCount = 0
                });
            }
        }

        Console.WriteLine($"********** GENERATING ALL 12 MONTHS FOR YEAR {targetYear} **********");
        Console.WriteLine($"Generated 12 months for year {targetYear} with {responses.Count} total responses");
        foreach (var month in result)
        {
            Console.WriteLine($"  {month.Period} - Score: {month.Score} - Responses: {month.ResponseCount}");
        }
        Console.WriteLine($"********** END OF 12 MONTHS GENERATION **********");
        return result;
    }

    string GetTrendLinePath(List<TrendDataPoint> data)
    {
        if (data.Count < 2) return "";
        
        var points = data.Select((point, index) => {
            // Use same positioning logic as chart points
            var x = selectedTrendsYear != "all" && int.TryParse(selectedTrendsYear, out int _) && data.Count == 12 
                ? (point.Date.Month - 1) * 100.0 / 11  // 12 months evenly spaced
                : data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50; // Fallback for "all years"
            var y = 100 - (point.Score / 10.0) * 100;
            return $"{x}% {y}%";
        });
        
        return $"clip-path: polygon({string.Join(", ", points)});";
    }

    string GetTrendAreaPath(List<TrendDataPoint> data)
    {
        if (data.Count < 2) return "";
        
        var topPoints = data.Select((point, index) => {
            // Use same positioning logic as chart points
            var x = selectedTrendsYear != "all" && int.TryParse(selectedTrendsYear, out int _) && data.Count == 12 
                ? (point.Date.Month - 1) * 100.0 / 11  // 12 months evenly spaced
                : data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50; // Fallback for "all years"
            var y = 100 - (point.Score / 10.0) * 100;
            return $"{x}% {y}%";
        });
        
        var bottomPoints = data.Select((point, index) => {
            // Use same positioning logic as chart points
            var x = selectedTrendsYear != "all" && int.TryParse(selectedTrendsYear, out int _) && data.Count == 12 
                ? (point.Date.Month - 1) * 100.0 / 11  // 12 months evenly spaced
                : data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50; // Fallback for "all years"
            return $"{x}% 100%";
        }).Reverse();
        
        return $"clip-path: polygon({string.Join(", ", topPoints)}, {string.Join(", ", bottomPoints)});";
    }

    string GetScoreCategory(double score)
    {
        return score switch
        {
            >= 8 => "Excellent",
            >= 6 => "Good", 
            >= 4 => "Average",
            _ => "Poor"
        };
    }

    // Forecast chart methods
    string GetForecastLinePoints(List<ForecastDataPoint> data)
    {
        if (!data.Any()) return "";
        
        var points = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - (point.PredictedScore / 10.0 * 100);
            Console.WriteLine($"Forecast point {index}: Score={point.PredictedScore}, x={x:F2}, y={y:F2}");
            return $"{x:F2},{y:F2}";
        });
        
        var result = string.Join(" ", points);
        Console.WriteLine($"Forecast line points: {result}");
        return result;
    }
    
    string GetConfidenceAreaPoints(List<ForecastDataPoint> data)
    {
        if (!data.Any()) return "";
        
        Console.WriteLine($"GetConfidenceAreaPoints: Processing {data.Count} points");
        
        // Top line (predicted + confidence)
        var topPoints = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - ((point.PredictedScore + point.ConfidenceInterval) / 10.0 * 100);
            Console.WriteLine($"  Top point {index}: x={x:F2}, y={y:F2}");
            return $"{x:F2},{y:F2}";
        });
        
        // Bottom line (predicted - confidence), reversed
        var bottomPoints = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - ((point.PredictedScore - point.ConfidenceInterval) / 10.0 * 100);
            return $"{x:F2},{y:F2}";
        }).Reverse();
        
        var result = string.Join(" ", topPoints) + " " + string.Join(" ", bottomPoints);
        Console.WriteLine($"Confidence area result: {result}");
        return result;
    }

    string GetForecastLinePath(List<ForecastDataPoint> data)
    {
        if (data.Count < 2) return "";
        
        var pathCommands = new List<string>();
        for (int i = 0; i < data.Count; i++)
        {
            var x = data.Count > 1 ? (i * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - (data[i].PredictedScore / 10.0 * 100);
            
            if (i == 0)
                pathCommands.Add($"M{x.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}");
            else
                pathCommands.Add($"L{x.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)},{y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)}");
                
            Console.WriteLine($"Forecast path point {i}: Score={data[i].PredictedScore}, x={x:F2}, y={y:F2}");
        }
        
        var result = string.Join(" ", pathCommands);
        Console.WriteLine($"Forecast path: {result}");
        return result;
    }

    string GetForecastAreaPath(List<ForecastDataPoint> data)
    {
        if (data.Count < 2) return "";
        
        var topPoints = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - ((point.PredictedScore + point.ConfidenceInterval) / 10.0) * 100;
            return $"{x}% {y}%";
        });
        
        var bottomPoints = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - ((point.PredictedScore - point.ConfidenceInterval) / 10.0) * 100;
            return $"{x}% {y}%";
        }).Reverse();
        
        return $"clip-path: polygon({string.Join(", ", topPoints)}, {string.Join(", ", bottomPoints)});";
    }

    void ClearAllFilters()
    {
        selectedSectorFilter = "all";
        selectedCompanySizeFilter = "all";
        StateHasChanged();
    }

    void SelectItem(string itemKey)
    {
        selectedSector = itemKey;
        StateHasChanged();
    }

    Microsoft.AspNetCore.Components.MarkupString GetItemIcon(string itemKey)
    {
        if (itemKey.Contains(" - "))
        {
            var parts = itemKey.Split(" - ");
            if (parts.Length == 2)
            {
                return new Microsoft.AspNetCore.Components.MarkupString("<img src=\"/images/customer-segment.png\" alt=\"Company\" class=\"icon-svg\" />");
            }
        }
        
        var sectors = GetUniqueSectors();
        if (sectors.Contains(itemKey))
        {
            return GetSectorIcon(itemKey);
        }
        
        var companySizes = GetUniqueCompanySizes();
        if (companySizes.Contains(itemKey))
        {
            return new Microsoft.AspNetCore.Components.MarkupString(GetCompanySizeIcon(itemKey));
        }
        
        return new Microsoft.AspNetCore.Components.MarkupString("üìä");
    }

    string GetItemColor(string itemKey)
    {
        if (itemKey.Contains(" - "))
        {
            var parts = itemKey.Split(" - ");
            if (parts.Length == 2)
            {
                return GetSectorColor(parts[0]);
            }
        }
        
        var sectors = GetUniqueSectors();
        if (sectors.Contains(itemKey))
        {
            return GetSectorColor(itemKey);
        }
        
        var companySizes = GetUniqueCompanySizes();
        if (companySizes.Contains(itemKey))
        {
            return GetCompanySizeColor(itemKey);
        }
        
        return "#95a5a6";
    }

    int GetFilteredResponseCount(string itemKey)
    {
        var responses = GetCombinedFilteredResponses();
        
        if (itemKey.Contains(" - "))
        {
            return responses.Count();
        }
        
        var sectors = GetUniqueSectors();
        var companySizes = GetUniqueCompanySizes();
        
        if (sectors.Contains(itemKey))
        {
            return responses.Where(r => r.Sector == itemKey).Count();
        }
        
        if (companySizes.Contains(itemKey))
        {
            return responses.Where(r => r.CompanySize == itemKey).Count();
        }
        
        return responses.Count();
    }

    // Client Analytics Methods
    public class ClientAnalyticsData
    {
        public string Period { get; set; } = "";
        public string ShortPeriod { get; set; } = "";
        public DateTime Date { get; set; }
        public int NewClients { get; set; }
        public int RepeatedClients { get; set; }
    }

    public class ClientDetail
    {
        public string ClientName { get; set; } = "";
        public bool IsRepeatedClient { get; set; }
        public DateTime? FirstSurveyDate { get; set; }
        public DateTime? LatestSurveyDate { get; set; }
        public int TotalSurveys { get; set; }
        public double AverageSatisfaction { get; set; }
    }

    void SetClientView(string view)
    {
        clientView = view;
        selectedClientPeriod = null;
        StateHasChanged();
    }

    void SelectClientPeriod(string period)
    {
        selectedClientPeriod = selectedClientPeriod == period ? null : period;
        StateHasChanged();
    }

    IEnumerable<ClientAnalyticsData> GetClientAnalytics()
    {
        var completedResponses = surveyResponses.Where(r => r.DateCompleted.HasValue).ToList();
        
        if (!completedResponses.Any()) return new List<ClientAnalyticsData>();

        return clientView switch
        {
            "monthly" => GroupClientsByMonths(completedResponses),
            _ => GroupClientsByYears(completedResponses)
        };
    }

    IEnumerable<ClientAnalyticsData> GroupClientsByYears(List<SurveyResponse> responses)
    {
        var yearGroups = responses.GroupBy(r => r.DateCompleted!.Value.Year);
        
        foreach (var yearGroup in yearGroups.OrderBy(g => g.Key))
        {
            var year = yearGroup.Key;
            var yearResponses = yearGroup.ToList();
            
            // Get all clients who had surveys in this year
            var clientsThisYear = yearResponses.Where(r => !string.IsNullOrEmpty(r.CustomerName)).Select(r => r.CustomerName).Distinct().ToList();
            
            // Which clients are new vs repeated?
            var newClients = 0;
            var repeatedClients = 0;
            
            foreach (var client in clientsThisYear)
            {
                // Find the first survey for this client (ever)
                var firstSurvey = surveyResponses
                    .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.CustomerName == client && r.DateCompleted.HasValue)
                    .OrderBy(r => r.DateCompleted!.Value)
                    .FirstOrDefault();
                
                if (firstSurvey != null)
                {
                    // Client is "new" only in the year of their first survey
                    if (firstSurvey.DateCompleted!.Value.Year == year)
                        newClients++;
                    else
                        repeatedClients++;
                }
            }
            
            yield return new ClientAnalyticsData
            {
                Period = year.ToString(),
                ShortPeriod = year.ToString(),
                Date = new DateTime(year, 1, 1),
                NewClients = newClients,
                RepeatedClients = repeatedClients
            };
        }
    }

    IEnumerable<ClientAnalyticsData> GroupClientsByMonths(List<SurveyResponse> responses)
    {
        var monthGroups = responses.GroupBy(r => new { r.DateCompleted!.Value.Year, r.DateCompleted!.Value.Month });
        
        foreach (var monthGroup in monthGroups.OrderBy(g => g.Key.Year).ThenBy(g => g.Key.Month))
        {
            var year = monthGroup.Key.Year;
            var month = monthGroup.Key.Month;
            var monthResponses = monthGroup.ToList();
            
            // Get all clients who had surveys in this month
            var clientsThisMonth = monthResponses.Where(r => !string.IsNullOrEmpty(r.CustomerName)).Select(r => r.CustomerName).Distinct().ToList();
            
            // Which clients are new vs repeated?
            var newClients = 0;
            var repeatedClients = 0;
            
            foreach (var client in clientsThisMonth)
            {
                // Find the first survey for this client (ever)
                var firstSurvey = surveyResponses
                    .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.CustomerName == client && r.DateCompleted.HasValue)
                    .OrderBy(r => r.DateCompleted!.Value)
                    .FirstOrDefault();
                
                if (firstSurvey != null)
                {
                    // Client is "new" only in the month of their first survey
                    if (firstSurvey.DateCompleted!.Value.Year == year && firstSurvey.DateCompleted.Value.Month == month)
                        newClients++;
                    else
                        repeatedClients++;
                }
            }
            
            yield return new ClientAnalyticsData
            {
                Period = $"{GetMonthName(month)} {year}",
                ShortPeriod = $"{GetMonthName(month).Substring(0, 3)} '{year.ToString().Substring(2)}",
                Date = new DateTime(year, month, 1),
                NewClients = newClients,
                RepeatedClients = repeatedClients
            };
        }
    }

    int GetTotalUniqueClients()
    {
        return surveyResponses.Where(r => !string.IsNullOrEmpty(r.CustomerName))
                            .Select(r => r.CustomerName)
                            .Distinct()
                            .Count();
    }

    int GetNewClientsForPeriod()
    {
        // If "All Years" is selected, count clients who have only ever had 1 survey total
        if (selectedClientYear == "all")
        {
            var allClientSurveyCounts = surveyResponses
                .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.DateCompleted.HasValue)
                .GroupBy(r => r.CustomerName)
                .ToDictionary(g => g.Key, g => g.Count());
            
            return allClientSurveyCounts.Count(kvp => kvp.Value == 1);
        }
        
        // For specific year, count clients who had EXACTLY 1 survey in that year
        if (int.TryParse(selectedClientYear, out int targetYear))
        {
            var newClientsInYear = surveyResponses
                .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.DateCompleted.HasValue)
                .GroupBy(r => r.CustomerName)
                .Select(g => new
                {
                    ClientName = g.Key,
                    SurveyCountInTargetYear = g.Count(r => r.DateCompleted!.Value.Year == targetYear)
                })
                .Where(c => c.SurveyCountInTargetYear == 1)
                .Count();
            
            return newClientsInYear;
        }
        
        return 0;
    }

    int GetRepeatedClientsForPeriod()
    {
        // If "All Years" is selected, count clients who have more than 1 survey total
        if (selectedClientYear == "all")
        {
            var allClientSurveyCounts = surveyResponses
                .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.DateCompleted.HasValue)
                .GroupBy(r => r.CustomerName)
                .ToDictionary(g => g.Key, g => g.Count());
            
            return allClientSurveyCounts.Count(kvp => kvp.Value > 1);
        }
        
        // For specific year, count clients who had MORE THAN 1 survey in that year
        if (int.TryParse(selectedClientYear, out int targetYear))
        {
            var repeatedClientsInYear = surveyResponses
                .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.DateCompleted.HasValue)
                .GroupBy(r => r.CustomerName)
                .Select(g => new
                {
                    ClientName = g.Key,
                    SurveyCountInTargetYear = g.Count(r => r.DateCompleted!.Value.Year == targetYear)
                })
                .Where(c => c.SurveyCountInTargetYear > 1)
                .Count();
            
            return repeatedClientsInYear;
        }
        
        return 0;
    }

    IEnumerable<ClientDetail> GetFilteredClientDetails()
    {
        var allClients = GetAllClientDetails();
        
        return selectedClientFilter switch
        {
            "new" => allClients.Where(c => !c.IsRepeatedClient),
            "repeated" => allClients.Where(c => c.IsRepeatedClient),
            _ => allClients
        };
    }

    IEnumerable<ClientDetail> GetAllClientDetails()
    {
        var filteredResponses = surveyResponses
            .Where(r => !string.IsNullOrEmpty(r.CustomerName) && r.DateCompleted.HasValue);
        
        // Apply year filter
        if (selectedClientYear != "all" && int.TryParse(selectedClientYear, out int filterYear))
        {
            filteredResponses = filteredResponses.Where(r => r.DateCompleted!.Value.Year == filterYear);
        }
        
        var clientGroups = filteredResponses.GroupBy(r => r.CustomerName);
        
        foreach (var clientGroup in clientGroups.OrderBy(g => g.Key))
        {
            var clientName = clientGroup.Key;
            var clientSurveys = clientGroup.OrderBy(r => r.DateCompleted).ToList();
            
            var firstSurvey = clientSurveys.First();
            var latestSurvey = clientSurveys.Last();
            
            // A client is considered repeated if they have more than one completed survey
            var isRepeated = clientSurveys.Count > 1;
            
            var avgSatisfaction = clientSurveys.Average(r => r.Question1);
            
            yield return new ClientDetail
            {
                ClientName = clientName,
                IsRepeatedClient = isRepeated,
                FirstSurveyDate = firstSurvey.DateCompleted,
                LatestSurveyDate = latestSurvey.DateCompleted,
                TotalSurveys = clientSurveys.Count,
                AverageSatisfaction = avgSatisfaction
            };
        }
    }

    string GetClientSatisfactionClass(double satisfaction)
    {
        return satisfaction switch
        {
            >= 8 => "excellent",
            >= 6 => "good",
            >= 4 => "average",
            _ => "poor"
        };
    }

    // Chat Methods
    async Task SendSuggestionMessage(string message)
    {
        chatInput = message;
        await SendChatMessage();
    }

    async Task ClearChatHistory()
    {
        chatHistory.Clear();
        StateHasChanged();
    }

    async Task CopyMessageToClipboard(string text)
    {
        try 
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch
        {
            
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        
        if (chatHistory.Any() || isProcessingChat)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("scrollChatToBottom");
            }
            catch
            {
                // Maybe add javascript???
            }
        }
    }

    async Task HandleChatKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            if (!string.IsNullOrWhiteSpace(chatInput))
            {
                await SendChatMessage();
            }
        }
    }

    void HandleInputChange(ChangeEventArgs e)
    {
        chatInput = e.Value?.ToString() ?? "";
        StateHasChanged();
    }
}
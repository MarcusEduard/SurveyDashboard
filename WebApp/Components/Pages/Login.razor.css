@page "/survey-dashboard"
@attribute [Authorize(Policy = "NotGuest")]
@using WebAPI.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient httpClient
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="dashboard-container">
    <h2>Survey Analytics Dashboard</h2>
    
    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading survey data...</p>
        </div>
    }
    else if (surveyResponses.Count == 0)
    {
        <div class="no-data">
            <p>No survey responses available yet.</p>
        </div>
    }
    else
    {
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="card clickable" @onclick='() => ScrollToSection("responses")'>
                <div class="card-icon">üìä</div>
                <h3 class="counter" data-target="@surveyResponses.Count">@surveyResponses.Count</h3>
                <p>Total Responses</p>
                <div class="card-arrow">‚Üí</div>
            </div>
            <div class="card clickable" @onclick='() => ScrollToSection("satisfaction")'>
                <div class="card-icon">‚≠ê</div>
                <h3 class="counter satisfaction-score" data-target="@Math.Round(avgSatisfaction, 1)">@Math.Round(avgSatisfaction, 1)</h3>
                <p>Avg Overall Satisfaction</p>
                <div class="satisfaction-bar" style="position: relative;">
                    <div class="satisfaction-fill" style="width: @(avgSatisfaction * 10)%"></div>
                    <div class="goal-line" title="Goal: 9" style="position: absolute; left: 90%; top: 0; bottom: 0; width: 2px; background: #28a745; opacity: 0.7;"></div>
                </div>
            </div>
        </div>

        <!-- Sector Overview Charts -->
        <div class="charts-section">
            <div class="section-header">
                <h3>üìà Analytics</h3>
            </div>
            
            <!-- Bar Chart: Responses per Sector -->
            <div class="chart-container" id="responses">
                <div class="chart-header">
                    <h4>üîç Survey Responses by Sector</h4>
                    <div class="chart-controls">
                        <button class="view-btn @(chartView == "count" ? "active" : "")" @onclick='() => SetChartView("count")'>Count</button>
                        <button class="view-btn @(chartView == "percentage" ? "active" : "")" @onclick='() => SetChartView("percentage")'>%</button>
                        <button class="view-btn @(chartView == "completion" ? "active" : "")" @onclick='() => SetChartView("completion")'>Completion Rate</button>
                    </div>
                </div>
                <div class="interactive-bar-chart">
                    @foreach (var sector in sectorCounts.OrderByDescending(x => x.Value))
                    {
                        var totalCount = sector.Value;
                        var completedCount = GetCompletedCountForSector(sector.Key);
                        var completionRate = totalCount > 0 ? (double)completedCount / totalCount * 100 : 0;
                        
                        var displayValue = chartView switch
                        {
                            "percentage" => $"{((double)sector.Value / surveyResponses.Count * 100):F1}%",
                            "completion" => $"{completionRate.ToString("F0")}% ({completedCount}/{totalCount})",
                            _ => sector.Value.ToString()
                        };
                        
                        var barWidth = chartView switch
                        {
                            "percentage" => (double)sector.Value / surveyResponses.Count * 100,
                            "completion" => completionRate,
                            _ => totalCount > 0 ? Math.Max(((double)totalCount / surveyResponses.Count * 100), 5) : 0
                        };
                        
                        <div class="interactive-bar-item @(hoveredSector == sector.Key ? "hovered" : "")" 
                             @onclick="() => ToggleSectorDetails(sector.Key)"
                             @onmouseover="() => hoveredSector = sector.Key"
                             @onmouseleave="() => hoveredSector = null">
                            <div class="bar-header">
                                <div class="bar-label">
                                    <span class="sector-icon">@GetSectorIcon(sector.Key)</span>
                                    @sector.Key
                                </div>
                                <div class="bar-value-display">@displayValue</div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="interactive-bar" 
                                     style="width: @(barWidth)%; background: linear-gradient(135deg, @GetSectorColor(sector.Key), @GetSectorColorDark(sector.Key)); animation-delay: @(Array.IndexOf(sectorCounts.Keys.ToArray(), sector.Key) * 0.1)s">
                                    <div class="bar-shine"></div>
                                </div>
                                @if (chartView == "completion")
                                {
                                    <div class="completion-progress-bg">
                                        <div class="completion-progress-fill" style="width: @(completionRate)%"></div>
                                    </div>
                                }
                            </div>
                            @if (expandedSectors.Contains(sector.Key))
                            {
                                <div class="sector-dropdown">
                                    <div class="dropdown-stats">
                                        <div class="mini-stat">
                                            <span class="mini-stat-value">@Math.Round(GetSectorAverage(sector.Key, "satisfaction"), 1)</span>
                                            <span class="mini-stat-label">Avg Satisfaction</span>
                                        </div>
                                        <div class="mini-stat">
                                            <span class="mini-stat-value">@completedCount</span>
                                            <span class="mini-stat-label">Completed</span>
                                        </div>
                                        <div class="mini-stat">
                                            <span class="mini-stat-value">@(totalCount - completedCount)</span>
                                            <span class="mini-stat-label">Pending</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            <!-- Average Satisfaction by Sector -->
            <div class="chart-container" id="satisfaction">
                <div class="chart-header">
                    <h4>‚≠ê Satisfaction Ratings</h4>
                    <div class="filter-controls">
                        <div class="filter-section">
                            <label class="filter-label">Filter by Sector</label>
                            <select @bind="selectedSectorFilter" class="filter-dropdown">
                                <option value="all">All Sectors</option>
                                @foreach (var sector in GetUniqueSectors())
                                {
                                    <option value="@sector">@sector</option>
                                }
                            </select>
                        </div>
                        
                        <div class="filter-section">
                            <label class="filter-label">Filter by Company Size</label>
                            <select @bind="selectedCompanySizeFilter" class="filter-dropdown">
                                <option value="all">All Company Sizes</option>
                                @foreach (var companySize in GetUniqueCompanySizes())
                                {
                                    <option value="@companySize">@companySize</option>
                                }
                            </select>
                        </div>
                        
                        @if (selectedSectorFilter != "all" || selectedCompanySizeFilter != "all")
                        {
                            <div class="filter-section">
                                <button class="clear-filters-btn" @onclick="ClearAllFilters">
                                    üóëÔ∏è Clear Filters
                                </button>
                            </div>
                        }
                        
                        @if (selectedSectorFilter != "all" || selectedCompanySizeFilter != "all")
                        {
                            <div class="active-filters">
                                <span class="filter-indicator">Active Filters:</span>
                                @if (selectedSectorFilter != "all")
                                {
                                    <span class="filter-badge sector">@selectedSectorFilter</span>
                                }
                                @if (selectedCompanySizeFilter != "all")
                                {
                                    <span class="filter-badge company-size">@selectedCompanySizeFilter</span>
                                }
                            </div>
                        }
                    </div>
                </div>
                <div class="satisfaction-grid">
                    @{
                        var filteredSatisfactionData = GetCombinedFilteredSatisfactionData();
                    }
                    
                    @foreach (var item in filteredSatisfactionData.OrderByDescending(x => x.Value))
                    {
                        var percentage = item.Value / 10 * 100;
                        var satisfaction = item.Value;
                        var satisfactionClass = satisfaction >= 8 ? "excellent" : satisfaction >= 6 ? "good" : satisfaction >= 4 ? "average" : "poor";
                        
                        <div class="satisfaction-card @satisfactionClass" @onclick="() => SelectItem(item.Key)">
                            <div class="satisfaction-header">
                                <span class="sector-icon">@GetItemIcon(item.Key)</span>
                                <h5>@item.Key</h5>
                                <div class="satisfaction-score-big">@Math.Round(item.Value, 1)</div>
                            </div>
                            <div class="satisfaction-meter">
                                <div class="meter-track" style="position: relative;">
                                    <div class="goal-line" title="Goal: 9" style="position: absolute; left: 90%; top: 0; bottom: 0; width: 2px; background: #28a745; opacity: 0.7;"></div>
                                </div>
                                <div class="meter-fill" style="width: @(percentage)%; background: @GetItemColor(item.Key);"></div>
                                <div class="meter-labels">
                                    @for (int i = 0; i <= 10; i += 2)
                                    {
                                        <span class="meter-label">@i</span>
                                    }
                                </div>
                            </div>
                            <div class="satisfaction-emotion">@GetSatisfactionEmoji(satisfaction)</div>
                            <div class="satisfaction-details">
                                <small>@GetFilteredResponseCount(item.Key) responses</small>
                            </div>
                        </div>
                    }
                    
                    @if (!filteredSatisfactionData.Any())
                    {
                        <div class="no-data-message">
                            <div class="no-data-icon">üìä</div>
                            <h4>No Data Available</h4>
                            <p>No survey responses found for the selected filters.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Satisfaction Trends Over Time -->
            <div class="chart-container" id="trends">
                <div class="chart-header">
                    <h4>üìà Satisfaction Trends Over Time</h4>
                    <div class="chart-controls">
                        <button class="view-btn @(trendsView == "monthly" ? "active" : "")" @onclick='() => SetTrendsView("monthly")'>Monthly</button>
                        <button class="view-btn @(trendsView == "quarterly" ? "active" : "")" @onclick='() => SetTrendsView("quarterly")'>Quarterly</button>
                        <button class="view-btn @(trendsView == "yearly" ? "active" : "")" @onclick='() => SetTrendsView("yearly")'>Yearly</button>
                    </div>
                </div>
                
                @if (GetTrendData().Any())
                {
                    <div class="trends-container">
                        <!-- Trend Summary Cards -->
                        <div class="trend-summary-cards">
                            <div class="trend-card">
                                <div class="trend-icon">üìà</div>
                                <div class="trend-value @(GetTrendDirection() == "up" ? "positive" : GetTrendDirection() == "down" ? "negative" : "neutral")">
                                    @GetTrendPercentage()%
                                </div>
                                <div class="trend-label">@GetTrendDirection().ToUpper() trend</div>
                                <div class="trend-period">Last @trendsView</div>
                            </div>
                            
                            <div class="trend-card">
                                <div class="trend-icon">üéØ</div>
                                <div class="trend-value">@GetHighestPeriod().Score.ToString("F1")</div>
                                <div class="trend-label">Highest Score</div>
                                <div class="trend-period">@GetHighestPeriod().Period</div>
                            </div>
                            
                            <div class="trend-card">
                                <div class="trend-icon">‚ö†Ô∏è</div>
                                <div class="trend-value">@GetLowestPeriod().Score.ToString("F1")</div>
                                <div class="trend-label">Lowest Score</div>
                                <div class="trend-period">@GetLowestPeriod().Period</div>
                            </div>
                            
                            <div class="trend-card">
                                <div class="trend-icon">üìä</div>
                                <div class="trend-value">@GetTrendData().Count()</div>
                                <div class="trend-label">Data Points</div>
                                <div class="trend-period">@trendsView periods</div>
                            </div>
                        </div>

                        <!-- Interactive Trend Chart -->
                        <div class="trend-chart-container">
                            <div class="visual-trend-chart">
                                @{
                                    var trendData = GetTrendData().ToList();
                                }
                                
                                @if (trendData.Any())
                                {
                                    <div class="trend-chart-header">
                                        <span class="chart-title">üìà Satisfaction Score Over Time</span>
                                        <span class="chart-range">Scale: 0 - 10</span>
                                    </div>
                                    
                                    <!-- Visual Line Chart -->
                                    <div class="line-chart-container">
                                        <div class="chart-grid">
                                            <!-- Y-axis scale -->
                                            <div class="y-axis">
                                                @for (int i = 10; i >= 0; i -= 2)
                                                {
                                                    <div class="y-label" style="bottom: @(i * 10)%;">@i</div>
                                                }
                                            </div>
                                            
                                            <!-- Chart area -->
                                            <div class="chart-area">
                                                <!-- Grid lines -->
                                                <div class="grid-lines">
                                                    @for (int i = 0; i <= 10; i += 2)
                                                    {
                                                        <div class="grid-line-horizontal" style="bottom: @(i * 10)%;"></div>
                                                    }
                                                </div>
                                                
                                                <!-- Line chart content -->
                                                <div class="line-chart-content">
                                                    @if (trendData.Count > 1)
                                                    {
                                                        <!-- Background area -->
                                                        <div class="trend-area" style="@GetTrendAreaPath(trendData)"></div>
                                                        
                                                        <!-- Main trend line -->
                                                        <div class="trend-line" style="@GetTrendLinePath(trendData)"></div>
                                                    }
                                                    
                                                    <!-- Data points -->
                                                    @foreach (var (point, index) in trendData.Select((p, i) => (p, i)))
                                                    {
                                                        var leftPosition = trendData.Count > 1 ? (index * 100.0 / (trendData.Count - 1)) : 50;
                                                        var bottomPosition = (point.Score / 10.0) * 100;
                                                        var isRecent = index >= Math.Max(0, trendData.Count - 3);
                                                        var pointClass = point.Score >= 8 ? "excellent" : point.Score >= 6 ? "good" : point.Score >= 4 ? "average" : "poor";
                                                        
                                                        <div class="data-point @pointClass @(isRecent ? "recent" : "") @(selectedTrendPoint == index ? "selected" : "")"
                                                             style="left: @(leftPosition)%; bottom: @(bottomPosition)%;"
                                                             @onclick="() => SelectTrendPoint(index)"
                                                             @onmouseover="() => selectedTrendPoint = index"
                                                             @onmouseleave="() => selectedTrendPoint = null">
                                                            
                                                            <div class="point-circle">
                                                                <div class="point-value">@point.Score.ToString("F1")</div>
                                                            </div>
                                                            
                                                            @if (selectedTrendPoint == index)
                                                            {
                                                                <div class="point-tooltip">
                                                                    <div class="tooltip-header">
                                                                        <strong>@point.Score.ToString("F1") / 10</strong>
                                                                        <span class="score-badge @pointClass">@GetScoreCategory(point.Score)</span>
                                                                    </div>
                                                                    <div class="tooltip-period">@point.Period</div>
                                                                    <div class="tooltip-details">
                                                                        <span>üìä @GetPeriodResponseCount(point.Period) responses</span>
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                                
                                                <!-- X-axis labels -->
                                                <div class="x-axis">
                                                    @foreach (var (point, index) in trendData.Select((p, i) => (p, i)))
                                                    {
                                                        var leftPosition = trendData.Count > 1 ? (index * 100.0 / (trendData.Count - 1)) : 50;
                                                        var showLabel = trendData.Count <= 8 || index % Math.Max(1, trendData.Count / 6) == 0;
                                                        
                                                        @if (showLabel)
                                                        {
                                                            <div class="x-label" style="left: @(leftPosition)%;">
                                                                @point.ShortPeriod
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Chart Legend -->
                                        <div class="chart-legend">
                                            <div class="legend-item">
                                                <div class="legend-dot excellent"></div>
                                                <span>Excellent (8-10)</span>
                                            </div>
                                            <div class="legend-item">
                                                <div class="legend-dot good"></div>
                                                <span>Good (6-7.9)</span>
                                            </div>
                                            <div class="legend-item">
                                                <div class="legend-dot average"></div>
                                                <span>Average (4-5.9)</span>
                                            </div>
                                            <div class="legend-item">
                                                <div class="legend-dot poor"></div>
                                                <span>Needs Improvement (0-3.9)</span>
                                            </div>
                                            <div class="legend-item recent-legend">
                                                <div class="legend-dot recent"></div>
                                                <span>Recent Data</span>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <!-- Trend Insights -->
                            <div class="trend-insights">
                                <div class="insight-item">
                                    <strong>Trend Analysis:</strong>
                                    <span>@GetTrendAnalysis()</span>
                                </div>
                                @if (GetRecurringChallenges().Any())
                                {
                                    <div class="insight-item">
                                        <strong>Recurring Challenges:</strong>
                                        <span>@string.Join(", ", GetRecurringChallenges())</span>
                                    </div>
                                }
                                <div class="insight-item">
                                    <strong>Service Quality:</strong>
                                    <span>@GetServiceQualityInsight()</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="no-trend-data">
                        <p>üìä No trend data available yet. Complete more surveys to see satisfaction trends over time!</p>
                    </div>
                }
            </div>

            <!-- Question Performance Chart -->
            <div class="chart-container">
                <h4>üìä Question Performance</h4>
                <div class="question-performance">
                    <div class="question-bars">
                        @for (int q = 1; q <= 9; q++)
                        {
                            var avg = GetQuestionAverage(q);
                            var height = avg / 10 * 100;
                            var questionClass = avg >= 8 ? "excellent" : avg >= 6 ? "good" : avg >= 4 ? "average" : "poor";

                            <div class="question-bar-item @(selectedQuestion == q ? "selected" : "")"
                                 @onclick="() => ToggleQuestion(q)">
                                <div class="question-bar @questionClass" style="height: @(height)%">
                                    <div class="bar-value">@Math.Round(avg, 1)</div>
                                </div>
                                <div class="question-label">Q@(q)</div>
                                <div class="question-tooltip">
                                    @GetQuestionText(q)
                                </div>
                                @if (selectedQuestion == q)
                                {
                                    <div class="question-tooltip" style="top:-80px;">
                                        <strong>@GetQuestionText(q)</strong>
                                        <div class="tooltip-stats">
                                            <span>Average: @Math.Round(avg, 1)/10</span>
                                            <span>@GetQuestionCategory(avg)</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Hierarchical Navigation Section -->
            <div class="sector-details" id="sectors">
                <div class="section-header">
                    <h3>
                        @if (currentNavigationLevel == "sectors")
                        {
                            <span>üè¢ Select Sector for Detailed Analysis</span>
                        }
                        else if (currentNavigationLevel == "customers")
                        {
                            <span>üè¨ Customers in @selectedSector Sector</span>
                        }
                        else if (currentNavigationLevel == "projects")
                        {
                            <span>üìã Projects for @selectedCustomer</span>
                        }
                        else if (currentNavigationLevel == "analysis")
                        {
                            <span>üìä Detailed Analysis: @selectedProject</span>
                        }
                    </h3>
                    
                    @if (currentNavigationLevel != "sectors")
                    {
                        <button class="toggle-btn" @onclick="NavigateBack">‚Üê Back</button>
                    }
                </div>

                @if (currentNavigationLevel == "sectors")
                {
                    <!-- Sector Selection - Show all sectors for all roles in main overview -->
                    <div class="navigation-grid">
                        @foreach (var sectorKvp in sectorCounts)
                        {
                            var sector = sectorKvp.Key;
                            var count = sectorKvp.Value;
                            var sectorResponses = surveyResponses.Where(r => r.Sector == sector).ToList();
                            var avgSat = sectorResponses.Count > 0 ? Math.Round(sectorResponses.Average(r => r.Question1), 1) : 0;
                            var completedCount = sectorResponses.Count(r => r.DateCompleted.HasValue);
                            var completionRate = count > 0 ? (double)completedCount / count * 100 : 0;
                            
                            <div class="navigation-card sector-card" @onclick="() => NavigateToCustomers(sector)">
                                <div class="card-icon">@GetSectorIcon(sector)</div>
                                <h4>@sector</h4>
                                <div class="card-stats">
                                    <div class="stat-item">
                                        <span class="stat-number">@count</span>
                                        <span class="stat-label">Total Surveys</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number">@avgSat</span>
                                        <span class="stat-label">Avg. Score</span>
                                    </div>
                                </div>
                                <div class="completion-stats">
                                    <div class="completion-bar">
                                        <div class="completion-fill" style="width: @(completionRate)%"></div>
                                    </div>
                                    <span class="completion-text">@completedCount/@count completed (@(completionRate.ToString("F0"))%)</span>
                                </div>
                                <div class="card-arrow">‚Üí</div>
                            </div>
                        }
                    </div>
                }
                else if (currentNavigationLevel == "customers")
                {
                    <!-- Customer Selection - Now role-filtered for detailed analysis -->
                    <div class="navigation-grid">
                        @foreach (var customer in GetCustomersForSector(selectedSector!))
                        {
                            var customerResponses = GetRoleBasedResponses().Where(r => r.Sector == selectedSector && r.CustomerName == customer).ToList();
                            
                            @if (customerResponses.Any()) // Only show if user has access to this data
                            {
                                var avgSat = customerResponses.Count > 0 ? Math.Round(customerResponses.Average(r => r.Question1), 1) : 0;
                                var projectCount = customerResponses.Select(r => r.ProjectName).Distinct().Count();
                                
                                <div class="navigation-card customer-card" @onclick="() => NavigateToProjects(customer)">
                                    <div class="card-icon">üè¨</div>
                                    <h4>@customer</h4>
                                    <div class="card-stats">
                                        <div class="stat-item">
                                            <span class="stat-number">@projectCount</span>
                                            <span class="stat-label">Projects</span>
                                        </div>
                                        <div class="stat-item">
                                            <span class="stat-number">@avgSat</span>
                                            <span class="stat-label">Avg. Score</span>
                                        </div>
                                    </div>
                                    <div class="card-arrow">‚Üí</div>
                                </div>
                            }
                        }
                    </div>
                }
                else if (currentNavigationLevel == "projects")
                {
                    <!-- Project Selection -->
                    <div class="navigation-grid">
                        @foreach (var project in GetProjectsForCustomer(selectedSector!, selectedCustomer!))
                        {
                            var projectResponses = GetProjectResponses(selectedSector!, selectedCustomer!, project);
                            var avgSat = projectResponses.Count > 0 ? Math.Round(projectResponses.Average(r => r.Question1), 1) : 0;
                            var duration = projectResponses.FirstOrDefault()?.ProjectDuration ?? "N/A";
                            
                            <div class="navigation-card project-card" @onclick="() => NavigateToAnalysis(project)">
                                <div class="card-icon">üìã</div>
                                <h4>@project</h4>
                                <div class="card-stats">
                                    <div class="stat-item">
                                        <span class="stat-number">@projectResponses.Count</span>
                                        <span class="stat-label">Responses</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number">@avgSat</span>
                                        <span class="stat-label">Score</span>
                                    </div>
                                </div>
                                <div class="card-arrow">‚Üí</div>
                            </div>
                        }
                    </div>
                }
                else if (currentNavigationLevel == "analysis")
                {
                    <!-- Detailed Analysis -->
                    var analysisResponses = GetProjectResponses(selectedSector!, selectedCustomer!, selectedProject!);
                    
                    <div class="detailed-analysis-container">
                        <div class="analysis-header">
                            <div class="project-info">
                                <h4>@selectedProject</h4>
                                <p><strong>Customer:</strong> @selectedCustomer</p>
                                <p><strong>Sector:</strong> @selectedSector</p>
                                <p><strong>Total Responses:</strong> @analysisResponses.Count</p>
                                @if (analysisResponses.Any())
                                {
                                    <p><strong>Response Period:</strong> 
                                       @analysisResponses.Min(r => r.DateCompleted?.ToString("dd/MM/yyyy") ?? "N/A") - 
                                       @analysisResponses.Max(r => r.DateCompleted?.ToString("dd/MM/yyyy") ?? "N/A")
                                    </p>
                                }
                            </div>
                        </div>

                        <!-- Question Breakdown for this specific project -->
                        <div class="analysis-charts">
                            <div class="chart-container">
                                <h5>üìä Question Breakdown</h5>
                                <div class="question-analysis-grid">
                                    @for (int q = 1; q <= 9; q++)
                                    {
                                        var scores = analysisResponses.Select(r => GetQuestionScore(r, q)).Where(s => s > 0);
                                        var avg = scores.Any() ? Math.Round(scores.Average(), 1) : 0;
                                        var count = scores.Count();
                                        var questionClass = avg >= 8 ? "excellent" : avg >= 6 ? "good" : avg >= 4 ? "average" : "poor";
                                        
                                        <div class="question-analysis-item">
                                            <div class="question-header">
                                                <span class="question-number">Q@(q)</span>
                                                <span class="question-score @questionClass">@avg</span>
                                            </div>
                                            <div class="question-text">@GetQuestionText(q)</div>
                                            <div class="question-bar-container">
                                                <div class="question-bar-bg"></div>
                                                <div class="question-bar-fill @questionClass" style="width: @(avg * 10)%"></div>
                                            </div>
                                            <div class="question-stats">
                                                <span>@count responses</span>
                                                <span>@GetQuestionCategory(avg)</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                            
                            <!-- Individual Response Details -->
                            <div class="chart-container">
                                <h5>üìã Individual Survey Responses</h5>
                                <div class="responses-table">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Survey ID</th>
                                                <th>Date Sent</th>
                                                <th>Date Completed</th>
                                                <th>Project Duration</th>
                                                <th>Overall Score</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var response in analysisResponses.OrderByDescending(r => r.DateCompleted))
                                            {
                                                <tr>
                                                    <td><code>@response.SurveyId.Substring(0, 8)...</code></td>
                                                    <td>@(response.DateSent?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                                    <td>@(response.DateCompleted?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                                                    <td>@(response.ProjectDuration ?? "N/A")</td>
                                                    <td>
                                                        <span class="badge @(response.Question1 >= 8 ? "bg-success" : response.Question1 >= 6 ? "bg-info" : response.Question1 >= 4 ? "bg-warning" : "bg-danger")">
                                                            @response.Question1/10
                                                        </span>
                                                    </td>
                                                    <td>
                                                        @if (response.DateCompleted.HasValue)
                                                        {
                                                            <span class="badge bg-success">‚úì Completed</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-warning">‚è≥ Pending</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .dashboard-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #007bff, #28a745, #ffc107, #dc3545);
        z-index: 1;
    }

    .dashboard-container h2 {
        text-align: center;
        color: #0056b3;
        font-weight: 700;
        margin-bottom: 30px;
        letter-spacing: 1px;
        font-size: 2.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        background: linear-gradient(135deg, #007bff, #0056b3);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }

    .card {
        background: white;
        padding: 32px 24px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        text-align: center;
        border-left: 4px solid #007bff;
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, transparent 0%, rgba(0,123,255,0.02) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .card.clickable {
        cursor: pointer;
    }

    .card.clickable:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 16px 48px rgba(0,0,0,0.15);
        border-left-color: #28a745;
    }

    .card.clickable:hover::before {
        opacity: 1;
    }

    .card-icon {
        font-size: 2.5rem;
        margin-bottom: 12px;
        display: block;
    }

    .card h3 {
        font-size: 3rem;
        color: #007bff;
        margin: 0 0 8px 0;
        font-weight: 700;
        transition: all 0.3s ease;
    }

    .card.clickable:hover h3 {
        color: #28a745;
        transform: scale(1.1);
    }

    .card p {
        color: #666;
        margin: 0 0 16px 0;
        font-size: 1rem;
        font-weight: 500;
    }

    .card-arrow {
        font-size: 1.5rem;
        color: #007bff;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .card.clickable:hover .card-arrow {
        opacity: 1;
        transform: translateX(8px);
        color: #28a745;
    }

    .satisfaction-bar {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        margin-top: 12px;
        overflow: hidden;
        position: relative;
    }

    .satisfaction-fill {
        height: 100%;
        background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
        border-radius: 4px;
        transition: width 1s ease;
    }

    /* Section Headers */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

    .section-header h3 {
        color: #333;
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }

    .filter-buttons, .chart-controls, .view-toggles, .performance-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .filter-btn, .view-btn, .toggle-btn, .perf-btn {
        padding: 8px 16px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        color: #6c757d;
    }

    .filter-btn:hover, .view-btn:hover, .toggle-btn:hover, .perf-btn:hover {
        border-color: #007bff;
        color: #007bff;
        transform: translateY(-2px);
    }

    .filter-btn.active, .view-btn.active, .toggle-btn.active, .perf-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }

    .filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
    }

    .filter-section {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
    }

    .filter-label {
        font-weight: 600;
        color: #495057;
        font-size: 0.85rem;
        margin: 0;
    }

    .filter-dropdown {
        padding: 8px 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        color: #495057;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .filter-dropdown:hover {
        border-color: #007bff;
    }

    .filter-dropdown:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .clear-filters-btn {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .clear-filters-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .active-filters {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
    }

    .filter-indicator {
        font-weight: 600;
        color: #495057;
        font-size: 0.85rem;
    }

    .filter-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .filter-badge.sector {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }

    .filter-badge.company-size {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }

    .satisfaction-details {
        margin-top: 8px;
        text-align: center;
    }

    .satisfaction-details small {
        color: #6c757d;
        font-size: 0.75rem;
    }

    .chart-container {
        background: white;
        padding: 32px;
        margin-bottom: 30px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        border-top: 4px solid #007bff;
        transition: all 0.3s ease;
    }

    .chart-container:hover {
        box-shadow: 0 12px 48px rgba(0,0,0,0.12);
        transform: translateY(-4px);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .chart-header h4 {
        color: #333;
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
    }

    .interactive-bar-chart {
        margin-top: 20px;
    }

    .interactive-bar-item {
        margin-bottom: 20px;
        padding: 16px;
        border-radius: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 2px solid transparent;
    }

    .interactive-bar-item:hover, .interactive-bar-item.hovered {
        background: rgba(0,123,255,0.05);
        border-color: #007bff;
        transform: translateX(8px);
    }

    .bar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .bar-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: #333;
        font-size: 1rem;
    }

    .sector-icon {
        font-size: 1.2rem;
    }

    .bar-value-display {
        font-weight: 700;
        color: #007bff;
        font-size: 1.1rem;
    }

    .bar-wrapper {
        position: relative;
        height: 12px;
        background: #e9ecef;
        border-radius: 6px;
        overflow: hidden;
    }

    .completion-progress-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: rgba(0,0,0,0.1);
        border-radius: 6px;
    }

    .completion-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 6px;
        transition: width 0.8s ease;
    }

    .completion-bar {
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin: 8px 0 4px 0;
        overflow: hidden;
    }

    .completion-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 3px;
        transition: width 0.8s ease;
    }

    .completion-stats {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #e9ecef;
    }

    .completion-text {
        font-size: 0.85rem;
        color: #666;
        font-weight: 500;
        text-align: center;
        display: block;
        margin-top: 4px;
    }

    .interactive-bar {
        height: 100%;
        border-radius: 6px;
        position: relative;
        animation: slideIn 0.8s ease;
        transition: all 0.3s ease;
    }

    .interactive-bar-item:hover .interactive-bar {
        transform: scaleY(1.2);
    }

    .bar-shine {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: shine 2s ease-in-out infinite;
    }

    .slideIn {
        animation: slideIn 0.8s ease;
    }

    .shine {
        animation: shine 2s ease-in-out infinite;
    }

    .sector-dropdown {
        margin-top: 16px;
        padding: 16px;
        background: rgba(0,123,255,0.05);
        border-radius: 8px;
        animation: slideDown 0.3s ease;
    }

    .dropdown-stats {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
    }

    .mini-stat {
        text-align: center;
    }

    .mini-stat-value {
        display: block;
        font-size: 1.4rem;
        font-weight: 700;
        color: #007bff;
    }

    .mini-stat-label {
        font-size: 0.8rem;
        color: #666;
    }

    .satisfaction-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .satisfaction-card {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border-left: 4px solid #007bff;
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .satisfaction-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 50% 50%, rgba(0,123,255,0.05) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .satisfaction-card:hover::before, .satisfaction-card.selected::before {
        opacity: 1;
    }

    .satisfaction-card:hover, .satisfaction-card.selected {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .satisfaction-card.excellent { border-left-color: #28a745; }
    .satisfaction-card.good { border-left-color: #17a2b8; }
    .satisfaction-card.average { border-left-color: #ffc107; }
    .satisfaction-card.poor { border-left-color: #dc3545; }

    .satisfaction-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .satisfaction-header h5 {
        margin: 0;
        color: #333;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .satisfaction-score-big {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
    }

    .satisfaction-meter {
        position: relative;
        margin-bottom: 16px;
    }

    .meter-track {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
    }

    .meter-fill {
        height: 8px;
        background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
        border-radius: 4px;
        transition: width 1s ease;
        position: absolute;
        top: 0;
    }

    .meter-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 4px;
    }

    .meter-label {
        font-size: 0.7rem;
        color: #999;
    }

    .satisfaction-emotion {
        text-align: center;
        font-size: 2rem;
        margin-top: 12px;
    }

    /* Question Performance */
    .question-bars {
        display: flex;
        gap: 16px;
        margin-top: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .question-bar-item {
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .question-bar {
        width: 60px;
        max-height: 200px;
        min-height: 20px;
        border-radius: 30px 30px 4px 4px;
        position: relative;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        transition: all 0.4s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .question-bar.excellent { background: linear-gradient(180deg, #28a745, #20c997); }
    .question-bar.good { background: linear-gradient(180deg, #17a2b8, #20c997); }
    .question-bar.average { background: linear-gradient(180deg, #ffc107, #ffcd39); }
    .question-bar.poor { background: linear-gradient(180deg, #dc3545, #e55a5a); }

    .question-bar-item:hover .question-bar, .question-bar-item.selected .question-bar {
        transform: scale(1.1);
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }

    .bar-value {
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        padding: 4px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .question-label {
        text-align: center;
        margin-top: 8px;
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .question-tooltip {
        position: absolute;
        top: -48px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.92);
        color: #fff;
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        z-index: 10;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .question-bar-item:hover .question-tooltip {
        opacity: 1;
    }

    .tooltip-stats {
        margin-top: 4px;
        font-size: 0.7rem;
        opacity: 0.8;
    }

    .interactive-line-chart {
        position: relative;
        height: 350px;
        margin: 20px 0;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-radius: 12px;
        padding: 24px;
        overflow: hidden;
    }

    .chart-point {
        position: absolute;
        transform: translateX(-50%);
        cursor: pointer;
        z-index: 5;
    }

    .point {
        width: 14px;
        height: 14px;
        background: #007bff;
        border: 3px solid white;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    .point:hover, .point.selected {
        transform: scale(1.4);
        background: #28a745;
        box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }

    .chart-point.hovered .point {
        transform: scale(1.2);
        transition: transform 0.3s ease;
    }

    .point-tooltip {
        position: absolute;
        bottom: 130%;
        left: 50%;
        transform: translateX(-50%) scale(0.95);
        background: linear-gradient(135deg, #007bff 60%, #28a745 100%);
        color: #fff;
        padding: 16px 22px;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 500;
        white-space: nowrap;
        z-index: 20;
        box-shadow: 0 8px 32px rgba(0,0,0,0.25);
        border: 2px solid #fff;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.25s, transform 0.25s;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .data-point:hover .point-tooltip,
    .data-point.selected .point-tooltip {
        opacity: 1;
        transform: translateX(-50%) scale(1.05);
    }

    .point-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 10px solid transparent;
        border-top-color: #007bff;
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
    }

    .point-tooltip .tooltip-header {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .point-tooltip .score-badge {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-left: 6px;
    }

    .point-tooltip .tooltip-period {
        color: #e0e0e0;
        font-size: 0.95rem;
        margin-bottom: 4px;
    }

    .point-tooltip .tooltip-details {
        font-size: 0.9rem;
        color: #f8f9fa;
        margin-top: 2px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        align-items: center;
    }

    .point-tooltip .recent-indicator {
        color: #ffc107 !important;
        font-weight: 700;
        font-size: 0.95rem;
        margin-top: 2px;
    }

    /* Sector Cards Grid */
    .sector-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .enhanced-sector-card {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        border-left: 4px solid #007bff;
        transition: all 0.4s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .enhanced-sector-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, transparent, rgba(0,123,255,0.03));
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .enhanced-sector-card:hover::before, .enhanced-sector-card.selected::before {
        opacity: 1;
    }

    .enhanced-sector-card:hover, .enhanced-sector-card.selected {
        transform: translateY(-8px);
        box-shadow: 0 16px 48px rgba(0,0,0,0.15);
    }

    .sector-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .sector-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .sector-icon-large {
        font-size: 1.8rem;
    }

    .sector-title h4 {
        margin: 0;
        color: #333;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .expand-icon {
        font-size: 1.5rem;
        color: #999;
        transition: transform 0.3s ease;
    }

    .expand-icon.expanded {
        transform: rotate(180deg);
    }

    .sector-quick-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
    }

    .quick-stat {
        text-align: center;
    }

    .stat-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        background: conic-gradient(var(--color) var(--fill), #e9ecef var(--fill));
        position: relative;
    }

    .stat-circle::before {
        content: '';
        position: absolute;
        inset: 6px;
        border-radius: 50%;
        background: white;
    }

    .stat-circle span {
        font-weight: 700;
        color: #333;
        font-size: 1rem;
        position: relative;
        z-index: 1;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 8px;
        display: block;
    }

    .quick-stat label {
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
    }

    .sector-expanded-content {
        opacity: 1;
        max-height: 500px;
        transition: opacity 0.4s ease, max-height 0.4s ease;
        border-top: 1px solid #e9ecef;
        padding-top: 20px;
        margin-top: 20px;
    }

    .trend-indicators {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
    }

    .trend-item {
        padding: 12px;
        background: rgba(0,123,255,0.05);
        border-radius: 8px;
        border-left: 3px solid #007bff;
    }

    .trend-label {
        font-size: 0.8rem;
        color: #666;
        display: block;
        margin-bottom: 4px;
    }

    .trend-value {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .mini-bars-interactive {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 12px;
    }

    .mini-bar-interactive {
        position: relative;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .mini-bar-interactive:hover {
        transform: translateY(-2px);
    }

    .mini-bar-container {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .mini-bar-bg {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        flex: 1;
    }

    .mini-bar-fill {
        position: absolute;
        height: 8px;
        border-radius: 4px;
        transition: width 0.8s ease;
        left: 20px;
        right: 0;
    }

    .mini-bar-fill.excellent { background: #28a745; }
    .mini-bar-fill.good { background: #17a2b8; }
    .mini-bar-fill.average { background: #ffc107; }
    .mini-bar-fill.poor { background: #dc3545; }

    .mini-bar-label {
        font-size: 0.8rem;
        color: #666;
        min-width: 20px;
        font-weight: 500;
    }

    .mini-bar-tooltip {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        white-space: nowrap;
        z-index: 10;
    }

    .sector-table {
        margin-top: 20px;
        overflow-x: auto;
    }

    .interactive-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .interactive-table th {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        position: relative;
    }

    .interactive-table th:hover {
        background: linear-gradient(135deg, #0056b3, #004085);
    }

    .table-row {
        transition: all 0.2s ease;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
    }

    .table-row:hover, .table-row.selected {
        background: rgba(0,123,255,0.05);
        transform: scale(1.01);
    }

    .table-row td {
        padding: 16px 12px;
        color: #333;
    }

    .table-sector {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .table-sector-icon {
        font-size: 1.1rem;
    }

    .response-count {
        background: #007bff;
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .score-cell {
        font-weight: 600;
        color: #333;
        padding: 6px 12px;
        border-radius: 8px;
        background: rgba(0,123,255,0.1);
    }

    .loading-spinner {
        text-align: center;
        padding: 80px;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    .no-data {
        text-align: center;
        padding: 80px;
        color: #666;
        font-size: 1.2rem;
    }

    .dashboard-responsive {
        
    }

    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .sector-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    html {
        scroll-behavior: smooth;
    }

    .navigation-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    .navigation-card {
        background: white;
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .navigation-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, transparent, rgba(0,123,255,0.02) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .navigation-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        border-color: #007bff;
    }

    .navigation-card:hover::before {
        opacity: 1;
    }

    .navigation-card .card-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        text-align: center;
    }

    .navigation-card h4 {
        text-align: center;
        margin: 0 0 16px 0;
        color: #333;
        font-size: 1.4rem;
        font-weight: 600;
    }

    .navigation-card .card-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 16px;
    }

    .navigation-card .stat-item {
        text-align: center;
    }

    .navigation-card .stat-number {
        display: block;
        font-size: 1.8rem;
        font-weight: 700;
        color: #007bff;
        margin-bottom: 4px;
    }

    .navigation-card .stat-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
    }

    .navigation-card .card-meta {
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 8px;
    }

    .navigation-card .card-arrow {
        text-align: center;
        font-size: 2rem;
        color: #007bff;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .navigation-card:hover .card-arrow {
        opacity: 1;
        transform: translateX(8px);
        color: #28a745;
    }

    /* Detailed Analysis */
    .detailed-analysis-container {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        margin-top: 20px;
    }

    .analysis-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e9ecef;
    }

    .project-info h4 {
        color: #007bff;
        margin: 0 0 12px 0;
        font-size: 1.6rem;
    }

    .project-info p {
        margin: 4px 0;
        color: #666;
    }

    .question-analysis-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }

    .question-analysis-item {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 12px;
        border-left: 4px solid #007bff;
    }

    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .question-number {
        font-weight: 600;
        color: #007bff;
        font-size: 1.1rem;
    }

    .question-score {
        font-weight: 700;
        font-size: 1.2rem;
        padding: 4px 8px;
        border-radius: 6px;
        color: white;
    }

    .question-score.excellent { background: #28a745; }
    .question-score.good { background: #17a2b8; }
    .question-score.average { background: #ffc107; color: #333; }
    .question-score.poor { background: #dc3545; }

    .question-text {
        margin-bottom: 12px;
        font-size: 0.9rem;
        color: #555;
        font-weight: 500;
    }

    .question-bar-container {
        position: relative;
        height: 8px;
        background: #dee2e6;
        border-radius: 4px;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .question-bar-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 0.8s ease;
    }

    .question-bar-fill.excellent { background: #28a745; }
    .question-bar-fill.good { background: #17a2b8; }
    .question-bar-fill.average { background: #ffc107; }
    .question-bar-fill.poor { background: #dc3545; }

    .question-stats {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #666;
    }

    .responses-table {
        margin-top: 16px;
    }

    .responses-table table {
        width: 100%;
        border-collapse: collapse;
    }

    .responses-table th,
    .responses-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }

    .responses-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .responses-table tr:hover {
        background-color: #f8f9fa;
    }

    .responses-table code {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .responses-table .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .bg-success { background-color: #28a745 !important; color: white; }
    .bg-info { background-color: #17a2b8 !important; color: white; }
    .bg-warning { background-color: #ffc107 !important; color: #333; }
    .bg-danger { background-color: #dc3545 !important; color: white; }

    .trends-container {
        margin-top: 20px;
    }

    .trend-summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 30px;
    }

    .trend-card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        text-align: center;
        transition: all 0.3s ease;
        border-left: 4px solid #007bff;
    }

    .trend-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .trend-icon {
        font-size: 2rem;
        margin-bottom: 8px;
    }

    .trend-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 4px;
        color: #007bff;
    }

    .trend-value.positive {
        color: #28a745;
    }

    .trend-value.negative {
        color: #dc3545;
    }

    .trend-value.neutral {
        color: #6c757d;
    }

    .trend-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .trend-period {
        font-size: 0.8rem;
        color: #666;
    }

    .simple-trend-chart {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 20px;
    }

    .visual-trend-chart {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }

    .line-chart-container {
        margin-top: 20px;
        position: relative;
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #dee2e6;
    }

    .chart-grid {
        display: flex;
        height: 300px;
        position: relative;
    }

    .y-axis {
        width: 40px;
        position: relative;
        border-right: 2px solid #333;
        margin-right: 10px;
    }

    .y-label {
        position: absolute;
        right: 50px;
        transform: translateY(50%);
        font-size: 0.9rem;
        font-weight: 600;
        color: #666;
        background: white;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }

    .chart-area {
        flex: 1;
        position: relative;
        border-bottom: 2px solid #333;
        margin-left: 10px;
    }

    .grid-lines {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .grid-line-horizontal {
        position: absolute;
        left: 0;
        right: 0;
        height: 1px;
        background: #e9ecef;
        opacity: 0.7;
    }

    .line-chart-content {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .trend-area {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.2;
        background: linear-gradient(to bottom, #007bff, transparent);
        border-radius: 4px 4px 0 0;
    }

    .trend-line {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, #007bff, #28a745, #007bff);
        height: 3px;
        border-radius: 2px;
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        z-index: 1;
    }

    .data-point {
        position: absolute;
        transform: translate(-50%, 50%);
        z-index: 2;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .data-point:hover {
        transform: translate(-50%, 50%) scale(1.2);
        z-index: 10;
    }

    .data-point.selected {
        transform: translate(-50%, 50%) scale(1.3);
        z-index: 10;
    }

    .point-circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid white;
        position: relative;
        box-shadow: 0 3px 12px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .data-point.excellent .point-circle {
        background: #28a745;
        border-color: #1e7e34;
    }

    .data-point.good .point-circle {
        background: #17a2b8;
        border-color: #117a8b;
    }

    .data-point.average .point-circle {
        background: #ffc107;
        border-color: #d39e00;
    }

    .data-point.poor .point-circle {
        background: #dc3545;
        border-color: #bd2130;
    }

    .data-point.recent .point-circle {
        border-width: 4px;
        border-color: #007bff;
        box-shadow: 0 3px 12px rgba(0,0,0,0.2), 0 0 0 4px rgba(0,123,255,0.3);
    }

    .point-value {
        font-size: 0.7rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        position: absolute;
        white-space: nowrap;
    }

    .point-tooltip {
        position: absolute;
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.85rem;
        white-space: nowrap;
        z-index: 20;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .point-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0,0,0,0.9);
    }

    .tooltip-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
    }

    .tooltip-header strong {
        font-size: 1.1rem;
        color: #fff;
    }

    .score-badge {
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .score-badge.excellent {
        background: #28a745;
        color: white;
    }

    .score-badge.good {
        background: #17a2b8;
        color: white;
    }

    .score-badge.average {
        background: #ffc107;
        color: #333;
    }

    .score-badge.poor {
        background: #dc3545;
        color: white;
    }

    .tooltip-period {
        color: #ccc;
        margin-bottom: 6px;
        font-size: 0.8rem;
    }

    .tooltip-details {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.75rem;
        color: #ddd;
    }

    .recent-indicator {
        color: #ffc107 !important;
        font-weight: 600;
    }

    .x-axis {
        position: absolute;
        bottom: -25px;
        left: 0;
        right: 0;
        height: 20px;
    }

    .x-label {
        position: absolute;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
        background: white;
        padding: 2px 4px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        color: #666;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .legend-dot.excellent {
        background: #28a745;
    }

    .legend-dot.good {
        background: #17a2b8;
    }

    .legend-dot.average {
        background: #ffc107;
    }

    .legend-dot.poor {
        background: #dc3545;
    }

    .legend-dot.recent {
        background: #007bff;
        border-color: #0056b3;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.3);
    }

    .recent-legend {
        font-weight: 600;
        color: #007bff;
    }

    .trend-chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e9ecef;
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
    }

    .chart-range {
        font-size: 0.9rem;
        color: #666;
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 8px;
    }

    .trend-bars-container {
        display: flex;
        gap: 8px;
        align-items: end;
        min-height: 200px;
        padding: 20px 0;
        overflow-x: auto;
    }

    .trend-bar-item {
        flex: 1;
        min-width: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .trend-bar-item:hover, .trend-bar-item.selected {
        transform: scale(1.05);
    }

    .trend-bar {
        width: 100%;
        max-width: 40px;
        min-height: 20px;
        border-radius: 8px 8px 4px 4px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding: 4px;
        position: relative;
        transition: all 0.4s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .trend-bar.excellent {
        background: linear-gradient(180deg, #28a745, #20c997);
        border-left: 3px solid #1e7e34;
    }

    .trend-bar.good {
        background: linear-gradient(180deg, #17a2b8, #20c997);
        border-left: 3px solid #117a8b;
    }

    .trend-bar.average {
        background: linear-gradient(180deg, #ffc107, #ffcd39);
        border-left: 3px solid #d39e00;
    }

    .trend-bar.poor {
        background: linear-gradient(180deg, #dc3545, #e55a5a);
        border-left: 3px solid #bd2130;
    }

    .trend-bar.recent {
        border: 2px solid #007bff;
        box-shadow: 0 4px 16px rgba(0,123,255,0.3);
    }

    .trend-bar-value {
        color: white;
        font-weight: 700;
        font-size: 0.8rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        margin-bottom: 2px;
    }

    .trend-bar-label {
        font-size: 0.75rem;
        color: #666;
        font-weight: 500;
        margin-top: 8px;
        text-align: center;
        transform: rotate(-45deg);
        transform-origin: center;
        white-space: nowrap;
    }

    .trend-tooltip-simple {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 10;
        margin-bottom: 8px;
        text-align: center;
    }

    .trend-tooltip-simple::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: rgba(0,0,0,0.9);
    }

    .trend-insights {
        background: white;
        padding: 20px;
        border-radius: 12px;
        border-left: 4px solid #17a2b8;
        margin-bottom: 20px;
    }

    .insight-item {
        margin-bottom: 12px;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .insight-item:last-child {
        margin-bottom: 0;
    }

    .insight-item strong {
        color: #333;
        margin-right: 8px;
    }

    .insight-item span {
        color: #666;
    }

    .no-trend-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.1rem;
        background: #f8f9fa;
        border-radius: 12px;
        border: 2px dashed #dee2e6;
    }
</style>

<!--
.goal-line {
    z-index: 3;
    border-radius: 3px;
    width: 4px !important;
    background: #00e676 !important;
    box-shadow: 0 0 10px 2px #00e676, 0 0 2px 1px #fff;
    opacity: 1 !important;
} -->

@code {
    List<SurveyResponse> surveyResponses = new List<SurveyResponse>();
    bool isLoading = true;
    Dictionary<string, int> sectorCounts = new Dictionary<string, int>();
    Dictionary<string, int> companySizeCounts = new Dictionary<string, int>();
    Dictionary<string, double> sectorAverages = new Dictionary<string, double>();
    Dictionary<string, double> companySizeAverages = new Dictionary<string, double>();
    double avgSatisfaction = 0;

    // Interactive states
    string selectedSectorFilter = "all";
    string selectedCompanySizeFilter = "all";
    string chartView = "count";
    string detailView = "cards";
    string? selectedSector = null;
    string? selectedTableRow = null;
    string? hoveredSector = null;
    string? hoveredMiniBar = null;
    int? selectedQuestion = null;
    int? hoveredPoint = null;
    
    // Trends states
    string trendsView = "monthly";
    int? selectedTrendPoint = null;
    
    // Hierarchical navigation states
    string? selectedCustomer = null;
    string? selectedProject = null;
    string currentNavigationLevel = "sectors"; // sectors, customers, projects, analysis
    
    // Expansion states
    HashSet<string> expandedSectors = new HashSet<string>();
    HashSet<string> expandedSectorCards = new HashSet<string>();
    
    // Table sorting
    string sortColumn = "sector";
    bool sortAscending = true;
    
    // User role for filtering
    string userRole = "";

    protected override async Task OnInitializedAsync()
    {
        // Get user role for filtering
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity.IsAuthenticated)
        {
            var roleClaim = authState.User.FindFirst("Role");
            userRole = roleClaim?.Value ?? "";
        }
        
        await LoadSurveyData();
    }

    async Task LoadSurveyData()
    {
        isLoading = true;
        try
        {
            var response = await httpClient.GetFromJsonAsync<List<SurveyResponse>>("api/survey/responses");
            surveyResponses = response ?? new List<SurveyResponse>();
            
            CalculateStatistics();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading survey data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    void CalculateStatistics()
    {
        if (!surveyResponses.Any()) return;

        // Calculate sector counts
        sectorCounts = surveyResponses
            .GroupBy(r => r.Sector)
            .ToDictionary(g => g.Key, g => g.Count());

        // Calculate company size counts
        companySizeCounts = surveyResponses
            .Where(r => !string.IsNullOrEmpty(r.CompanySize))
            .GroupBy(r => r.CompanySize)
            .ToDictionary(g => g.Key, g => g.Count());

        // Calculate sector averages for overall satisfaction
        sectorAverages = surveyResponses
            .GroupBy(r => r.Sector)
            .ToDictionary(g => g.Key, g => g.Average(r => r.Question1));

        // Calculate company size averages for overall satisfaction
        companySizeAverages = surveyResponses
            .Where(r => !string.IsNullOrEmpty(r.CompanySize))
            .GroupBy(r => r.CompanySize)
            .ToDictionary(g => g.Key, g => g.Average(r => r.Question1));

        // Calculate overall average satisfaction
        avgSatisfaction = surveyResponses.Average(r => r.Question1);
    }

    // Interactive Functions
    List<string> GetUniqueSectors()
    {
        return surveyResponses
            .Select(r => r.Sector)
            .Where(s => !string.IsNullOrEmpty(s))
            .Distinct()
            .OrderBy(s => s)
            .ToList();
    }

    List<string> GetUniqueCompanySizes()
    {
        return surveyResponses
            .Select(r => r.CompanySize)
            .Where(s => !string.IsNullOrEmpty(s))
            .Distinct()
            .OrderBy(s => s)
            .ToList();
    }

    void SetFilter(string filter)
    {
        // This method is kept for backward compatibility but may need updates
        // for dual filtering system if used elsewhere
        StateHasChanged();
    }

    void SetChartView(string view)
    {
        chartView = view;
        StateHasChanged();
    }

    void SetDetailView(string view)
    {
        detailView = view;
        StateHasChanged();
    }

    void SetTrendsView(string view)
    {
        trendsView = view;
        selectedTrendPoint = null; // Reset selection when changing view
        StateHasChanged();
    }

    void SelectSector(string sector)
    {
        selectedSector = selectedSector == sector ? null : sector;
        StateHasChanged();
    }

    void SelectTableRow(string sector)
    {
        selectedTableRow = selectedTableRow == sector ? null : sector;
        StateHasChanged();
    }

    void ToggleSectorDetails(string sector)
    {
        if (expandedSectors.Contains(sector))
            expandedSectors.Remove(sector);
        else
            expandedSectors.Add(sector);
        StateHasChanged();
    }

    void ToggleSectorCard(string sector)
    {
        if (expandedSectorCards.Contains(sector))
            expandedSectorCards.Remove(sector);
        else
            expandedSectorCards.Add(sector);
        StateHasChanged();
    }

    // Hierarchical navigation methods
    void NavigateToCustomers(string sector)
    {
        // Check if user has access to this sector in detailed analysis
        if (userRole != "Admin")
        {
            var allowedSectors = GetRoleBasedSectors().Keys;
            if (!allowedSectors.Contains(sector))
            {
                // User doesn't have access to this sector in detailed analysis
                return; // Do nothing, don't navigate
            }
        }
        
        selectedSector = sector;
        currentNavigationLevel = "customers";
        selectedCustomer = null;
        selectedProject = null;
        StateHasChanged();
    }

    void NavigateToProjects(string customer)
    {
        selectedCustomer = customer;
        currentNavigationLevel = "projects";
        selectedProject = null;
        StateHasChanged();
    }

    void NavigateToAnalysis(string project)
    {
        selectedProject = project;
        currentNavigationLevel = "analysis";
        StateHasChanged();
    }

    void NavigateBack()
    {
        if (currentNavigationLevel == "analysis")
        {
            currentNavigationLevel = "projects";
            selectedProject = null;
        }
        else if (currentNavigationLevel == "projects")
        {
            currentNavigationLevel = "customers";
            selectedCustomer = null;
        }
        else if (currentNavigationLevel == "customers")
        {
            currentNavigationLevel = "sectors";
            selectedSector = null;
        }
        StateHasChanged();
    }

    void ToggleQuestion(int question)
    {
        selectedQuestion = selectedQuestion == question ? null : question;
        StateHasChanged();
    }

    void SelectQuestionPoint(int question)
    {
        selectedQuestion = selectedQuestion == question ? null : question;
        StateHasChanged();
    }

    void SelectTrendPoint(int index)
    {
        selectedTrendPoint = selectedTrendPoint == index ? null : index;
        StateHasChanged();
    }

    void HandleLineChartClick()
    {
        // Handle line chart clicks if needed
    }

    void ScrollToSection(string sectionId)
    {
        // This would need JavaScript interop to work properly
        // For now, we'll just do a simple state change
        StateHasChanged();
    }

    void SortTable(string column)
    {
        if (sortColumn == column)
            sortAscending = !sortAscending;
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        StateHasChanged();
    }

    // Helper Functions
    Dictionary<string, int> GetFilteredSectors()
    {
        // Show all sectors in main overview (updated for dual filtering)
        return sectorCounts;
    }

    Dictionary<string, int> GetRoleBasedSectors()
    {
        // Admin can see all sectors
        if (userRole == "Admin")
            return sectorCounts;
        
        // Role-based filtering for other users
        if (userRole == "Health")
            return sectorCounts.Where(kvp => kvp.Key == "Health").ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        else if (userRole == "Tech")
            return sectorCounts.Where(kvp => kvp.Key == "Tech").ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        else if (userRole == "Energy")
            return sectorCounts.Where(kvp => kvp.Key == "Energy").ToDictionary(kvp => kvp.Key, kvp => kvp.Value);
        
        // Default: return all (for edge cases)
        return sectorCounts;
    }

    int GetCompletedCountForSector(string sector)
    {
        return surveyResponses.Count(r => r.Sector == sector && r.DateCompleted.HasValue);
    }

    int GetCompletedCountForCompanySize(string companySize)
    {
        return surveyResponses.Count(r => r.CompanySize == companySize && r.DateCompleted.HasValue);
    }

    Dictionary<string, int> GetFilteredCompanySizes()
    {
        // Show all company sizes (updated for dual filtering)
        return companySizeCounts;
    }

    double GetCompanySizeAverage(string companySize)
    {
        var responses = surveyResponses.Where(r => r.CompanySize == companySize).ToList();
        if (!responses.Any()) return 0;
        return responses.Average(r => r.Question1);
    }

    Dictionary<string, double> GetCombinedFilteredSatisfactionData()
    {
        var filteredResponses = GetCombinedFilteredResponses();
        
        // Group by a combination key that represents the current view
        var groupedData = new Dictionary<string, List<SurveyResponse>>();
        
        if (selectedSectorFilter != "all" && selectedCompanySizeFilter != "all")
        {
            // Both filters applied - show individual survey responses or aggregated data
            var key = $"{selectedSectorFilter} - {selectedCompanySizeFilter}";
            groupedData[key] = filteredResponses.ToList();
        }
        else if (selectedSectorFilter != "all")
        {
            // Only sector filter applied - group by company size within that sector
            groupedData = filteredResponses
                .Where(r => !string.IsNullOrEmpty(r.CompanySize))
                .GroupBy(r => $"{selectedSectorFilter} - {r.CompanySize}")
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        else if (selectedCompanySizeFilter != "all")
        {
            // Only company size filter applied - group by sector within that company size
            groupedData = filteredResponses
                .Where(r => !string.IsNullOrEmpty(r.Sector))
                .GroupBy(r => $"{r.Sector} - {selectedCompanySizeFilter}")
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        else
        {
            // No filters applied - group by sector
            groupedData = filteredResponses
                .Where(r => !string.IsNullOrEmpty(r.Sector))
                .GroupBy(r => r.Sector)
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        
        return groupedData
            .Where(kvp => kvp.Value.Any())
            .ToDictionary(kvp => kvp.Key, kvp => kvp.Value.Average(r => r.Question1));
    }

    List<SurveyResponse> GetCombinedFilteredResponses()
    {
        var responses = GetRoleBasedResponses();

        // Apply sector filter
        if (selectedSectorFilter != "all")
        {
            responses = responses.Where(r => r.Sector == selectedSectorFilter).ToList();
        }

        // Apply company size filter
        if (selectedCompanySizeFilter != "all")
        {
            responses = responses.Where(r => r.CompanySize == selectedCompanySizeFilter).ToList();
        }

        return responses;
    }

    List<SurveyResponse> GetRoleBasedResponses()
    {
        // Admin can see all responses
        if (userRole == "Admin")
            return surveyResponses;
        
        // Filter responses by user's role
        if (userRole == "Health" || userRole == "Tech" || userRole == "Energy")
            return surveyResponses.Where(r => r.Sector == userRole).ToList();
        
        // Default: return all (for edge cases)
        return surveyResponses;
    }

    List<string> GetCustomersForSector(string sector)
    {
        return GetRoleBasedResponses()
            .Where(r => r.Sector == sector)
            .Select(r => r.CustomerName)
            .Distinct()
            .OrderBy(c => c)
            .ToList();
    }

    List<string> GetProjectsForCustomer(string sector, string customer)
    {
        return GetRoleBasedResponses()
            .Where(r => r.Sector == sector && r.CustomerName == customer)
            .Select(r => r.ProjectName)
            .Distinct()
            .OrderBy(p => p)
            .ToList();
    }

    List<SurveyResponse> GetProjectResponses(string sector, string customer, string project)
    {
        return GetRoleBasedResponses()
            .Where(r => r.Sector == sector && r.CustomerName == customer && r.ProjectName == project)
            .ToList();
    }

    int GetQuestionScore(SurveyResponse response, int questionNumber)
    {
        return questionNumber switch
        {
            1 => response.Question1,
            2 => response.Question2,
            3 => response.Question3,
            4 => response.Question4,
            5 => response.Question5,
            6 => response.Question6,
            7 => response.Question7,
            8 => response.Question8,
            9 => response.Question9,
            _ => 0
        };
    }

    IEnumerable<string> GetSortedSectors()
    {
        var sectors = sectorCounts.Keys.AsEnumerable();
        
        sectors = sortColumn switch
        {
            "sector" => sortAscending ? sectors.OrderBy(s => s) : sectors.OrderByDescending(s => s),
            "responses" => sortAscending ? sectors.OrderBy(s => sectorCounts[s]) : sectors.OrderByDescending(s => sectorCounts[s]),
            "satisfaction" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "satisfaction")) : sectors.OrderByDescending(s => GetSectorAverage(s, "satisfaction")),
            "professionalism" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "professionalism")) : sectors.OrderByDescending(s => GetSectorAverage(s, "professionalism")),
            "growth" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "growth")) : sectors.OrderByDescending(s => GetSectorAverage(s, "growth")),
            "value" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "value")) : sectors.OrderByDescending(s => GetSectorAverage(s, "value")),
            "likelihood" => sortAscending ? sectors.OrderBy(s => GetSectorAverage(s, "likelihood")) : sectors.OrderByDescending(s => GetSectorAverage(s, "likelihood")),
            _ => sectors
        };
        
        return sectors;
    }

    string GetSortIcon(string column)
    {
        if (sortColumn != column) return "‚ÜïÔ∏è";
        return sortAscending ? "‚¨ÜÔ∏è" : "‚¨áÔ∏è";
    }

    double GetSectorAverage(string sector, string type)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector);
        if (!sectorResponses.Any()) return 0;
        
        return type switch
        {
            "satisfaction" => sectorResponses.Average(r => r.Question1),
            "professionalism" => sectorResponses.Average(r => r.Question2),
            "growth" => sectorResponses.Average(r => r.Question3),
            "value" => sectorResponses.Average(r => r.Question4),
            "likelihood" => sectorResponses.Average(r => r.Question9),
            _ => 0
        };
    }

    int GetBestQuestion(string sector)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector).ToList();
        if (!sectorResponses.Any()) return 1;
        
        var averages = new Dictionary<int, double>();
        for (int q = 1; q <= 9; q++)
        {
            averages[q] = GetSectorQuestionAverage(sector, q);
        }
        
        return averages.OrderByDescending(kvp => kvp.Value).First().Key;
    }

    double GetBestQuestionScore(string sector)
    {
        return GetSectorQuestionAverage(sector, GetBestQuestion(sector));
    }

    int GetWorstQuestion(string sector)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector).ToList();
        if (!sectorResponses.Any()) return 1;
        
        var averages = new Dictionary<int, double>();
        for (int q = 1; q <= 9; q++)
        {
            averages[q] = GetSectorQuestionAverage(sector, q);
        }
        
        return averages.OrderBy(kvp => kvp.Value).First().Key;
    }

    double GetWorstQuestionScore(string sector)
    {
        return GetSectorQuestionAverage(sector, GetWorstQuestion(sector));
    }

    string GetSectorShortName(string sector)
    {
        return sector switch
        {
            "Tech & Digitalization" => "Tech",
            "Health" => "Health",
            "Energy" => "Energy",
            _ => sector
        };
    }

    string GetSectorIcon(string sector)
    {
        return sector switch
        {
            "Health" => "üè•",
            "Tech & Digitalization" => "üíª",
            "Energy" => "‚ö°",
            _ => "üè¢"
        };
    }

    string GetSatisfactionEmoji(double satisfaction)
    {
        return satisfaction switch
        {
            >= 9 => "ü§©",
            >= 8 => "üòç",
            >= 7 => "üòä",
            >= 6 => "üôÇ",
            >= 5 => "üòê",
            >= 4 => "üòï",
            >= 3 => "üòû",
            _ => "üò¢"
        };
    }

    string GetQuestionText(int question)
    {
        return question switch
        {
            1 => "Overall Satisfaction",
            2 => "Professionalism",
            3 => "Growth Impact",
            4 => "Value for Money",
            5 => "Solution Fit",
            6 => "Communication",
            7 => "Timeliness",
            8 => "Advisor Expertise",
            9 => "Future Use Likelihood",
            _ => $"Question {question}"
        };
    }

    string GetQuestionCategory(double avg)
    {
        return avg switch
        {
            >= 8 => "Excellent",
            >= 6 => "Good",
            >= 4 => "Average",
            _ => "Needs Improvement"
        };
    }

    string GetSectorColor(string sector)
    {
        return sector switch
        {
            "Health" => "#ff6b6b",
            "Tech & Digitalization" => "#4ecdc4",
            "Energy" => "#45b7d1",
            _ => "#95a5a6"
        };
    }

    string GetSectorColorDark(string sector)
    {
        return sector switch
        {
            "Health" => "#e74c3c",
            "Tech & Digitalization" => "#16a085",
            "Energy" => "#2980b9",
            _ => "#7f8c8d"
        };
    }

    string GetCompanySizeIcon(string companySize)
    {
        return companySize switch
        {
            "Micro" => "üè™",
            "SME" => "üè¢",
            "Large" => "üè≠",
            _ => "üë•"
        };
    }

    string GetCompanySizeColor(string companySize)
    {
        return companySize switch
        {
            "Micro" => "#f39c12",
            "SME" => "#3498db", 
            "Large" => "#9b59b6",
            _ => "#95a5a6"
        };
    }

    string GetCompanySizeColorDark(string companySize)
    {
        return companySize switch
        {
            "Micro" => "#e67e22",
            "SME" => "#2980b9",
            "Large" => "#8e44ad",
            _ => "#7f8c8d"
        };
    }

    double GetQuestionAverage(int questionNumber)
    {
        if (!surveyResponses.Any()) return 0;
        
        return questionNumber switch
        {
            1 => surveyResponses.Average(r => r.Question1),
            2 => surveyResponses.Average(r => r.Question2),
            3 => surveyResponses.Average(r => r.Question3),
            4 => surveyResponses.Average(r => r.Question4),
            5 => surveyResponses.Average(r => r.Question5),
            6 => surveyResponses.Average(r => r.Question6),
            7 => surveyResponses.Average(r => r.Question7),
            8 => surveyResponses.Average(r => r.Question8),
            9 => surveyResponses.Average(r => r.Question9),
            _ => 0
        };
    }

    double GetSectorQuestionAverage(string sector, int questionNumber)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector);
        if (!sectorResponses.Any()) return 0;
        
        return questionNumber switch
        {
            1 => sectorResponses.Average(r => r.Question1),
            2 => sectorResponses.Average(r => r.Question2),
            3 => sectorResponses.Average(r => r.Question3),
            4 => sectorResponses.Average(r => r.Question4),
            5 => sectorResponses.Average(r => r.Question5),
            6 => sectorResponses.Average(r => r.Question6),
            7 => sectorResponses.Average(r => r.Question7),
            8 => sectorResponses.Average(r => r.Question8),
            9 => sectorResponses.Average(r => r.Question9),
            _ => 0
        };
    }

    string GetLinePoints()
    {
        var points = new List<string>();
        for (int q = 1; q <= 9; q++)
        {
            var x = (q - 1) * 12.5;
            var y = 100 - (GetQuestionAverage(q) / 10 * 100);
            points.Add($"{x},{y}");
        }
        return string.Join(" ", points);
    }

    // Trend Analysis Methods
    public class TrendDataPoint
    {
        public double Score { get; set; }
        public string Period { get; set; } = "";
        public string ShortPeriod { get; set; } = "";
        public DateTime Date { get; set; }
        public int ResponseCount { get; set; }
    }

    IEnumerable<TrendDataPoint> GetTrendData()
    {
        var completedResponses = surveyResponses.Where(r => r.DateCompleted.HasValue).ToList();
        
        if (!completedResponses.Any()) return new List<TrendDataPoint>();

        var groupedData = trendsView switch
        {
            "quarterly" => GroupByQuarters(completedResponses),
            "yearly" => GroupByYears(completedResponses),
            _ => GroupByMonths(completedResponses) // default to monthly
        };

        return groupedData.OrderBy(t => t.Date);
    }

    IEnumerable<TrendDataPoint> GroupByMonths(List<SurveyResponse> responses)
    {
        return responses
            .GroupBy(r => new { r.DateCompleted!.Value.Year, r.DateCompleted!.Value.Month })
            .Select(g => new TrendDataPoint
            {
                Score = Math.Round(g.Average(r => r.Question1), 1),
                Period = $"{GetMonthName(g.Key.Month)} {g.Key.Year}",
                ShortPeriod = $"{GetMonthName(g.Key.Month).Substring(0, 3)} '{g.Key.Year.ToString().Substring(2)}",
                Date = new DateTime(g.Key.Year, g.Key.Month, 1),
                ResponseCount = g.Count()
            })
            .OrderBy(t => t.Date);
    }

    IEnumerable<TrendDataPoint> GroupByQuarters(List<SurveyResponse> responses)
    {
        return responses
            .GroupBy(r => new { r.DateCompleted!.Value.Year, Quarter = (r.DateCompleted!.Value.Month - 1) / 3 + 1 })
            .Select(g => new TrendDataPoint
            {
                Score = Math.Round(g.Average(r => r.Question1), 1),
                Period = $"Q{g.Key.Quarter} {g.Key.Year}",
                ShortPeriod = $"Q{g.Key.Quarter} '{g.Key.Year.ToString().Substring(2)}",
                Date = new DateTime(g.Key.Year, (g.Key.Quarter - 1) * 3 + 1, 1),
                ResponseCount = g.Count()
            })
            .OrderBy(t => t.Date);
    }

    IEnumerable<TrendDataPoint> GroupByYears(List<SurveyResponse> responses)
    {
        return responses
            .GroupBy(r => r.DateCompleted!.Value.Year)
            .Select(g => new TrendDataPoint
            {
                Score = Math.Round(g.Average(r => r.Question1), 1),
                Period = g.Key.ToString(),
                ShortPeriod = g.Key.ToString(),
                Date = new DateTime(g.Key, 1, 1),
                ResponseCount = g.Count()
            })
            .OrderBy(t => t.Date);
    }

    IEnumerable<TrendDataPoint> GetSectorTrendData(string sector)
    {
        var sectorResponses = surveyResponses.Where(r => r.Sector == sector && r.DateCompleted.HasValue).ToList();
        
        if (!sectorResponses.Any()) return new List<TrendDataPoint>();

        var groupedData = trendsView switch
        {
            "quarterly" => GroupByQuarters(sectorResponses),
            "yearly" => GroupByYears(sectorResponses),
            _ => GroupByMonths(sectorResponses)
        };

        return groupedData.OrderBy(t => t.Date);
    }

    string GetTrendDirection()
    {
        var data = GetTrendData().ToList();
        if (data.Count < 2) return "stable";

        // Compare latest with previous data point
        var latestScore = data.Last().Score;
        var previousScore = data[data.Count - 2].Score;

        var diff = latestScore - previousScore;
        return diff > 0.2 ? "up" : diff < -0.2 ? "down" : "stable";
    }

    double GetTrendPercentage()
    {
        var data = GetTrendData().ToList();
        if (data.Count < 2) return 0;

        // Get the latest and previous data points
        var latestScore = data.Last().Score;
        var previousScore = data[data.Count - 2].Score;

        if (previousScore == 0) return 0;
        return Math.Round(((latestScore - previousScore) / previousScore) * 100, 1);
    }

    TrendDataPoint GetHighestPeriod()
    {
        var data = GetTrendData().ToList();
        return data.Any() ? data.OrderByDescending(t => t.Score).First() : new TrendDataPoint();
    }

    TrendDataPoint GetLowestPeriod()
    {
        var data = GetTrendData().ToList();
        return data.Any() ? data.OrderBy(t => t.Score).First() : new TrendDataPoint();
    }

    string GetTrendAnalysis()
    {
        var data = GetTrendData().ToList();
        if (data.Count < 2) return "Insufficient data for trend analysis.";

        var direction = GetTrendDirection();
        var percentage = Math.Abs(GetTrendPercentage());

        return direction switch
        {
            "up" => $"Your satisfaction scores are trending upward by {percentage}%, indicating improving service quality and customer relationships.",
            "down" => $"Your satisfaction scores are declining by {percentage}%. Consider reviewing recent service delivery and customer feedback.",
            _ => "Your satisfaction scores remain stable. Maintain current service standards to ensure continued customer satisfaction."
        };
    }

    List<string> GetRecurringChallenges()
    {
        var challenges = new List<string>();
        var data = GetTrendData().ToList();
        
        if (data.Count < 3) return challenges;

        // Check for consistently low periods
        var lowPeriods = data.Where(t => t.Score < 6).Count();
        if (lowPeriods > data.Count * 0.3)
        {
            challenges.Add("Recurring low satisfaction periods");
        }

        // Check for declining trend in recent periods
        var recentData = data.TakeLast(5).ToList();
        if (recentData.Count >= 3)
        {
            var isDeclinig = true;
            for (int i = 1; i < recentData.Count; i++)
            {
                if (recentData[i].Score >= recentData[i - 1].Score)
                {
                    isDeclinig = false;
                    break;
                }
            }
            if (isDeclinig) challenges.Add("Recent declining trend");
        }

        return challenges;
    }

    string GetServiceQualityInsight()
    {
        var avgScore = GetTrendData().Any() ? GetTrendData().Average(t => t.Score) : 0;
        
        return avgScore switch
        {
            >= 8.5 => "Outstanding service quality - customers are highly satisfied!",
            >= 7.5 => "Good service quality - customers are generally satisfied.",
            >= 6.5 => "Acceptable service quality - room for improvement exists.",
            >= 5.5 => "Below average service quality - attention needed.",
            _ => "Service quality needs significant improvement - priority action required."
        };
    }

    int GetPeriodResponseCount(string period)
    {
        var data = GetTrendData().FirstOrDefault(t => t.Period == period);
        return data?.ResponseCount ?? 0;
    }

    // Helper methods
    string GetMonthName(int month)
    {
        return new DateTime(2000, month, 1).ToString("MMMM");
    }

    // Visual chart helper methods
    string GetTrendLinePath(List<TrendDataPoint> data)
    {
        if (data.Count < 2) return "";
        
        var points = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - (point.Score / 10.0) * 100; // Invert Y for CSS positioning
            return $"{x}% {y}%";
        });
        
        return $"clip-path: polygon({string.Join(", ", points)});";
    }

    string GetTrendAreaPath(List<TrendDataPoint> data)
    {
        if (data.Count < 2) return "";
        
        var topPoints = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            var y = 100 - (point.Score / 10.0) * 100; // Invert Y for CSS positioning
            return $"{x}% {y}%";
        });
        
        var bottomPoints = data.Select((point, index) => {
            var x = data.Count > 1 ? (index * 100.0 / (data.Count - 1)) : 50;
            return $"{x}% 100%";
        }).Reverse();
        
        return $"clip-path: polygon({string.Join(", ", topPoints)}, {string.Join(", ", bottomPoints)});";
    }

    string GetScoreCategory(double score)
    {
        return score switch
        {
            >= 8 => "Excellent",
            >= 6 => "Good", 
            >= 4 => "Average",
            _ => "Poor"
        };
    }

    // New methods for dual filtering system
    void ClearAllFilters()
    {
        selectedSectorFilter = "all";
        selectedCompanySizeFilter = "all";
        StateHasChanged();
    }

    void SelectItem(string itemKey)
    {
        // Handle selection of satisfaction cards if needed
        selectedSector = itemKey;
        StateHasChanged();
    }

    string GetItemIcon(string itemKey)
    {
        // Determine if this is a sector or company size based on the key format
        if (itemKey.Contains(" - "))
        {
            var parts = itemKey.Split(" - ");
            if (parts.Length == 2)
            {
                // Combined sector-company size format
                return "üè¢üè≠"; // Combined icon
            }
        }
        
        // Check if it's a known sector
        var sectors = GetUniqueSectors();
        if (sectors.Contains(itemKey))
        {
            return GetSectorIcon(itemKey);
        }
        
        // Check if it's a known company size
        var companySizes = GetUniqueCompanySizes();
        if (companySizes.Contains(itemKey))
        {
            return GetCompanySizeIcon(itemKey);
        }
        
        return "üìä"; // Default icon
    }

    string GetItemColor(string itemKey)
    {
        // Determine if this is a sector or company size based on the key format
        if (itemKey.Contains(" - "))
        {
            var parts = itemKey.Split(" - ");
            if (parts.Length == 2)
            {
                // Use sector color for combined items
                return GetSectorColor(parts[0]);
            }
        }
        
        // Check if it's a known sector
        var sectors = GetUniqueSectors();
        if (sectors.Contains(itemKey))
        {
            return GetSectorColor(itemKey);
        }
        
        // Check if it's a known company size
        var companySizes = GetUniqueCompanySizes();
        if (companySizes.Contains(itemKey))
        {
            return GetCompanySizeColor(itemKey);
        }
        
        return "#95a5a6"; // Default color
    }

    int GetFilteredResponseCount(string itemKey)
    {
        var responses = GetCombinedFilteredResponses();
        
        if (itemKey.Contains(" - "))
        {
            // This is a combined filter result, return the total count
            return responses.Count();
        }
        
        // For individual items, filter by that specific item
        var sectors = GetUniqueSectors();
        var companySizes = GetUniqueCompanySizes();
        
        if (sectors.Contains(itemKey))
        {
            return responses.Where(r => r.Sector == itemKey).Count();
        }
        
        if (companySizes.Contains(itemKey))
        {
            return responses.Where(r => r.CompanySize == itemKey).Count();
        }
        
        return responses.Count();
    }
}
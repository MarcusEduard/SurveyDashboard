@page "/survey"
@page "/survey/{SurveyId}"
@using WebAPI.Models
@inject HttpClient httpClient

<div class="survey-page">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">Evaluation Form</h1>
            <p class="page-subtitle">Share your feedback to help us improve our services</p>
        </div>
    </div>
    
    <div class="survey-container">
        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading form...</p>
            </div>
        }
    else if (success || (isExistingSurvey && newResponse.DateCompleted.HasValue))
    {
        <div class="success-message">
            <span>✔</span>
            <h3>Form Completed</h3>
            <p>Thank you! This form has been completed.</p>
            @if (isExistingSurvey && newResponse.DateCompleted.HasValue)
            {
                <p class="completion-info">Completed on: @newResponse.DateCompleted.Value.ToString("MM/dd/yyyy HH:mm", System.Globalization.CultureInfo.InvariantCulture)</p>
            }
        </div>
    }
    else
    {
        <div class="survey-form">
        <div class="form-group">
            <label for="company">Company Name</label>
            <input id="company" type="text" class="form-control" @bind="newResponse.CustomerName" 
                   placeholder="Enter your company name..." 
                   disabled="@(isExistingSurvey)" />
        </div>

        <div class="form-group">
            <label for="sector">Sector</label>
            <select id="sector" class="form-control" @bind="newResponse.Sector" 
                    disabled="@(isExistingSurvey)">
                <option value="">Select a sector...</option>
                <option value="Health">Health</option>
                <option value="Tech & Digitalization">Tech & Digitalization</option>
                <option value="Energy">Energy</option>
            </select>
        </div>

        <div class="form-group">
            <label for="projectname">Project Name</label>
            <input id="projectname" type="text" class="form-control" @bind="newResponse.ProjectName" 
                   placeholder="Enter project name..." 
                   disabled="@(isExistingSurvey)" />
        </div>

        <div class="form-group">
            <label for="projectduration">Project Duration in hours</label>
            <input id="projectduration" type="number" class="form-control" @bind="newResponse.ProjectDuration" 
                   placeholder="Enter duration..." 
                   min="1"
                   max="999"
                   disabled="@(isExistingSurvey)" />
        </div>

        <div class="question-group">
            <label>How satisfied are you with the Trade Councils services overall?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question1 == index ? "selected" : "")"
                            @onclick="() => SelectDot(1, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question1 > 0)
                {
                    <span>Selected: <b>@newResponse.Question1</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>How would you rate the professionalism?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question2 == index ? "selected" : "")"
                            @onclick="() => SelectDot(2, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question2 > 0)
                {
                    <span>Selected: <b>@newResponse.Question2</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>To what extent did the project contribute to your company's international growth or market opportunities?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question3 == index ? "selected" : "")"
                            @onclick="() => SelectDot(3, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question3 > 0)
                {
                    <span>Selected: <b>@newResponse.Question3</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>How would you rate the value of the services, in relation to the cost?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question4 == index ? "selected" : "")"
                            @onclick="() => SelectDot(4, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question4 > 0)
                {
                    <span>Selected: <b>@newResponse.Question4</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>To what extent did the solutions provided meet your company's business needs?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question5 == index ? "selected" : "")"
                            @onclick="() => SelectDot(5, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question5 > 0)
                {
                    <span>Selected: <b>@newResponse.Question5</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>How would you rate the clarity and responsiveness of communication throughout the project?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question6 == index ? "selected" : "")"
                            @onclick="() => SelectDot(6, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question6 > 0)
                {
                    <span>Selected: <b>@newResponse.Question6</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>How satisfied are you with the timeliness and delivery of the project?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question7 == index ? "selected" : "")"
                            @onclick="() => SelectDot(7, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question7 > 0)
                {
                    <span>Selected: <b>@newResponse.Question7</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>How would you rate the expertise of the advisor?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question8 == index ? "selected" : "")"
                            @onclick="() => SelectDot(8, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question8 > 0)
                {
                    <span>Selected: <b>@newResponse.Question8</b></span>
                }
            </div>
        </div>

        <div class="question-group">
            <label>How likely are you to use our services again?</label>
            <div class="dots-row">
                @for (int i = 1; i <= 10; i++)
                {
                    int index = i;
                    <button type="button"
                            class="dot @(newResponse.Question9 == index ? "selected" : "")"
                            @onclick="() => SelectDot(9, index)"
                            title="Select @index">
                        @index
                    </button>
                }
            </div>
            <div class="chosen-value">
                @if (newResponse.Question9 > 0)
                {
                    <span>Selected: <b>@newResponse.Question9</b></span>
                }
            </div>
        </div>

        <button class="submit-btn"
                @onclick="AddSurveyResponse"
                disabled="@(!IsValid())">
            Submit feedback
        </button>

        @if (success)
        {
            <div class="success-message">
                <span>✔</span> Thank you for your feedback!
            </div>
        }
        </div>
    }
</div>
</div>

<style>
    body {
        background: #f8f9fa !important;
    }

    .survey-page {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        background: #f8f9fa;
    }

    .page-header {
        background: linear-gradient(135deg, #D9D9D9 0%, #D9D9D9 100%);
        border-radius: 16px;
        padding: 48px 40px;
        margin-bottom: 32px;
        position: relative;
        overflow: hidden;
        width: 100%;
        max-width: 1350px;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        opacity: 0.4;
    }

    .header-content {
        position: relative;
        z-index: 1;
        text-align: center;
    }

    .page-title {
        font-size: 2.8rem;
        font-weight: 600;
        color: #5c5c5c;
        margin: 0 0 12px 0;
        letter-spacing: 0.5px;
        text-shadow: 0 4px 24px rgba(0, 0, 0, 0.25);
        font-family: 'Poppins', sans-serif !important;
        line-height: 1.3;
    }

    .page-subtitle {
        font-size: 1.15rem;
        color: #5c5c5c;
        margin: 0;
        font-weight: 400;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        font-family: 'Poppins', sans-serif !important;
    }

    @@media (max-width: 768px) {
        .page-title {
            font-size: 2rem;
        }
        .page-subtitle {
            font-size: 1rem;
        }
    }

    .survey-container {
        max-width: 560px;
        width: 100%;
        margin: 0;
        background: #d9d9d9 !important;
        border-radius: 16px;
        box-shadow: 0 0 0 20px #d9d9d9 !important, 0 8px 32px rgba(0,0,0,0.12);
        padding: 32px 24px;
        position: relative;
        outline: 20px solid #d9d9d9 !important;
    }

    .survey-container h2 {
        text-align: center;
        margin-bottom: 32px;
        color: #d9d9d9;
        font-weight: 600;
        letter-spacing: 0.5px;
        font-family: 'Poppins', sans-serif !important;
    }

    .survey-form .form-group {
        margin-bottom: 28px;
        text-align: center;
    }

    .form-control {
        width: 80%;
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 1.1rem;
        margin: 8px auto 0 auto;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: border-color 0.2s;
        font-family: 'Poppins', sans-serif !important;
    }

    .form-control:focus {
        border-color: #9ca3af;
        outline: none;
    }

    .question-group {
        margin-bottom: 28px;
        text-align: center;
    }

    .question-group label {
        display: block;
        font-size: 1.1rem;
        margin-bottom: 12px;
        color: #374151;
        font-weight: 500;
        font-family: 'Poppins', sans-serif !important;
    }

    .dots-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 8px;
    }

    .dot {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        font-weight: 600;
        font-size: 1.05rem;
        cursor: pointer;
        border: 2px solid #e5e7eb;
        transition: background 0.2s, border-color 0.2s, color 0.2s, transform 0.1s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        outline: none;
        font-family: 'Poppins', sans-serif !important;
    }

    .dot:hover, .dot:focus {
        background: #10b981;
        border-color: #10b981;
        color: #ffffff;
        transform: scale(1.1);
    }

    .dot.selected {
        background: #5fa8f5;
        color: #fff;
        border-color: #5fa8f5;
        box-shadow: 0 0 0 3px rgb(95, 168, 245);
        transform: scale(1.15);
    }

    .chosen-value {
        margin-top: 8px;
        font-size: 0.95rem;
        color: #6b7280;
        font-family: 'Poppins', sans-serif !important;
    }

    .chosen-value b {
        color: #374151;
        font-family: 'Poppins', sans-serif !important;
    }

    .submit-btn {
        display: block;
        width: 100%;
        padding: 12px 0;
        background: #5fa8f5;
        color: #fff;
        font-size: 1.15rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        margin-top: 18px;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: background 0.2s, transform 0.1s;
        font-family: 'Poppins', sans-serif !important;
    }

    .submit-btn:hover {
        background: #059669;
        transform: scale(1.03);
    }

    .success-message {
        margin-top: 24px;
        text-align: center;
        color: #10b981;
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 32px 24px;
        background: #f0fdf4;
        border: 2px solid #10b981;
        border-radius: 12px;
        font-family: 'Poppins', sans-serif !important;
    }

    .success-message h3 {
        margin: 0;
        color: #10b981;
        font-size: 1.5rem;
        font-family: 'Poppins', sans-serif !important;
    }

    .success-message span {
        font-size: 2rem;
    }

    .success-message p {
        font-family: 'Poppins', sans-serif !important;
    }

    .completion-info {
        font-size: 1rem;
        color: #6b7280;
        margin-top: 8px;
        font-family: 'Poppins', sans-serif !important;
    }

    .form-control:disabled {
        background-color: #f9fafb;
        opacity: 0.7;
        cursor: not-allowed;
    }

    .form-group label {
        font-family: 'Poppins', sans-serif !important;
        color: #374151;
        font-weight: 500;
    }
</style>

@code {
    [Parameter] 
    public string SurveyId { get; set; }
    
    private SurveyResponse newResponse = new SurveyResponse();
    private bool success = false;
    private bool isExistingSurvey = false;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(SurveyId))
        {
            // Load existing survey data
            await LoadExistingSurvey();
        }
        else
        {
            // Set DateSent when survey is loaded (new survey)
            newResponse.DateSent = DateTime.Now;
        }
    }

    async Task LoadExistingSurvey()
    {
        isLoading = true;
        try
        {
            var response = await httpClient.GetAsync($"http://localhost:5123/api/survey/by-id/{SurveyId}");
            if (response.IsSuccessStatusCode)
            {
                var existingSurvey = await response.Content.ReadFromJsonAsync<SurveyResponse>();
                if (existingSurvey != null)
                {
                    newResponse = existingSurvey;
                    isExistingSurvey = true;
                    
                    // Check if already completed
                    if (newResponse.DateCompleted.HasValue)
                    {
                        success = true;
                    }
                }
            }
            else
            {
                // Survey not found
                Console.WriteLine($"Survey not found or error loading: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading survey: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    void SelectDot(int question, int value)
    {
        switch (question)
        {
            case 1: newResponse.Question1 = value; break;
            case 2: newResponse.Question2 = value; break;
            case 3: newResponse.Question3 = value; break;
            case 4: newResponse.Question4 = value; break;
            case 5: newResponse.Question5 = value; break;
            case 6: newResponse.Question6 = value; break;
            case 7: newResponse.Question7 = value; break;
            case 8: newResponse.Question8 = value; break;
            case 9: newResponse.Question9 = value; break;
        }
        StateHasChanged();
    }

    bool IsValid()
    {
        return !string.IsNullOrWhiteSpace(newResponse.CustomerName) &&
               !string.IsNullOrWhiteSpace(newResponse.Sector) &&
               !string.IsNullOrWhiteSpace(newResponse.ProjectName) &&
               !string.IsNullOrWhiteSpace(newResponse.ProjectDuration) &&
               newResponse.Question1 > 0 &&
               newResponse.Question2 > 0 &&
               newResponse.Question3 > 0 &&
               newResponse.Question4 > 0 &&
               newResponse.Question5 > 0 &&
               newResponse.Question6 > 0 &&
               newResponse.Question7 > 0 &&
               newResponse.Question8 > 0 &&
               newResponse.Question9 > 0;
    }

    async Task AddSurveyResponse()
    {
        if (!IsValid()) return;

        newResponse.DateCompleted = DateTime.Now;
        newResponse.SubmittedAt = DateTime.Now;
        
        HttpResponseMessage response;
        
        if (isExistingSurvey)
        {
            // Update existing survey
            response = await httpClient.PutAsJsonAsync($"http://localhost:5123/api/survey/{newResponse.SurveyResponseId}", newResponse);
        }
        else
        {
            // Create new survey
            response = await httpClient.PostAsJsonAsync("http://localhost:5123/api/survey", newResponse);
        }
        
        if (response.IsSuccessStatusCode)
        {
            success = true;
            StateHasChanged();
            
            if (!isExistingSurvey)
            {
                _ = Task.Run(async () => 
                {
                    await Task.Delay(3000);
                    success = false;
                    newResponse = new SurveyResponse();
                    await InvokeAsync(StateHasChanged);
                });
            }
        }
    }
}